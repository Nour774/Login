<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>المكتبة</title>
  <link rel="icon" href="images/book.png"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* --- نسقك الأصلي محافظ عليه --- */
    * { box-sizing: border-box; transition: 0.3s ease; }
    body { margin: 0; font-family: "Cairo", "Tahoma", sans-serif; background: #1a1a1d; color: #f5f5f5; overflow-x: hidden; }
    header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #0f0e14; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-btn { cursor: pointer; font-size: 24px; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; }
    .sub-header { display: flex; gap: 16px; padding: 10px 20px; background: #2a2a2d; }
    .sub-header a { color: #f5f5f5; text-decoration: none; font-weight: bold; cursor: pointer; }
    .hero img { width: 100%; max-height: 300px; object-fit: cover; }
    .content { padding: 20px; }
    .sidebar { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background: #333; padding: 20px; transition: right 0.3s ease; z-index: 1000; }
    .sidebar.active { right: 0; }
    .sidebar a, .sidebar button { display: block; margin-bottom: 10px; color: #fff; background: none; border: none; font-size: 16px; cursor: pointer; text-align: right; }
    .overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
    .overlay.active { display: block; }
    .section { display: none; padding: 20px; }
    .section.active { display: block; }
    .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .logo div:first-child { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #a88bff, #e6c07b); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #0b0710; font-size: 18px; }
    .logo .title { font-weight: 700; font-size: 18px; }
    nav { display: flex; gap: 16px; margin-bottom: 10px; }
    nav button { padding: 6px 12px; border: none; border-radius: 8px; background: transparent; color: #9b8fb3; cursor: pointer; font-weight: 700; }
    nav button.active { color: #fff; background: rgba(168,139,255,0.12); }
    .panel { display: none; }
    .panel.active { display: block; }
    .hint { margin-top: 12px; color: #9b8fb3; }
    /* شبكة البطاقات مثل تاشيومي ولكن حسب ستايلك */
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 14px; margin-top: 18px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
    /* تصميم بطاقة شبيه بتاشيومي */
    .ext-card { display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
    .ext-thumb { width:72px; height:100px; border-radius:8px; object-fit:cover; flex-shrink:0; background:#111; border:1px solid rgba(255,255,255,0.03) }
    .ext-body { flex:1; display:flex; flex-direction:column; gap:6px }
    .ext-title { font-weight:800; font-size:15px }
    .ext-meta { color:#9b8fb3; font-size:13px }
    .btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#7b5cff; color:#fff; font-weight:700 }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.05); color:#fff }
    .small { font-size:13px; color:#9b8fb3 }
    .muted { color:#9b8fb3 }
    .repo-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .repo-tab { padding:6px 10px; border-radius:8px; cursor:pointer; background:transparent; color:#9b8fb3; font-weight:700 }
    .repo-tab.active { background:rgba(168,139,255,0.08); color:#fff }
    @media (max-width:700px){ .ext-thumb{width:60px;height:84px} .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
  </style>
</head>
<body>
  <header>
    <span class="menu-btn" onclick="toggleMenu()">☰</span>
    <h1>المكتبة</h1>
    <img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="بروفايل">
  </header>

  <div class="sub-header">
    <a href="index5.html">الرئيسية</a>
    <a onclick="showSection('library')">مكتبتي</a>
    <a onclick="showSection('repository')">المانجا/المانهوا</a>
    <a onclick="showSection('settings')">الروايات</a>
  </div>

  <div class="hero"><img src="images/imag1.jpg" alt="صورة المقدمة"></div>

  <!-- الأقسام -->
  <div id="library" class="section active">
    <div class="content">
      <div id="welcome" class="welcome">جار التحميل...</div>
    </div>
  </div>

  <!-- ======= قسم المانجا/المانهوا (المُحدّث بالكامل) ======= -->
  <div id="repository" class="section">
    <div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div>

    <!-- تبويبات المستودعات -->
    <div class="repo-tabs" id="repoTabs"></div>

    <nav>
      <button id="tabSources" class="active" onclick="switchPanel('sources')">المصادر</button>
      <button id="tabExtensions" onclick="switchPanel('extensions')">الإضافات</button>
    </nav>

    <div id="panelSources" class="panel active">
      <div class="hint">المصادر المستوردة ستظهر هنا. اضغط على "استيراد كمصدر" من أي إضافة في تبويب المستودع.</div>
      <div id="sourcesGrid" class="grid" aria-live="polite"></div>
    </div>

    <div id="panelExtensions" class="panel" style="display:none">
      <div class="hint">اختر تبويب مستودع أعلى لتحميل الإضافات. إذا ظهر تحذير CORS، استخدم خادم محلي أو الصق JSON يدوياً.</div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="repoUrlInput" class="input" placeholder="لصق رابط JSON لمستودع (raw GitHub)"/>
        <button class="btn" onclick="addRepoFromInput()">أضف مستودع</button>
        <button class="btn" onclick="loadPrepopulated()">تحميل المستودعات المضمّنة</button>
      </div>

      <div style="margin-top:10px">
        <textarea id="repoPaste" rows="5" style="width:100%;border-radius:8px;padding:8px;background:#0f0f12;color:#fff" placeholder='أو ألصق JSON هنا (مصفوفة أو كائن repository).'></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" onclick="importFromPaste()">استيراد من النص</button>
          <button class="btn btn-ghost" onclick="clearRepos()">مسح المستودعات</button>
        </div>
      </div>

      <div id="extensionsContainer" style="margin-top:14px">
        <div id="extensionsGrid" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="settings" class="section">
    <p>الروايات ستظهر هنا لاحقًا.</p>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="#" onclick="goToMembers()">الأعضاء</a>
    <button id="adminBtn" onclick="goToAdmin()" style="display:none;">لوحة التحكم</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <script>
    /****************** إعداد Supabase (تصحيح الاستخدام) ******************/
    const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";

    // بعض الحمايات لعدم افتراض اسم النافذة العالمية
    const supabaseClient = (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function')
      ? window.supabase.createClient(supabaseUrl, supabaseKey)
      : (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function')
        ? supabase.createClient(supabaseUrl, supabaseKey)
        : null;

    async function loadUser() {
      try {
        if(!supabaseClient) throw new Error('Supabase SDK غير متاح');
        const { data, error } = await supabaseClient.auth.getUser();
        if (error || !data.user) return window.location.href = "index.html";
        const { data: profile } = await supabaseClient.from("profiles").select("username, role, avatar_url").eq("id", data.user.id).single();
        document.getElementById("welcome").textContent = `مرحباً بك، ${profile?.username || "مستخدم"} 👋`;
        if (profile?.avatar_url) document.getElementById("profileImage").src = profile.avatar_url;
        if ([(profile?.role||"")].some(r => String(r).toLowerCase() === 'admin' || String(r).toLowerCase() === 'owner')) {
          document.getElementById("adminBtn").style.display = "block";
        }
      } catch(e) {
        // لو Supabase فشل لأي سبب، نسمح للمستخدم بالمتابعة محلياً
        console.warn(e);
        document.getElementById("welcome").textContent = `مرحباً بك، زائر — (Supabase غير متاح حالياً).`;
      }
    }
    loadUser();

    /****************** وظائف واجهة عامة ******************/
    function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); document.getElementById("overlay").classList.toggle("active"); }
    function logout() {
      if(supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.signOut === 'function'){
        supabaseClient.auth.signOut().then(()=> location.href='index.html').catch(()=> location.href='index.html');
      } else {
        location.href = 'index.html';
      }
    }
    function goToMembers(){ location.href='index3.html' }
    function goToAdmin(){ location.href='index5.html' }
    function showSection(id){ document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='repository') { switchPanel('extensions'); } }

    /****************** حالة التطبيق (state) ******************/
    const state = { repos: [], currentRepoIndex: null, sources: [] };

    const PREPOPULATED_REPOS = [
      { name: "Keiyoushi", url: "https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json" },
      { name: "ThePBone (revived)", url: "https://raw.githubusercontent.com/ThePBone/tachiyomi-extensions-revived/repo/index.min.json" },
      { name: "Mihon (chaerun)", url: "https://raw.githubusercontent.com/chaerun/mihon-extensions/repo/index.min.json" },
      { name: "Kaciin (examples)", url: "https://raw.githubusercontent.com/kaciin/tachiyomi-extensions-source/repo/index.min.json" }
    ];

    /****************** رندر تبويبات المستودعات ******************/
    function renderRepoTabs(){
      const tabs = document.getElementById('repoTabs'); tabs.innerHTML = '';
      state.repos.forEach((r, idx)=>{
        const el = document.createElement('button'); el.className = 'repo-tab' + (state.currentRepoIndex===idx ? ' active' : ''); el.textContent = r.name || `repo ${idx+1}`; el.onclick = ()=> { selectRepo(idx); };
        tabs.appendChild(el);
      });
      if(state.repos.length===0){ const hint = document.createElement('div'); hint.className='small muted'; hint.style.marginTop='8px'; hint.textContent = 'لم يتم إضافة مستودعات. اضغط "تحميل المستودعات المضمّنة" أو ألصق رابط JSON.'; tabs.appendChild(hint); }
    }

    function selectRepo(idx){ state.currentRepoIndex = idx; renderRepoTabs(); if(!state.repos[idx].loaded) fetchRepo(idx); else renderExtensionsGrid(state.repos[idx].items || []); }


    /****************** جلب وتحليل مستودع مرن مع دعم APK ******************/
    async function fetchRepo(idx){
      const repo = state.repos[idx];
      if(!repo) return;
      setDetails(`جاري جلب: ${repo.url}`);
      try {
        const res = await fetch(repo.url);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        let items = [];

        if(Array.isArray(json)){
          json.forEach(it => { items.push(normalizeExtension(it)); });
        } else if(json.repositories && Array.isArray(json.repositories)) {
          json.repositories.forEach(it => items.push(normalizeExtension(it)));
        } else if(json.extensions && Array.isArray(json.extensions)) {
          json.extensions.forEach(it => items.push(normalizeExtension(it)));
        } else if(json.sources && Array.isArray(json.sources)) {
          json.sources.forEach(it => items.push(normalizeExtension(it)));
        } else {
          let found = false;
          Object.keys(json).forEach(k => {
            if(Array.isArray(json[k])){
              json[k].forEach(it => { items.push(normalizeExtension(it)); found = true; });
            }
          });
          if(!found) { items.push({ title: repo.name || repo.url, raw: json }); }
        }

        repo.items = items;
        repo.loaded = true;
        renderRepoTabs();
        if(state.currentRepoIndex === idx) renderExtensionsGrid(items);
        setDetails(`تم تحميل المستودع: ${repo.name} — ${items.length} عناصر.`);
      } catch(err) {
        console.error(err);
        repo.loaded = false;
        setDetails(`فشل تحميل repo: ${repo.url} — ${err.message}. إذا ظهر "CORS" استخدم خادم محلي أو الصق JSON يدوياً.`);
        alert(`فشل جلب المستودع (${repo.name}): ${err.message}\nمشكلة شائعة: CORS. شغّل الصفحة عبر سيرفر محلي أو الصق JSON.`);
      }
    }

    /****************** تطبيع العناصر لدعم البنية المرنة + APK ******************/
    function normalizeExtension(it){
      const title = it.title || it.name || it.id || it.pkg || it.apk || 'إضافة';
      const lang = it.lang || it.language || it.languages || (it.availableLanguages ? (Array.isArray(it.availableLanguages)?it.availableLanguages.join(',') : it.availableLanguages) : '');
      const description = it.description || it.desc || it.summary || '';
      const icon = it.icon || it.logo || it.image || it.cover || it.thumbnail || null;
      const url = it.url || it.repo || it.index || it.apk || it.pkg || it.link || null;
      const apk = it.apk || it.pkg || null;
      return { title, lang, description, icon, url, apk, raw: it };
    }

    function renderExtensionsGrid(items){
      const grid = document.getElementById('extensionsGrid'); grid.innerHTML = '';
      items.forEach(it=>{
        const card = document.createElement('div'); card.className='card ext-card';
        const thumb = document.createElement('img'); thumb.className='ext-thumb'; thumb.src=it.icon||'images/book.png';
        const body = document.createElement('div'); body.className='ext-body';
        const title = document.createElement('div'); title.className='ext-title'; title.textContent=it.title;
        const meta = document.createElement('div'); meta.className='ext-meta'; meta.textContent=it.lang || '';
        const desc = document.createElement('div'); desc.className='small'; desc.textContent=it.description || '';
        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='استيراد كمصدر'; btn.onclick=()=>{ if(it.apk) window.open(it.apk,'_blank'); else alert('رابط غير متوفر'); };
        body.appendChild(title); body.appendChild(meta); body.appendChild(desc); body.appendChild(btn);
        card.appendChild(thumb); card.appendChild(body); grid.appendChild(card);
      });
    }

    /****************** أدوات مستودع ******************/
    function switchPanel(name){
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.getElementById('panel'+capitalize(name)).classList.add('active');
      document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active')); document.getElementById('tab'+capitalize(name)).classList.add('active');
    }

    function capitalize(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

    function addRepoFromInput(){ const val = document.getElementById('repoUrlInput').value.trim(); if(!val) return alert('أدخل رابط JSON'); state.repos.push({ name:'مستودع جديد', url:val }); selectRepo(state.repos.length-1); renderRepoTabs(); }

    function loadPrepopulated(){ PREPOPULATED_REPOS.forEach(r=>state.repos.push({...r, loaded:false, items:[] })); selectRepo(0); renderRepoTabs(); }

    function importFromPaste(){ try{ const json = JSON.parse(document.getElementById('repoPaste').value); if(Array.isArray(json)){ json.forEach(r=>state.repos.push({...r, loaded:false, items:[]})); } else state.repos.push({...json, loaded:false, items:[]}); selectRepo(state.repos.length-1); renderRepoTabs(); }catch(e){ alert('JSON غير صالح'); } }

    function clearRepos(){ state.repos=[]; state.currentRepoIndex=null; renderRepoTabs(); document.getElementById('extensionsGrid').innerHTML=''; }

    function setDetails(text){ document.getElementById('welcome').textContent = text; }
  </script>
</body>
</html>
