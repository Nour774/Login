<!DOCTYPE html>
<html lang="ar" dir="rtl"><head><meta charset="UTF-8" /><title>Ø§Ù„Ù…ÙƒØªØ¨Ø©</title><link rel="icon" href="images/book.png"/><meta name="viewport" content="width=device-width, initial-scale=1" /><script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script><style>/* --- Ù†Ø³Ù‚Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡ --- */* { box-sizing: border-box; transition: 0.3s ease; }body { margin: 0; font-family: "Cairo", "Tahoma", sans-serif; background: #1a1a1d; color: #f5f5f5; overflow-x: hidden; }header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #0f0e14; border-bottom: 1px solid rgba(255,255,255,0.05); }.menu-btn { cursor: pointer; font-size: 24px; }.profile-pic { width: 40px; height: 40px; border-radius: 50%; }.sub-header { display: flex; gap: 16px; padding: 10px 20px; background: #2a2a2d; }.sub-header a { color: #f5f5f5; text-decoration: none; font-weight: bold; cursor: pointer; }.hero img { width: 100%; max-height: 300px; object-fit: cover; }.content { padding: 20px; }.sidebar { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background: #333; padding: 20px; transition: right 0.3s ease; z-index: 1000; }.sidebar.active { right: 0; }.sidebar a, .sidebar button { display: block; margin-bottom: 10px; color: #fff; background: none; border: none; font-size: 16px; cursor: pointer; text-align: right; }.overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }.overlay.active { display: block; }.section { display: none; padding: 20px; }.section.active { display: block; }.logo { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }.logo div:first-child { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #a88bff, #e6c07b); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #0b0710; font-size: 18px; }.logo .title { font-weight: 700; font-size: 18px; }nav { display: flex; gap: 16px; margin-bottom: 10px; }nav button { padding: 6px 12px; border: none; border-radius: 8px; background: transparent; color: #9b8fb3; cursor: pointer; font-weight: 700; }nav button.active { color: #fff; background: rgba(168,139,255,0.12); }.panel { display: none; }.panel.active { display: block; }.hint { margin-top: 12px; color: #9b8fb3; }/* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø«Ù„ ØªØ§Ø´ÙŠÙˆÙ…ÙŠ ÙˆÙ„ÙƒÙ† Ø­Ø³Ø¨ Ø³ØªØ§ÙŠÙ„Ùƒ */.grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 14px; margin-top: 18px; }.card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; gap: 8px; align-items: stretch; }/* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø´Ø¨ÙŠÙ‡ Ø¨ØªØ§Ø´ÙŠÙˆÙ…ÙŠ */.ext-card { display:flex; gap:10px; align-items:flex-start; cursor:pointer; }.ext-thumb { width:72px; height:100px; border-radius:8px; object-fit:cover; flex-shrink:0; background:#111; border:1px solid rgba(255,255,255,0.03) }.ext-body { flex:1; display:flex; flex-direction:column; gap:6px }.ext-title { font-weight:800; font-size:15px }.ext-meta { color:#9b8fb3; font-size:13px }.btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#7b5cff; color:#fff; font-weight:700 }.btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.05); color:#fff }.small { font-size:13px; color:#9b8fb3 }.muted { color:#9b8fb3 }.repo-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }.repo-tab { padding:6px 10px; border-radius:8px; cursor:pointer; background:transparent; color:#9b8fb3; font-weight:700 }.repo-tab.active { background:rgba(168,139,255,0.08); color:#fff }@media (max-width:700px){ .ext-thumb{width:60px;height:84px} .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
</style></head><body><header><span class="menu-btn" onclick="toggleMenu()">â˜°</span><h1>Ø§Ù„Ù…ÙƒØªØ¨Ø©</h1><img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="Ø¨Ø±ÙˆÙØ§ÙŠÙ„"></header>
<div class="sub-header"><a href="index5.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a><a onclick="showSection('library')">Ù…ÙƒØªØ¨ÙŠ</a><a onclick="showSection('repository')">Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§</a><a onclick="showSection('settings')">Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª</a></div>
<div class="hero"><img src="images/imag1.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©"></div>
<!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
<div id="library" class="section active"><div class="content"><div id="welcome" class="welcome">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div></div>
<!-- ======= Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ (Ø§Ù„Ù…ÙØ­Ø¯Ù‘Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†ÙŠØ© repo Ø§Ù„ØªÙŠ ÙˆØµÙØªÙ‡Ø§) ======= -->
<div id="repository" class="section"><div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div>
<!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª -->
<div class="repo-tabs" id="repoTabs"></div>

<nav>
  <button id="tabSources" class="active" onclick="switchPanel('sources')">Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
  <button id="tabExtensions" onclick="switchPanel('extensions')">Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</button>
</nav>

<div id="panelSources" class="panel active">
  <div class="hint">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø³ØªÙŠØ±Ø§Ø¯" Ù…Ù† Ø£ÙŠ Ù…ØµØ¯Ø± ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª.</div>
  <div id="sourcesGrid" class="grid" aria-live="polite"></div>
</div>

<div id="panelExtensions" class="panel" style="display:none">
  <div class="hint">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: Ù…ØµÙÙˆÙØ© Ø¥Ø¶Ø§ÙØ§Øª ÙƒÙ…Ø§ ÙˆØµÙØª (name,pkg,apk,lang,code,version,nsfw,sources[...] ).</div>

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
    <input id="repoUrlInput" class="input" placeholder="Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· JSON Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (raw GitHub)"/>
    <button class="btn" onclick="addRepoFromInput()">Ø£Ø¶Ù Ù…Ø³ØªÙˆØ¯Ø¹</button>
    <button class="btn" onclick="loadPrepopulated()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©</button>
  </div>

  <div style="margin-top:10px">
    <textarea id="repoPaste" rows="5" style="width:100%;border-radius:8px;padding:8px;background:#0f0f12;color:#fff" placeholder='Ø£Ùˆ Ø£Ù„ØµÙ‚ JSON Ù‡Ù†Ø§ (Ù…ØµÙÙˆÙØ© Ø£Ùˆ ÙƒØ§Ø¦Ù† repository).'></textarea>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn" onclick="importFromPaste()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„Ù†Øµ</button>
      <button class="btn btn-ghost" onclick="clearRepos()">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</button>
    </div>
  </div>

  <div id="extensionsContainer" style="margin-top:14px">
    <div id="extensionsGrid" class="grid"></div>
  </div>
</div>

</div>
<div id="settings" class="section"><p>Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p></div>
<div class="sidebar" id="sidebar"><a href="#" onclick="goToMembers()">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a><button id="adminBtn" onclick="goToAdmin()" style="display:none;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button><button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div><div class="overlay" id="overlay" onclick="toggleMenu()"></div>
<script>
/****************** Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…) ******************/
const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
const supabaseKey = "REDACTED_FOR_SAFETY"; // kept placeholder: Ø¶Ø¹ Ù…ÙØªØ§Ø­Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¥Ù† Ø£Ø±Ø¯Øª
const supabaseClient = (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function')? window.supabase.createClient(supabaseUrl, supabaseKey): (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function')? supabase.createClient(supabaseUrl, supabaseKey): null;
async function loadUser() {
  try {
    if(!supabaseClient) throw new Error('Supabase SDK ØºÙŠØ± Ù…ØªØ§Ø­');
    const { data, error } = await supabaseClient.auth.getUser();
    if (error || !data.user) return window.location.href = "index.html";
    const { data: profile } = await supabaseClient.from("profiles").select("username, role, avatar_url").eq("id", data.user.id).single();
    document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${profile?.username || "Ù…Ø³ØªØ®Ø¯Ù…"} ğŸ‘‹`;
    if (profile?.avatar_url) document.getElementById("profileImage").src = profile.avatar_url;
    if ([(profile?.role||"")].some(r => String(r).toLowerCase() === 'admin' || String(r).toLowerCase() === 'owner')) {document.getElementById("adminBtn").style.display = "block";}
  } catch(e) {
    console.warn(e);
    document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ Ø²Ø§Ø¦Ø± â€” (Supabase ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹).`;
  }
}
loadUser();

/****************** ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø© ******************/
function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); document.getElementById("overlay").classList.toggle("active"); }
function logout() { if(supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.signOut === 'function'){ supabaseClient.auth.signOut().then(()=> location.href='index.html').catch(()=> location.href='index.html'); } else { location.href = 'index.html'; } }
function goToMembers(){ location.href='index3.html' }
function goToAdmin(){ location.href='index5.html' }
function showSection(id){ document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='repository') { switchPanel('extensions'); } }

/****************** Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (state) ******************/
const state = { repos: [], currentRepoIndex: null, sources: [] };
const PREPOPULATED_REPOS = [{ name: "Keiyoushi", url: "https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json" },{ name: "ThePBone (revived)", url: "https://raw.githubusercontent.com/ThePBone/tachiyomi-extensions-revived/repo/index.min.json" },{ name: "Mihon (chaerun)", url: "https://raw.githubusercontent.com/chaerun/mihon-extensions/repo/index.min.json" },{ name: "Kaciin (examples)", url: "https://raw.githubusercontent.com/kaciin/tachiyomi-extensions-source/repo/index.min.json" }];

/****************** Ø±Ù†Ø¯Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ******************/
function renderRepoTabs(){const tabs = document.getElementById('repoTabs'); tabs.innerHTML = '';state.repos.forEach((r, idx)=>{const el = document.createElement('button'); el.className = 'repo-tab' + (state.currentRepoIndex===idx ? ' active' : ''); el.textContent = r.name || `repo ${idx+1}`; el.onclick = ()=> { selectRepo(idx); };tabs.appendChild(el);});if(state.repos.length===0){ const hint = document.createElement('div'); hint.className='small muted'; hint.style.marginTop='8px'; hint.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. Ø§Ø¶ØºØ· "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©" Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· JSON.'; tabs.appendChild(hint); }}
function selectRepo(idx){ state.currentRepoIndex = idx; renderRepoTabs(); if(!state.repos[idx].loaded) fetchRepo(idx); else renderExtensionsGrid(state.repos[idx].items || []); }

/****************** Ø¬Ù„Ø¨ ÙˆØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙˆØ¯Ø¹ (Ù…ÙˆØ§ÙƒØ¨Ø© Ù„Ø¨Ù†ÙŠØ© JSON Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©) ******************/
async function fetchRepo(idx){const repo = state.repos[idx]; if(!repo) return; setDetails(`Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨: ${repo.url}`);try {const res = await fetch(repo.url);if(!res.ok) throw new Error('HTTP ' + res.status);const json = await res.json();let extensions = [];

// 1) Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª ÙˆÙÙ‚ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªÙŠ ÙˆØµÙØªÙ‡Ø§
if(Array.isArray(json)){
  json.forEach(it => { if(it && (it.name || it.pkg || it.apk)) extensions.push(normalizeExtensionFromRepoFormat(it)); else extensions.push(normalizeExtension(it)); });
}
// 2) Ø¯Ø¹Ù… Ø¨Ø¹Ø¶ ØµÙŠØº Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ (index.repositories, extensions, sources...)
else if(json.repositories && Array.isArray(json.repositories)) { json.repositories.forEach(it=> extensions.push(normalizeExtensionFromRepoFormat(it))); }
else if(json.extensions && Array.isArray(json.extensions)) { json.extensions.forEach(it=> extensions.push(normalizeExtensionFromRepoFormat(it))); }
else if(json.sources && Array.isArray(json.sources)) { json.sources.forEach(it=> extensions.push(normalizeExtensionFromRepoFormat(it))); }
else {
  // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙŠ Ù…ØµÙÙˆÙØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø¦Ù†
  const maybe = [];
  Object.keys(json).forEach(k=>{ if(Array.isArray(json[k])) { json[k].forEach(it => { if(it && (it.name || it.pkg || it.apk)) maybe.push(it); }); } });
  if(maybe.length>0){ maybe.forEach(it=>extensions.push(normalizeExtensionFromRepoFormat(it))); }
  else { extensions.push({ title: repo.name || repo.url, raw: json }); }
}

repo.items = extensions; repo.loaded = true; renderRepoTabs(); if(state.currentRepoIndex === idx) renderExtensionsGrid(extensions); setDetails(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${repo.name} â€” ${extensions.length} Ø¹Ù†Ø§ØµØ±.`);
} catch(err){ console.error(err); repo.loaded = false; setDetails(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ repo: ${repo.url} â€” ${err.message}. Ø¥Ø°Ø§ Ø¸Ù‡Ø± "CORS" Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.`); alert(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (${repo.name}): ${err.message}\nÙ…Ø´ÙƒÙ„Ø© Ø´Ø§Ø¦Ø¹Ø©: CORS. Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON.`);}}

/****************** ØªÙˆØ­ÙŠØ¯ Ø¨Ù†ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ù„Ø¨Ù†ÙŠØ© repo Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©) ******************/
function normalizeExtensionFromRepoFormat(it){
  // Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©: { name, pkg, apk, lang, code, version, nsfw, sources: [{name,lang,id,baseUrl}, ...] }
  const title = it.name || it.title || it.pkg || 'Ø¥Ø¶Ø§ÙØ©';
  const pkg = it.pkg || '';
  const apk = it.apk || '';
  const lang = it.lang || '';
  const code = it.code || null;
  const version = it.version || '';
  const nsfw = Number(it.nsfw || 0);
  const sources = Array.isArray(it.sources) ? it.sources.map(s => ({ name: s.name||s.title||'Ù…ØµØ¯Ø±', lang: s.lang||'', id: s.id||'', baseUrl: s.baseUrl||s.url||'' })) : [];
  const icon = it.icon || it.logo || null;
  const description = it.description || it.summary || '';
  return { title, pkg, apk, lang, code, version, nsfw, sources, icon, description, raw: it };
}

// ØªØ­ÙˆÙ‘Ù„ Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø¨Ù†Ù‰ Ù‚Ø¯ÙŠÙ…Ø©
function normalizeExtension(it){
  const title = it.title || it.name || it.pkg || 'Ø¥Ø¶Ø§ÙØ©';
  const icon = it.icon || it.logo || it.image || null;
  const description = it.description || it.desc || '';
  return { title, icon, description, raw: it };
}

/****************** Ø±Ù†Ø¯Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª (Ø¨Ø·Ø§Ù‚Ø§Øª Ø´Ø¨ÙŠÙ‡Ø© Ø¨ØªØ§Ø´ÙŠÙˆÙ…ÙŠ) ******************/
function renderExtensionsGrid(items){const grid = document.getElementById('extensionsGrid'); grid.innerHTML = '';if(!items || items.length===0){ grid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ùˆ Ø§Ù„Ø¨Ù†ÙŠØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©.</div>'; return; }

items.forEach((ex, i) => {
  const card = document.createElement('div'); card.className = 'card';
  const thumbUrl = ex.icon || placeholderThumb(ex.title);
  // nsfw badge
  const nsfwBadge = ex.nsfw ? `<span style="background:#c94a4a;padding:4px 8px;border-radius:8px;font-weight:700;margin-left:8px">NSFW</span>` : '';
  // sources summary
  const srcCount = (ex.sources && ex.sources.length) ? `${ex.sources.length} Ù…ØµØ§Ø¯Ø±` : 'Ù„Ø§ Ù…ØµØ§Ø¯Ø±';

  card.innerHTML = `
    <div class="ext-card">
      <img class="ext-thumb" src="${escapeHtml(thumbUrl)}" onerror="this.src='${placeholderThumb(ex.title)}'"/>
      <div class="ext-body">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="ext-title">${escapeHtml(ex.title)}</div>
            <div class="ext-meta">${escapeHtml(ex.lang || '')} ${ex.version? ' Â· v'+escapeHtml(ex.version): ''} ${ex.pkg? ' Â· '+escapeHtml(ex.pkg): ''}</div>
          </div>
          <div style="text-align:left">
            <button class="btn" onclick="toggleSourcesList(this, ${state.currentRepoIndex}, ${i})">Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
          </div>
        </div>
        <div class="small muted" style="margin-top:6px">${escapeHtml(shorten(ex.description || (ex.raw && ex.raw.summary) || 'Ù„Ø§ ÙˆØµÙ Ù…ØªØ§Ø­'))}</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="small muted">${escapeHtml(srcCount)}</div>
          <div style="display:flex;gap:8px;align-items:center">${nsfwBadge}<button class="btn" onclick="downloadApk(${state.currentRepoIndex}, ${i})">ØªØ­Ù…ÙŠÙ„ APK</button></div>
        </div>
        <div class="sources-list" style="margin-top:10px;display:none"></div>
      </div>
    </div>
  `;
  grid.appendChild(card);
});}

/****************** Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ù„ÙƒÙ„ Ø¥Ø¶Ø§ÙØ© ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„ÙƒÙ„ Ù…ØµØ¯Ø± */
function toggleSourcesList(btn, repoIdx, extIdx){ const card = btn.closest('.card'); const listEl = card.querySelector('.sources-list'); if(!listEl) return; if(listEl.style.display==='block'){ listEl.style.display='none'; btn.textContent='Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø±'; return; } // build list
  listEl.innerHTML = '';
  const ex = state.repos[repoIdx].items[extIdx]; if(!ex) return; if(!ex.sources || ex.sources.length===0){ listEl.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø¯Ø± Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.</div>'; listEl.style.display='block'; btn.textContent='Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ø±'; return; }
  ex.sources.forEach((s, idx)=>{ const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginBottom='8px'; div.innerHTML = `<div><div style="font-weight:800">${escapeHtml(s.name)}</div><div class="small muted">${escapeHtml(s.lang || '')} Â· ${escapeHtml(s.baseUrl || s.id || '')}</div></div><div style="display:flex;gap:8px"><button class="btn" onclick="importSourceFromExtension(${repoIdx}, ${extIdx}, ${idx})">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button><a class="btn btn-ghost" href="${escapeHtml(s.baseUrl||'#')}" target="_blank">ÙØªØ­</a></div>`; listEl.appendChild(div); }); listEl.style.display='block'; btn.textContent='Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ØµØ§Ø¯Ø±'; }

function importSourceFromExtension(repoIdx, extIdx, sourceIdx){ const ex = state.repos[repoIdx].items[extIdx]; if(!ex) return; const s = ex.sources && ex.sources[sourceIdx]; if(!s) return alert('Ø§Ù„Ù…ØµØ¯Ø± ØºÙŠØ± Ù…ØªØ§Ø­'); const sourceObj = { name: s.name || (ex.title+' Ù…ØµØ¯Ø±'), url: s.baseUrl || s.url || '', meta: { pkg: ex.pkg, apk: ex.apk, parent: ex.title } };
  if(state.sources.some(x=>x.url && x.url===sourceObj.url)) { alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.'); return; }
  state.sources.push(sourceObj); renderSourcesGrid(); switchPanel('sources'); setDetails(`Ø§Ø³ØªÙˆØ±Ø¯Øª: ${sourceObj.name}`);
}

/****************** ØªÙ†Ø²ÙŠÙ„ APK (Ø²Ø± ØªØ­Ù…ÙŠÙ„) â€” ÙÙ‚Ø· ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ùˆ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ */
function downloadApk(repoIdx, extIdx){ const ex = state.repos[repoIdx].items[extIdx]; if(!ex) return; const apk = ex.apk || (ex.raw && ex.raw.apk) || ''; if(!apk){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù APK Ù…Ø¹Ø±Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.'); return; } // Ø¥Ø°Ø§ ÙƒØ§Ù† APK Ø±Ø§Ø¨Ø·Ø§Ù‹ Ù†Ø³Ø¨ÙŠØ§Ù‹ Ø£Ùˆ Ù…Ø¬Ø±Ø¯ Ø§Ø³Ù… Ù…Ù„ÙØŒ Ø­Ø§ÙˆÙ„ ØªÙƒÙˆÙŠÙ† Ø±Ø§Ø¨Ø·
  let url = apk;
  if(!/^https?:\/\//.test(url)){
    // Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ÙƒÙ‚Ø§Ø¹Ø¯Ø©
    const base = state.repos[repoIdx].url || '';
    // Ø¥Ø°Ø§ ÙƒØ§Ù† base raw.githubusercontentØŒ Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø± Ø­ØªÙ‰ Ø¢Ø®Ø± slash
    try{ const u = new URL(base); const basePath = u.href.replace(/\/[^\/]*$/, '/'); url = basePath + encodeURIComponent(apk); }catch(e){}
  }
  window.open(url, '_blank');
}

/****************** Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ€ Ù…ØµØ¯Ø± (Ù…Ù† Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¨Ø³Ø·Ø©) ******************/
function importAsSource(repoIdx, extIdx){ const repo = state.repos[repoIdx]; if(!repo || !repo.items || !repo.items[extIdx]) return; const ex = repo.items[extIdx]; // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙ‡Ø§ Ù…ØµØ§Ø¯Ø±ØŒ Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙƒØ§ÙØªØ±Ø§Ø¶
  const s = (ex.sources && ex.sources[0]) || null; const sourceObj = { name: ex.title || ex.raw?.name || 'Ù…ØµØ¯Ø±', url: s? (s.baseUrl||'') : (ex.apk||ex.raw?.apk||guessUrlFromRaw(ex.raw)||repo.url), raw: ex.raw || null };
  if(state.sources.some(x=>x.url && x.url===sourceObj.url)) { alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.'); return; }
  state.sources.push(sourceObj); renderSourcesGrid(); switchPanel('sources'); setDetails(`Ø§Ø³ØªÙˆØ±Ø¯Øª: ${sourceObj.name}`);
}

/****************** Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ******************/
function renderSourcesGrid(){const grid = document.getElementById('sourcesGrid'); grid.innerHTML = '';if(state.sources.length===0){ grid.innerHTML = '<div class="muted">Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…ØµØ¯Ø± Ø¨Ø¹Ø¯.</div>'; return; }state.sources.forEach((s, idx) => {const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(s.name)}</div><div class="small muted" style="margin-top:6px">${escapeHtml(s.url)}</div></div><div style="display:flex;gap:8px"><button class="btn" onclick="openSource(${idx})">Ø§ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±</button><button class="btn" style="background:#c94a4a" onclick="removeSource(${idx})">Ø­Ø°Ù</button></div></div>`;grid.appendChild(d);});}

async function openSource(idx){const s = state.sources[idx]; if(!s) return; setDetails(`ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±: ${s.name}`); if(s.raw && Array.isArray(s.raw.manga)){ showMangaList(s.raw.manga, s); return; } try{ if(!s.url){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…ØªØ§Ø­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±.'); return; } const res = await fetch(s.url); if(!res.ok) throw new Error('HTTP '+res.status); const json = await res.json(); if(Array.isArray(json)) { showMangaList(json, s); return; } if(json.manga && Array.isArray(json.manga)) { showMangaList(json.manga, s); return; } alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø§Ù†Ø¬Ø§ Ø¨Ù…Ø¹ÙŠØ§Ø±ÙŠØ© Ù…ÙÙ‡ÙˆÙ…Ø©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¨Ù†ÙŠØ© Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.'); }catch(e){ console.error(e); alert('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø± â€” Ø±Ø¨Ù…Ø§ CORS Ø£Ùˆ Ø¨Ù†ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©. Ø¬Ø±Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.'); setDetails('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±: ' + e.message); }}

function showMangaList(list, source){const panel = document.getElementById('extensionsGrid'); panel.innerHTML = ''; if(!Array.isArray(list) || list.length===0){ panel.innerHTML = '<div class="muted">Ù„Ù… Ø£Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù…Ø§Ù†Ø¬Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±.</div>'; return; } list.forEach(m => {const card = document.createElement('div'); card.className='card'; const thumb = (m.image || m.thumbnail || m.cover) || placeholderThumb(m.title || m.name); const payload = escapeJson(m); card.innerHTML = `<div style="display:flex;gap:10px;align-items:flex-start"><img src="${escapeHtml(thumb)}" class="ext-thumb" onerror="this.src='${placeholderThumb(m.title||m.name)}'"/><div style="flex:1"><div style="font-weight:800">${escapeHtml(m.title||m.name||'Ù…Ø§Ù†Ø¬Ø§')}</div><div class="small muted" style="margin-top:6px">${escapeHtml(m.description||m.summary||'Ù„Ø§ ÙˆØµÙ')}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick='openManga(${JSON.stringify(payload)})'>Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„</button><a class="btn btn-ghost" href="${escapeHtml(m.url||m.link||m.page||'#')}" target="_blank">ØµÙØ­Ø© Ø§Ù„Ù…ØµØ¯Ø±</a></div></div></div>`; panel.appendChild(card); }); }

function openManga(mB64){ const m = unescapeJson(mB64); if(Array.isArray(m.chapters) && m.chapters.length>0){ showChaptersInPanel(m.chapters, m); return; } if(m.chaptersUrl){ (async ()=>{ try{ const res = await fetch(m.chaptersUrl); if(!res.ok) throw new Error('HTTP '+res.status); const json = await res.json(); if(Array.isArray(json)) showChaptersInPanel(json, m); else alert('Ø¨Ù†ÙŠØ© Ø§Ù„ÙØµÙˆÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©.'); }catch(e){ alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙØµÙˆÙ„: '+e.message + ' (Ø±Ø¨Ù…Ø§ CORS)'); console.error(e); } })(); return; } alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙØµÙˆÙ„ ÙˆØ§Ø¶Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù†.'); }

function showChaptersInPanel(chapters, manga){const panel = document.getElementById('extensionsGrid'); panel.innerHTML = ''; chapters.forEach(ch=>{ const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(ch.title||ch.name||'ÙØµÙ„')}</div><div class="small muted">${escapeHtml(ch.date||'')}</div></div><div style="display:flex;gap:8px"><a class="btn" href="${escapeHtml(ch.chapterUrl||ch.url||ch.readUrl||'#')}" target="_blank">ÙØªØ­</a>${Array.isArray(ch.images) ? `<button class="btn" onclick='openReader(${JSON.stringify(escapeJson(ch))})'>Ø§Ù‚Ø±Ø£</button>` : ''}</div></div>`; panel.appendChild(d); }); }

function openReader(chB64){ const ch = unescapeJson(chB64); const w = window.open('','_blank'); let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${escapeHtml(ch.title||'Ø§Ù„Ù‚Ø§Ø±Ø¦')}</title></head><body style="background:#0f0f12;color:#fff;font-family:Cairo;padding:12px">`; if(Array.isArray(ch.images) && ch.images.length>0){ ch.images.forEach(img => html += `<img src="${escapeHtml(img)}" style="display:block;max-width:100%;margin:12px auto;border-radius:8px" />`); }else { html += `<p class="small">Ù„Ø§ ØµÙˆØ± Ù…ØªØ§Ø­Ø©. Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ.</p><a href="${escapeHtml(ch.chapterUrl||'#')}" target="_blank" class="btn">ÙØªØ­ Ø§Ù„ÙØµÙ„</a>`; } html += '</body></html>'; w.document.write(html); w.document.close(); }

/****************** Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ******************/
function addRepoFromInput(){ const url = (document.getElementById('repoUrlInput').value||'').trim(); if(!url) return alert('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· JSON Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹'); state.repos.push({name: url.split('/').slice(-2,-1)[0]||url, url, loaded:false, items:[]}); document.getElementById('repoUrlInput').value=''; renderRepoTabs(); }
function loadPrepopulated(){ PREPOPULATED_REPOS.forEach(r=> state.repos.push({name:r.name,url:r.url, loaded:false, items:[]})); renderRepoTabs(); if(state.repos.length>0) selectRepo(0); }
function importFromPaste(){ const txt = document.getElementById('repoPaste').value.trim(); if(!txt) return alert('Ø£Ù„ØµÙ‚ JSON Ø£ÙˆÙ„Ø§Ù‹'); try{ const json = JSON.parse(txt); if(Array.isArray(json)) { json.forEach(it=> { if(it && (it.url||it.name)) state.repos.push({name: it.name||it.title||'repo', url: it.url||it.repo||it.index, loaded:false, items:[]}); else state.repos.push({name:'repo-pasted', url: '', loaded:false, items:[normalizeExtensionFromRepoFormat(it)]}); }); } else if(json.name && json.url){ state.repos.push({name: json.name, url: json.url, loaded:false, items:[]}); } else { state.repos.push({name:'repo-pasted', url:'(pasted)', loaded:true, items:Array.isArray(json)?json:[json]}); } document.getElementById('repoPaste').value=''; renderRepoTabs(); } catch(e){ alert('JSON ØºÙŠØ± ØµØ§Ù„Ø­'); console.error(e); } }
function clearRepos(){ if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§ØªØŸ')){ state.repos=[]; state.currentRepoIndex=null; renderRepoTabs(); document.getElementById('extensionsGrid').innerHTML=''; } }

/****************** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ----------------- */
function placeholderThumb(text){ const t = encodeURIComponent((text||'cover').slice(0,20)); return `https://via.placeholder.com/160x240.png?text=${t}&bg=111111&fg=d9d0ff`; }
function shorten(s, n=120){ return s && s.length>n ? s.slice(0,n-1)+'â€¦' : s || ''; }
function guessUrlFromRaw(raw){ if(!raw) return ''; return raw.url || raw.repo || raw.index || raw.apk || raw.link || ''; }
function setDetails(txt){ document.getElementById('repoTabs').title = txt; }
function switchPanel(p){ document.getElementById('panelSources').style.display = p==='sources' ? 'block' : 'none'; document.getElementById('panelExtensions').style.display = p==='extensions' ? 'block' : 'none'; document.getElementById('tabSources').classList.toggle('active', p==='sources'); document.getElementById('tabExtensions').classList.toggle('active', p==='extensions'); }
function removeSource(i){ if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±ØŸ')){ state.sources.splice(i,1); renderSourcesGrid(); } }

/* ---- ØªØ­ÙˆÙŠÙ„ JSON Ø¥Ù„Ù‰ base64 ÙˆØ¨Ø§Ù„Ø¹ÙƒØ³ - Ø¢Ù…Ù† Ù„Ù„ÙŠÙˆÙ†ÙŠÙƒÙˆØ¯ ---- */
function escapeJson(obj){const utf8 = encodeURIComponent(JSON.stringify(obj)).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1));return btoa(utf8);}function unescapeJson(b64){const str = atob(b64);const dec = decodeURIComponent(Array.prototype.map.call(str, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));try{ return JSON.parse(dec); }catch(e){ console.error('ÙØ´Ù„ ÙÙƒ JSON:', e); return null; }}
renderRepoTabs(); renderSourcesGrid();

/****************** Ø­Ù…Ø§ÙŠØ© HTML ----------------- */
function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m])); }

/*********** Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙ‚Ù†ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù…Ù‡Ù…Ø©): ***********
- Ù…Ø¹Ø¸Ù… Ø±ÙˆØ§Ø¨Ø· raw Ù…Ù† GitHub Ù‚Ø¯ ØªÙ…Ù†Ø¹ fetch Ø¨Ø³Ø¨Ø¨ CORS Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ (file://).
- Ù„ØªÙØ§Ø¯ÙŠ Ø°Ù„Ùƒ Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ (python -m http.server Ø£Ùˆ npx serve) Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ØµØµ.
- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù† ÙŠÙ‚Ø±Ø£ Ø¨ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¨Ù†ÙŠØ© Ø§Ù„ØªÙŠ ÙˆØµÙØªÙ‡Ø§: name, pkg, apk, lang, code, version, nsfw, sources[]. ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ„ Ù…ØµØ¯Ø± Ù…Ù†ÙØ±Ø¯Ø§Ù‹ Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ APK Ø¥Ù† ÙˆÙØ¬Ø¯.
***************************************************/
</script>
</body></html>
