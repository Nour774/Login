<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family:"Tahoma",sans-serif; background: linear-gradient(135deg,#6a0572,#b5173a); margin:0; padding:20px; color:white; }
    input { padding:6px; margin-bottom:10px; width:300px; border-radius:5px; border:none; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { padding:8px 12px; border:1px solid white; text-align:center; }
    th { background: rgba(0,0,0,0.5); cursor:pointer; }
    button { margin:2px; padding:6px 10px; border:none; border-radius:5px; cursor:pointer; color:white; }
    .ban { background:#e63946; }
    .block { background:#f4a261; }
    .unblock { background:#2a9d8f; }
    .delete { background:#d00000; }
    .promote { background:#264653; }
    .demote { background:#6a0572; }
  </style>
</head>
<body>
  <h1>لوحة التحكم</h1>
  <button onclick="logout()">تسجيل خروج</button>
  <br>
  <input type="text" id="searchInput" placeholder="ابحث باسم المستخدم أو البريد" oninput="filterTable()">

  <table id="usersTable">
    <thead>
      <tr>
        <th onclick="sortTable('username')">الاسم</th>
        <th onclick="sortTable('email')">البريد</th>
        <th onclick="sortTable('role')">الدور</th>
        <th onclick="sortTable('status')">الحالة</th>
        <th>إجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg"; // للقراءة فقط
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ADMIN_API_URL = "https://script.google.com/macros/s/AKfycbyI8PaVuX6LMB1wg_up3vHjbi_Y46keZWKuDFnLDN8qKqjdAjY0PnHZVF9-FFKO8k5J/exec";
    const ADMIN_SECRET = "mySecret123";

    let allUsers = [];
    let sortOrder = { column: null, asc: true };

    async function checkBlocked() {
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if(error || !user) { window.location.href="index.html"; return; }
        const { data: profile } = await supabase.from("profiles").select("status").eq("id", user.id).single();
        if(profile?.status === "blocked") {
          alert("تم حظرك من الوصول.");
          await supabase.auth.signOut();
          window.location.href="index.html";
          return;
        }
      } catch(err) {
        console.error(err);
        alert("فشل التحقق من الحالة. حاول إعادة تحميل الصفحة.");
      }
    }

    async function loadUsers() {
      try {
        const { data: { user }, error: userErr } = await supabase.auth.getUser();
        if(userErr || !user) { window.location.href="index.html"; return; }

        const { data: users, error } = await supabase.from("profiles").select("*");
        if(error) { alert("خطأ في جلب الأعضاء"); return; }

        allUsers = users;
        renderTable(users);

      } catch(err) {
        console.error(err);
        alert("حدث خطأ في الاتصال بالسيرفر. حاول إعادة تحميل الصفحة.");
      }
    }

    function renderTable(users) {
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";
      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.username}</td>
          <td>${u.email || "-"}</td>
          <td>${u.role}</td>
          <td>${u.status || "active"}</td>
          <td>
            ${u.role !== "admin" ? `
              <button class="ban" onclick="adminAction('${u.id}','ban')">طرد</button>
              <button class="block" onclick="adminAction('${u.id}','block')">حظر</button>
              <button class="unblock" onclick="adminAction('${u.id}','unblock')">رفع الحظر</button>
              <button class="delete" onclick="adminAction('${u.id}','delete_account')">حذف الحساب</button>
              <button class="promote" onclick="adminAction('${u.id}','promote')">ترقية</button>
            ` : `
              <button class="demote" onclick="adminAction('${u.id}','demote')">تخفيض</button>
            `}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterTable() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      const filtered = allUsers.filter(u => 
        (u.username && u.username.toLowerCase().includes(keyword)) || 
        (u.email && u.email.toLowerCase().includes(keyword))
      );
      renderTable(filtered);
    }

    async function adminAction(userId, action) {
      try {
        const res = await fetch(ADMIN_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ secret: ADMIN_SECRET, userId, action })
        });
        const data = await res.json();
        if(data.error) alert("خطأ: " + data.error);
        else {
          alert("تم تنفيذ: " + action);
          loadUsers();
        }
      } catch(err) {
        console.error(err);
        alert("خطأ في الاتصال بالـ API. تحقق من الاتصال بالإنترنت أو رابط الـ API.");
      }
    }

    function logout() {
      supabase.auth.signOut().then(()=> window.location.href="index.html");
    }

    function sortTable(column) {
      sortOrder.asc = sortOrder.column === column ? !sortOrder.asc : true;
      sortOrder.column = column;
      const sorted = [...allUsers].sort((a,b)=>{
        const valA = (a[column]||"").toString().toLowerCase();
        const valB = (b[column]||"").toString().toLowerCase();
        if(valA < valB) return sortOrder.asc ? -1 : 1;
        if(valA > valB) return sortOrder.asc ? 1 : -1;
        return 0;
      });
      renderTable(sorted);
    }

    checkBlocked().then(loadUsers);
  </script>
</body>
</html>
