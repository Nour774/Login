<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>Manga Sanctum - ÿπÿ±ÿ∂ ÿßŸÑŸÖÿßŸÜÿ¨ÿß</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="images/book.png" />
<style>
*{box-sizing:border-box;transition:0.25s}
body{
  margin:0;font-family:"Cairo",sans-serif;
  background:radial-gradient(circle at 50% 10%,#0b0b10,#050505 90%);
  color:#eaeaea;min-height:100vh;overflow-x:hidden;position:relative;
}
/* fog */
.fog{position:fixed;top:0;left:0;width:200%;height:200%;background:url('images/fog.png') repeat;opacity:0.15;animation:fogMove 120s linear infinite;z-index:0;pointer-events:none;transform:translate(-25%,-25%)}
@keyframes fogMove{0%{background-position:0 0}50%{background-position:1000px 800px}100%{background-position:0 0}}
/* symbols */
.symbols{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;overflow:hidden}
.symbol{position:absolute;color:rgba(168,139,255,0.08);font-size:22px;animation:floatSymbol 30s linear infinite;user-select:none}
@keyframes floatSymbol{0%{transform:translateY(100vh) rotate(0deg);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-10vh) rotate(360deg);opacity:0}}
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;background:rgba(10,10,15,0.85);backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:10;
}
.left-section{display:flex;align-items:center;gap:10px}
.back-btn{color:#eaeaea;font-size:20px;cursor:pointer;padding:8px 14px;border-radius:8px;background:rgba(255,255,255,0.05)}
.back-btn:hover{background:rgba(255,255,255,0.12)}
.logo-text{font-weight:800;font-size:26px;color:#d4c3ff;letter-spacing:1px;filter:drop-shadow(0 0 10px rgba(168,139,255,0.7));user-select:none}
.logo-box{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#a88bff,#e6c07b);
display:flex;align-items:center;justify-content:center;font-weight:900;color:#0b0710;font-size:21px;box-shadow:0 0 10px rgba(168,139,255,0.5)}
main{padding:20px;position:relative;z-index:5}
.manga-header{display:flex;flex-direction:column;align-items:center;text-align:center;padding:40px 20px 12px;position:relative}
.manga-header::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at center, rgba(168,139,255,0.06), transparent 70%);z-index:1}
.cover{width:220px;height:310px;object-fit:cover;border-radius:14px;box-shadow:0 0 50px rgba(168,139,255,0.35);z-index:2;position:relative}
.manga-title{font-size:30px;font-weight:800;margin-top:14px;background:linear-gradient(90deg,#a88bff,#e6c07b);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 10px rgba(168,139,255,0.5);z-index:2;position:relative}

/* rating */
.rating-block{text-align:center;margin-top:20px;}
.stars-row{display:inline-block;font-size:32px;letter-spacing:6px;user-select:none;}
.stars-row span{color:#444;cursor:pointer;transition:0.2s;}
.stars-row span.filled{color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,0.6);}
.rating-value{color:#cbb9ff;margin-top:6px;font-size:16px;}

/* tabs */
.tabs{display:flex;gap:10px;justify-content:center;margin-top:18px}
.tabs button{background:rgba(168,139,255,0.1);border:1px solid rgba(168,139,255,0.3);color:#cbb9ff;padding:10px 18px;border-radius:8px;cursor:pointer}
.tabs button.active{background:rgba(168,139,255,0.3)}
.tab-content{display:none;margin-top:16px}
.tab-content.active{display:block}

/* tags */
.tags-container{margin-top:18px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;z-index:2}
.tag{background:rgba(168,139,255,0.1);border:1px solid rgba(168,139,255,0.3);color:#cbb9ff;padding:6px 14px;border-radius:20px;font-size:14px;cursor:pointer}
.tag:hover{background:rgba(168,139,255,0.25);color:#fff;transform:scale(1.05)}

/* description & comments */
.manga-description{max-width:800px;margin:18px auto;color:#bdb3d6;font-size:16px;line-height:1.8;text-align:center}
.comments-area{max-width:760px;margin:14px auto 0;text-align:right}
.comment{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:8px;font-size:14px}
.comment-form{display:flex;gap:8px;justify-content:center;margin-top:10px}
.comment-form input{width:60%;padding:8px;border-radius:8px;border:1px solid rgba(168,139,255,0.2);background:rgba(255,255,255,0.03);color:#fff}
.comment-form button{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,#a88bff,#e6c07b);color:#0b0710;cursor:pointer}

/* chapters */
.search-bar{max-width:600px;margin:16px auto;display:flex;gap:10px;justify-content:center}
.search-bar input{flex:1;padding:8px 12px;border-radius:8px;border:1px solid rgba(168,139,255,0.2);background:rgba(255,255,255,0.03);color:#fff}
.chapter-list{max-width:760px;margin:10px auto;background:rgba(255,255,255,0.03);border-radius:12px;padding:8px;box-shadow:0 0 18px rgba(168,139,255,0.15)}
.chapter-item{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.chapter-item:hover{background:rgba(168,139,255,0.06)}
.chapter-item .num{color:#a88bff;font-weight:700;margin-left:12px}
footer{padding:18px;text-align:center;color:#666;font-size:13px;margin-top:30px}
@media(max-width:720px){.stars-row{font-size:26px}.manga-title{font-size:22px}.cover{width:180px;height:250px}}
</style>
</head>

<body>
<div class="fog"></div><div class="symbols" id="symbols"></div>

<header>
  <div class="left-section">
    <div class="back-btn" onclick="history.back()">‚Æå ÿπŸàÿØÿ©</div>
    <div class="logo-text">Manga Sanctum</div>
  </div>
  <div class="logo-box">MS</div>
</header>

<main>
  <section class="manga-header">
    <img id="cover" class="cover" src="" alt="ÿ∫ŸÑÿßŸÅ ÿßŸÑŸÖÿßŸÜÿ¨ÿß">
    <div class="manga-title" id="title">ÿ¨ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
  </section>

  <div class="tabs">
    <button id="detailsBtn" class="active" onclick="openTab('details')">ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ</button>
    <button id="chaptersBtn" onclick="openTab('chapters')">ÿßŸÑŸÅÿµŸàŸÑ</button>
  </div>

  <!-- ÿ™ŸÅÿßÿµŸäŸÑ -->
  <div id="details" class="tab-content active">
    <div class="rating-block">
      <div id="userStars" class="stars-row"></div>
      <div id="avgStars" class="stars-row" style="margin-top:6px;"></div>
      <div id="ratingNumeric" class="rating-value"></div>
    </div>
    <div id="description" class="manga-description"></div>
    <div id="tagsContainer" class="tags-container"></div>

    <div class="comments-area" id="commentsArea">
      <div style="text-align:center;color:#cbb9ff;margin-bottom:8px;font-weight:700">ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</div>
      <div id="commentsList"></div>
      <div class="comment-form">
        <input id="commentInput" placeholder="ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇŸÉ..." />
        <button id="addCommentBtn">ÿ£ÿ∂ŸÅ ÿßŸÑÿ™ÿπŸÑŸäŸÇ</button>
      </div>
    </div>
  </div>

  <!-- ÿßŸÑŸÅÿµŸàŸÑ -->
  <div id="chapters" class="tab-content">
    <div class="search-bar">
      <input id="chapterSearch" placeholder="ÿßÿ®ÿ≠ÿ´ ÿ®ÿ±ŸÇŸÖ ÿ£Ÿà ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÅÿµŸÑ..." />
    </div>
    <div id="chaptersList" class="chapter-list"></div>
  </div>
</main>

<footer>¬© 2025 Manga Sanctum | Realm of Shadows & Light</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const mangaId=new URLSearchParams(window.location.search).get("manga_id");

function spawnSymbols(){
 const SYMBOLS=["‚òΩ","‚ú¶","‚ú∂","‚õß","‚ò•","‚ôÜ","Âçç","‚öö"];
 const c=document.getElementById("symbols");
 for(let i=0;i<20;i++){
   const s=document.createElement("div");
   s.className="symbol";
   s.textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
   s.style.left=(Math.random()*100)+"%";
   s.style.top=(Math.random()*100)+"%";
   s.style.fontSize=(14+Math.random()*28)+"px";
   s.style.animationDelay=(Math.random()*30)+"s";
   c.appendChild(s);
 }
}

// üî∏ ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ¨ŸàŸÖ (5 ŸÜÿ¨ŸàŸÖ = 10 ÿØÿ±ÿ¨ÿßÿ™)
function renderStars(container,value,editable,onChange){
 container.innerHTML="";
 for(let i=1;i<=5;i++){
   const star=document.createElement("span");
   star.textContent="‚òÖ";
   if(i<=Math.round(value/2))star.classList.add("filled");
   if(editable){
     star.addEventListener("click",()=>{onChange(i*2)});
     star.addEventListener("mouseover",()=>{
       container.querySelectorAll("span").forEach((s,j)=>s.classList.toggle("filled",j<i));
     });
     star.addEventListener("mouseout",()=>renderStars(container,value,editable,onChange));
   }
   container.appendChild(star);
 }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿßŸÜÿ¨ÿß
async function loadMangaInfo(){
 const {data,error}=await supabase.from("manga_list").select("*").eq("id",mangaId).single();
 if(error)return console.error(error);
 document.getElementById("title").textContent=data.title;
 document.getElementById("cover").src=data.cover_url||"images/book.png";
 document.getElementById("description").textContent=data.description||"ŸÑÿß ŸäŸàÿ¨ÿØ ŸàÿµŸÅ.";
 const tagsEl=document.getElementById("tagsContainer");
 tagsEl.innerHTML="";
 if(data.tags){
   data.tags.split(",").map(t=>t.trim()).forEach(tag=>{
     const d=document.createElement("div");
     d.className="tag";d.textContent=tag;
     tagsEl.appendChild(d);
   });
 }
}

// ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖ
async function loadRatings(){
 const {data}=await supabase.from("manga_ratings").select("rating");
 const ratings=data?.map(r=>r.rating)||[];
 const avg=ratings.length?(ratings.reduce((a,b)=>a+b,0)/ratings.length):0;
 renderStars(document.getElementById("avgStars"),avg,false);
 document.getElementById("ratingNumeric").textContent=`(${avg.toFixed(1)} / 10)`;
 const me=await getUser();
 const {data:u}=await supabase.from("manga_ratings").select("rating").eq("manga_id",mangaId).eq("user_id",me.id).maybeSingle();
 const userVal=u?.rating||0;
 renderStars(document.getElementById("userStars"),userVal,true,async(v)=>{
   await supabase.from("manga_ratings").upsert({manga_id:mangaId,user_id:me.id,rating:v});
   loadRatings();
 });
}

// ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≠ŸÑŸä
async function getUser(){
 let id=localStorage.getItem("uid");
 if(!id){id=crypto.randomUUID();localStorage.setItem("uid",id);}
 return {id};
}

// ÿ™ÿ®ŸàŸäÿ®ÿßÿ™
function openTab(id){
 document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
 document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
 document.getElementById(id+"Btn").classList.add("active");
 document.getElementById(id).classList.add("active");
}

// ÿ™ÿπŸÑŸäŸÇÿßÿ™
async function loadComments(){
 const {data}=await supabase.from("comments").select("*").eq("manga_id",mangaId).order("created_at",{ascending:false});
 const list=document.getElementById("commentsList");
 list.innerHTML=data.map(c=>`<div class="comment"><b style="color:#e6c07b">${c.username}</b><br>${c.content}</div>`).join("")||"<div style='text-align:center;color:#777'>ŸÑÿß ÿ™ÿπŸÑŸäŸÇÿßÿ™</div>";
}
async function addComment(){
 const input=document.getElementById("commentInput");
 const txt=input.value.trim();if(!txt)return;
 const me=await getUser();
 await supabase.from("comments").insert([{manga_id:mangaId,username:"ŸÖÿ≥ÿ™ÿÆÿØŸÖ",content:txt}]);
 input.value="";loadComments();
}

// ŸÅÿµŸàŸÑ
let allChapters=[];
async function loadChapters(){
 const {data}=await supabase.from("chapters").select("*").eq("manga_id",mangaId).order("number");
 allChapters=data||[];
 renderChapters(allChapters);
 document.getElementById("chapterSearch").addEventListener("input",ev=>{
   const q=ev.target.value.toLowerCase();
   renderChapters(allChapters.filter(c=>String(c.number).includes(q)||(c.title||"").toLowerCase().includes(q)));
 });
}
function renderChapters(chs){
 const c=document.getElementById("chaptersList");
 c.innerHTML=chs.map(ch=>`<div class="chapter-item"><div>${ch.title}</div><div class="num">ÿßŸÑŸÅÿµŸÑ ${ch.number}</div></div>`).join("")||"<div style='text-align:center;color:#777'>ŸÑÿß ŸÅÿµŸàŸÑ</div>";
}

(async()=>{
 spawnSymbols();
 await loadMangaInfo();
 await loadRatings();
 await loadComments();
 await loadChapters();
 document.getElementById("addCommentBtn").addEventListener("click",addComment);
})();
</script>
</body>
</html>
