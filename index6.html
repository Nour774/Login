<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة التحكم</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
body { font-family:"Tahoma",sans-serif; background:#1e1e2f; color:white; margin:0; padding:20px; }
input[type="text"] { padding:8px; width:320px; border-radius:6px; border:0; outline:none; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #444; padding:8px; text-align:center; font-size:14px; }
th { background:#2a2a3d; }
button { padding:5px 8px; margin:2px; border:none; border-radius:5px; cursor:pointer; font-size:13px; }
.badge { padding:4px 8px; border-radius:6px; background:#34495e; display:inline-block; }
</style>
</head>
<body>

<h1>لوحة التحكم</h1>
<input type="text" id="searchInput" placeholder="ابحث باسم المستخدم أو البريد..." autocomplete="off">

<table id="usersTable">
<thead>
<tr>
<th>الاسم</th><th>البريد</th><th>الحالة</th><th>الدور</th><th>الإجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1stkrkD8PclkVjWDI8-Ge5f4ibR-HlyOkHxeE_CUH0k4wLC21ISoa91r4hxaVTzSQrw/exec";
const ADMIN_SECRET = "mySecret123";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentUserRole = "";

document.addEventListener("DOMContentLoaded", init);

async function init() {
    const { data: { session }, error } = await supabase.auth.getSession();
    if(error || !session) {
        alert("لم يتم تسجيل الدخول. إعادة التوجيه...");
        window.location.href = "index5.html";
        return;
    }
    currentUserId = session.user.id;

    const { data: profile, error: profileErr } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', currentUserId)
        .single();

    if(profileErr || !profile) {
        alert("لم يتم العثور على المستخدم. إعادة التوجيه...");
        window.location.href = "index5.html";
        return;
    }

    currentUserRole = (profile.role || "user").toLowerCase();

    if(currentUserRole === "user") {
        alert("ليس لديك صلاحية الدخول!");
        window.location.href = "index5.html";
        return;
    }

    fetchAndRenderUsers();

    setInterval(async () => {
        await fetchAndRenderUsers();
        await checkRole();
    }, 2000);
}

async function checkRole() {
    const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', currentUserId)
        .single();
    const role = (profile?.role || "user").toLowerCase();
    if(!["admin","owner"].includes(role)) {
        alert("تم تخفيض رتبك أو ليس لديك صلاحية!");
        window.location.href = "index5.html";
    }
}

async function fetchAndRenderUsers() {
    const { data: users, error } = await supabase.from('profiles').select('*').order('username');
    if(error || !users) { console.error(error); return; }

    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";

    users.forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${escapeHtml(u.username || "")}${u.id===currentUserId?" ⇽ أنت":""}</td>
            <td>${escapeHtml(u.email || "")}</td>
            <td>${escapeHtml(u.status || "active")}</td>
            <td>${escapeHtml(u.role || "user")}</td>
            <td>${getActionButtons(currentUserRole,u)}</td>
        `;
        tbody.appendChild(tr);
    });
}

function getActionButtons(role, user){
    if(user.id===currentUserId) return `<span class="badge">أنت (${role})</span>`;
    if(role==="owner" || (role==="admin" && user.role==="user")) {
        return `
          <button onclick="adminAction('block','${user.id}')">حظر</button>
          <button onclick="adminAction('unblock','${user.id}')">رفع الحظر</button>
          <button onclick="adminAction('promote','${user.id}')">ترقية</button>
          <button onclick="adminAction('demote','${user.id}')">تخفيض</button>
          <button onclick="adminAction('delete_account','${user.id}')">حذف</button>
        `;
    }
    return `<span class="badge">---</span>`;
}

// ✅ تنفيذ الإجراءات عبر Google Script
async function adminAction(action,userId){
    try{
        const url = `${SCRIPT_URL}?secret=${encodeURIComponent(ADMIN_SECRET)}&action=${encodeURIComponent(action)}&userId=${encodeURIComponent(userId)}`;
        const res = await fetch(url);
        const data = await res.json().catch(()=>({}));
        alert(data.error || data.message || "تم الإجراء بنجاح!");
        fetchAndRenderUsers();
    } catch(e) { console.error(e); alert("فشل الاتصال"); }
}

// البحث
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input",()=> {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("#usersTable tbody tr").forEach(r=>{
        r.style.display = r.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
});

function escapeHtml(text){
    return text.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}
</script>
</body>
</html>
