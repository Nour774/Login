<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>لوحة التحكم المهيبة</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: linear-gradient(135deg, #1a1a2e, #0f0f1a); color: #e0e0e0; font-family: "Tahoma", sans-serif; }
  .container { margin-top: 40px; }
  h2 { text-align: center; color: #f97316; margin-bottom: 20px; font-weight: bold; letter-spacing: 1px; text-shadow: 1px 1px 5px #000; }
  table { background-color: #2b2b3d; border-radius: 12px; overflow: hidden; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
  th { background: linear-gradient(90deg,#11121a,#1b1b2f); color: #f97316; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px #000; }
  td { font-size: 13px; vertical-align: middle; }
  .btn-action { margin: 2px; font-size: 12px; border-radius: 6px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.5); transition: transform 0.15s, box-shadow 0.15s; }
  .btn-action:hover { transform: translateY(-2px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.7); }
  .shake { animation: shake 0.3s; }
  @keyframes shake { 0%{transform:translateX(0);}25%{transform:translateX(-4px);}50%{transform:translateX(4px);}75%{transform:translateX(-4px);}100%{transform:translateX(0);} }
  .block { background: #dc2626; color:white; } .unblock { background: #16a34a; color:white; } .promote { background: #f97316; color:white; }
  .demote { background: #2563eb; color:white; } .delete { background: #4b5563; color:white; } .ban { background: #7c2d12; color:white; }
  .status-box { text-align:center; padding:10px; border-radius:6px; margin-bottom:15px; font-weight: bold; text-shadow: 1px 1px 3px #000; }
  .status-info { background-color: #27273d; color:#cbd5e1; }
  .status-error { background-color: #7f1d1d; color:#fee2e2; }
</style>
</head>
<body>

<div class="container">
  <h2>لوحة التحكم المهيبة</h2>
  <div id="statusBox" class="status-box status-info">جارٍ تحميل المستخدمين...</div>

  <table class="table table-bordered text-center align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>البريد</th>
        <th>الحالة</th>
        <th>الدور</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody id="usersTable"></tbody>
  </table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby6XprJUeziZbtWaKGvX3-xfveFUDBwrYmibPkJ-dlvinicFeSFYimCKnwqCTP1_fhqaA/exec";
const ADMIN_SECRET = "mySecret123";
const CURRENT_ROLE = "admin"; // "admin" أو "owner"

const statusBox = document.getElementById("statusBox");
const tbody = document.getElementById("usersTable");

function setStatus(message, isError=false) {
  statusBox.textContent = message;
  statusBox.className = 'status-box ' + (isError ? 'status-error':'status-info');
}

async function fetchUsers() {
  setStatus("جارٍ تحميل البيانات...");
  try {
    const res = await fetch(`${SCRIPT_URL}?secret=${ADMIN_SECRET}&action=list_users&currentRole=${CURRENT_ROLE}`);
    const data = await res.json();
    if(data.error) throw new Error(data.error);

    tbody.innerHTML = "";
    if(!data.users || data.users.length === 0){
      tbody.innerHTML = `<tr><td colspan="5">لا توجد بيانات.</td></tr>`;
      setStatus("لا توجد بيانات.", true);
      return;
    }

    data.users.forEach(user=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${user.id}</td>
        <td>${user.email||"-"}</td>
        <td>${user.status||"-"}</td>
        <td>${user.role||"-"}</td>
        <td></td>
      `;
      const actionsCell = tr.querySelector("td:last-child");

      if(user.role && user.role.toLowerCase() === "owner"){
        const span = document.createElement("span");
        span.textContent = "أونر";
        span.style.background="#11121a";
        span.style.color="#f97316";
        span.style.padding="4px 8px";
        span.style.borderRadius="6px";
        span.style.fontWeight="bold";
        actionsCell.appendChild(span);
      } else {
        // إظهار الأزرار فقط إذا كان المسؤول الحالي يملك الصلاحية
        const canEdit = CURRENT_ROLE === "owner" || (CURRENT_ROLE === "admin" && (!user.role || user.role.toLowerCase() === "user"));
        if(canEdit){
          const btn = (text, cls, icon, action)=>{
            const b = document.createElement("button");
            b.className = `btn-action ${cls}`;
            b.innerHTML = `${icon} ${text}`;
            b.onclick = ()=>{
              if(confirm(`هل أنت متأكد من ${text} لهذا المستخدم؟`)){
                b.classList.add("shake");
                setTimeout(()=>b.classList.remove("shake"), 300);
                adminAction(action, user.id);
              }
            };
            return b;
          };
          actionsCell.appendChild(btn("حظر","block","🔒","block"));
          actionsCell.appendChild(btn("رفع الحظر","unblock","🔓","unblock"));
          actionsCell.appendChild(btn("ترقية","promote","⭐","promote"));
          actionsCell.appendChild(btn("تخفيض","demote","🔽","demote"));
          actionsCell.appendChild(btn("حذف بروفايل","ban","⚔️","ban"));
          actionsCell.appendChild(btn("حذف الحساب","delete","❌","delete_account"));
        } else {
          actionsCell.textContent = "-";
        }
      }

      tbody.appendChild(tr);
    });
    setStatus("تم تحميل المستخدمين بنجاح.");
  } catch(err){
    setStatus("فشل جلب البيانات: " + (err.message||err), true);
  }
}

async function adminAction(action, userId){
  setStatus(`جارٍ تنفيذ ${action} على ${userId}...`);
  try{
    const res = await fetch(SCRIPT_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({secret:ADMIN_SECRET, action, userId, currentRole: CURRENT_ROLE})
    });
    const data = await res.json();
    alert(data.result || data.error || "حدث خطأ غير متوقع");
    fetchUsers();
  } catch(err){
    alert("فشل الإجراء: "+(err.message||err));
  }
}

fetchUsers();
</script>

</body>
  </html>
