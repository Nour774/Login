<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة التحكم</title>
<style>
body { font-family:"Tahoma",sans-serif; background:#1e1e2f; color:white; margin:0; padding:20px; }
input[type="text"] { padding:8px; width:320px; border-radius:6px; border:0; outline:none; margin-bottom:10px; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #444; padding:8px; text-align:center; font-size:14px; }
th { background:#2a2a3d; }
button { padding:5px 8px; margin:2px; border:none; border-radius:5px; cursor:pointer; font-size:13px; }
.badge { padding:4px 8px; border-radius:6px; background:#34495e; display:inline-block; }
</style>
</head>
<body>

<h1>لوحة التحكم</h1>
<input type="text" id="searchInput" placeholder="ابحث باسم المستخدم أو البريد..." autocomplete="off">
<table id="usersTable">
<thead>
<tr>
<th>الاسم</th><th>البريد</th><th>الحالة</th><th>الدور</th><th>الإجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1stkrkD8PclkVjWDI8-Ge5f4ibR-HlyOkHxeE_CUH0k4wLC21ISoa91r4hxaVTzSQrw/exec";
const ADMIN_SECRET = "mySecret123";

let currentUserId = null;
let currentUserRole = "";

// بدء العملية عند تحميل الصفحة
document.addEventListener("DOMContentLoaded", init);

async function init() {
    try {
        // أولًا: احصل على المستخدم الحالي من Google Script
        const res = await fetch(`${SCRIPT_URL}?action=getCurrentUser`);
        const data = await res.json();

        if(!data.user || !data.user.id) throw new Error("لم يتم التعرف على المستخدم");
        currentUserId = data.user.id;
        currentUserRole = (data.user.role || "user").toLowerCase();

        if(currentUserRole === "user") throw new Error("ليس لديك صلاحية الدخول");

        // جلب وعرض المستخدمين
        await fetchAndRenderUsers();

        // تحقق دوري
        setInterval(fetchAndRenderUsers, 3000);

    } catch(e) {
        alert(e.message);
        window.location.href = "index5.html";
    }
}

// جلب وعرض المستخدمين عبر Apps Script
async function fetchAndRenderUsers() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=getUsers&secret=${encodeURIComponent(ADMIN_SECRET)}`);
        const data = await res.json();

        if(!data.users || !Array.isArray(data.users)) throw new Error("خطأ في جلب المستخدمين");

        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        data.users.forEach(u=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${escapeHtml(u.username || "")}${u.id===currentUserId?" ⇽ أنت":""}</td>
                <td>${escapeHtml(u.email || "")}</td>
                <td>${escapeHtml(u.status || "active")}</td>
                <td>${escapeHtml(u.role || "user")}</td>
                <td>${getActionButtons(currentUserRole,u)}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch(e) {
        console.error("Fetch users error:", e);
    }
}

// أزرار الإدارة حسب الدور
function getActionButtons(role, user){
    if(user.id===currentUserId) return `<span class="badge">أنت (${role})</span>`;
    if(role==="owner" || (role==="admin" && user.role==="user")) {
        return `
            <button onclick="adminAction('block','${user.id}')">حظر</button>
            <button onclick="adminAction('unblock','${user.id}')">رفع الحظر</button>
            <button onclick="adminAction('promote','${user.id}')">ترقية</button>
            <button onclick="adminAction('demote','${user.id}')">تخفيض</button>
            <button onclick="adminAction('delete_account','${user.id}')">حذف</button>
        `;
    }
    return `<span class="badge">---</span>`;
}

// تنفيذ الإجراءات عبر Apps Script
async function adminAction(action,userId){
    try{
        const res = await fetch(`${SCRIPT_URL}?secret=${encodeURIComponent(ADMIN_SECRET)}&action=${encodeURIComponent(action)}&userId=${encodeURIComponent(userId)}`);
        const data = await res.json().catch(()=>({}));
        alert(data.error || data.message || "تم الإجراء بنجاح!");
        fetchAndRenderUsers();
    } catch(e) {
        console.error(e);
        alert("فشل الاتصال بالخدمة");
    }
}

// البحث في الجدول
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input",()=> {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("#usersTable tbody tr").forEach(r=>{
        r.style.display = r.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
});

// حماية HTML
function escapeHtml(text){
    return text.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}
</script>
</body>
</html>
