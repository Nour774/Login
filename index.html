<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</title>
  <style>
    body { font-family: "Tahoma", sans-serif;
      background: linear-gradient(135deg,#6a0572,#b5173a);
      margin:0;display:flex;align-items:center;justify-content:center;height:100vh;}
    .container{background:#fff0f6;padding:30px;border-radius:15px;box-shadow:0 4px 25px rgba(0,0,0,0.3);width:320px;text-align:center;position:relative;}
    h2{margin-bottom:20px;color:#6a0572;text-shadow:1px 1px 3px #b5173a;}
    input,button{width:100%;padding:12px;margin:10px 0;border-radius:8px;border:2px solid #6a0572;box-sizing:border-box;font-size:14px}
    input:focus{border-color:#b5173a}
    button{background:linear-gradient(135deg,#b5173a,#6a0572);color:#fff;border:none;cursor:pointer;font-weight:700;transition:.25s}
    button:disabled{background:#ccc;cursor:not-allowed}
    .password-wrapper{position:relative}
    .password-wrapper input{padding-right:35px}
    .toggle-password{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;color:#b5173a;font-size:18px}
    .switch{margin-top:12px;font-size:14px}
    .switch span{color:#6a0572}
    .switch a{color:#6a0572;font-weight:700;text-decoration:none;margin-inline-start:6px;cursor:pointer}
    .alert{position:absolute;top:-56px;left:50%;transform:translateX(-50%);padding:10px 14px;border-radius:8px;font-weight:700;display:none;box-shadow:0 2px 8px rgba(0,0,0,.2)}
    .alert.success{background:#4CAF50;color:#fff}
    .alert.error{background:#f44336;color:#fff}
    #username{display:none}
  </style>
</head>
<body>
  <div class="container">
    <div id="alert-box" class="alert" role="status" aria-live="polite"></div>

    <h2 id="form-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>

    <form id="auth-form" autocomplete="on">
      <input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username">
      <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required autocomplete="email">
      <div class="password-wrapper">
        <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required autocomplete="current-password">
        <span class="toggle-password" id="toggle-pass">ğŸ‘</span>
      </div>
      <button type="submit" id="submit-btn">Ø¯Ø®ÙˆÙ„</button>
    </form>

    <div class="switch">
      <span id="switch-label">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span>
      <a id="switch-link" href="#" role="button">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¥Ø°Ø§ Ù„Ø²Ù…)
    const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const supabaseKey = "SUPABASE_CLIENT_API_KEY";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    // -----------------------------------------------

    let isLogin = true; // true => Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„

    // Ø¹Ù†Ø§ØµØ± Ø«Ø§Ø¨ØªØ©
    const alertBox = document.getElementById('alert-box');
    const switchLink = document.getElementById('switch-link');
    const switchLabel = document.getElementById('switch-label');
    const usernameInput = document.getElementById('username');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const authForm = document.getElementById('auth-form');
    const togglePass = document.getElementById('toggle-pass');

    function showAlert(msg, type='error') {
      alertBox.textContent = msg;
      alertBox.className = 'alert ' + (type === 'success' ? 'success' : 'error');
      alertBox.style.display = 'block';
      clearTimeout(alertBox._t);
      alertBox._t = setTimeout(()=> alertBox.style.display = 'none', 3200);
    }

    // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø±Ø§Ø¨Ø· Ø«Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    switchLink.addEventListener('click', function(e){
      e.preventDefault();
      toggleForm();
    });

    // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    togglePass.addEventListener('click', function(){ 
      const p = document.getElementById('password');
      p.type = p.type === 'password' ? 'text' : 'password';
    });

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© â€” Ù†ØºÙŠÙ‘Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ Ø¨Ø¯ÙˆÙ† innerHTML
    function toggleForm() {
      authForm.reset();
      submitBtn.disabled = false;
      alertBox.style.display = 'none';

      isLogin = !isLogin; // Ù‚Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©

      if (!isLogin) {
        // ÙˆØ¶Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
        formTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
        usernameInput.style.display = 'block';
        submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„';
        switchLabel.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
        switchLink.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      } else {
        // ÙˆØ¶Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
        formTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        usernameInput.style.display = 'none';
        submitBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
        switchLabel.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
        switchLink.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      }
    }

    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…ØªØ·Ø§Ø¨Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
    (function initUI(){
      if (isLogin) {
        usernameInput.style.display = 'none';
        formTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        submitBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
        switchLabel.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
        switchLink.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
      }
    })();

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙÙˆØ±Ù… (Supabase logic ÙƒÙ…Ø§ Ù‚Ø¨Ù„)
    authForm.addEventListener('submit', async function(e){
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const username = document.getElementById('username').value.trim();

      if (!isLogin && !username) { showAlert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¬Ø¨Ø§Ø±ÙŠ.','error'); return; }
      const emailRegex = /^[^ ]+@[^ ]+\.[a-z]{2,}$/i;
      if (!emailRegex.test(email)) { showAlert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ§Ù„Ø­.','error'); return; }
      if (password.length < 6) { showAlert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.','error'); return; }

      submitBtn.disabled = true;

      try {
        if (isLogin) {
          const { data, error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) { showAlert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (error.message || error),'error'); submitBtn.disabled = false; return; }
          showAlert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!','success');
          setTimeout(()=> window.location.href = 'index2.html', 900);
        } else {
          const { data: signupData, error: signupErr } = await supabase.auth.signUp({ email, password });
          if (signupErr) { showAlert('Ø®Ø·Ø£: '+(signupErr.message||signupErr),'error'); submitBtn.disabled=false; return; }

          // Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€” Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØªØ­Ù‚Ù‚ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
          const { data: signInData, error: signInErr } = await supabase.auth.signInWithPassword({ email, password });
          if (signInErr || !signInData?.user) {
            showAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ. ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ÙˆØ§Ø±Ø¯ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨.','success');
            submitBtn.disabled=false;
            return;
          }
          const user = signInData.user;
          const { error: profileError } = await supabase.from('Profiles').insert([{ id: user.id, username }]);
          if (profileError) { showAlert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù„ÙƒÙ† Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„: '+profileError.message,'error'); submitBtn.disabled=false; return; }
          showAlert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!','success');
          setTimeout(()=> window.location.href='index2.html',900);
        }
      } catch(err) {
        console.error(err);
        showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯.','error');
        submitBtn.disabled=false;
      }
    });
  </script>
</body>
  </html>
