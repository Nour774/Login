<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Manga Sanctum - عرض المانجا</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  * { box-sizing: border-box; transition: 0.3s ease; }
  body {
    margin: 0;
    font-family: "Cairo", "Tahoma", sans-serif;
    background: radial-gradient(circle at 50% 10%, #0b0b10, #050505 90%);
    color: #eaeaea;
    overflow-x: hidden;
    min-height: 100vh;
    position: relative;
  }
  header { display:flex; justify-content: space-between; align-items: center; padding:14px 20px; background: rgba(10,10,15,0.85); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.05); position: sticky; top:0; z-index:10; }
  .left-section { display:flex; align-items:center; gap:10px; }
  .back-btn { color:#eaeaea; font-size:20px; cursor:pointer; padding:8px 14px; border-radius:8px; background: rgba(255,255,255,0.05); }
  .back-btn:hover{ background: rgba(255,255,255,0.12); }
  .logo-text { font-weight:800; font-size:26px; color:#d4c3ff; letter-spacing:1px; white-space:nowrap; filter: drop-shadow(0 0 10px rgba(168,139,255,0.7)) drop-shadow(0 0 25px rgba(122,95,255,0.4)) blur(0.3px); animation: softGlow 3s ease-in-out infinite alternate; user-select:none; }
  @keyframes softGlow { from {opacity:0.95; filter: drop-shadow(0 0 8px rgba(168,139,255,0.6)) drop-shadow(0 0 20px rgba(122,95,255,0.3)) blur(0.4px);} to {opacity:1; filter: drop-shadow(0 0 14px rgba(168,139,255,0.9)) drop-shadow(0 0 40px rgba(122,95,255,0.5)) blur(0.6px);}}
  .logo-box { width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#a88bff,#e6c07b);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0b0710;font-size:21px;box-shadow:0 0 10px rgba(168,139,255,0.5);}
  @media(max-width:600px){.logo-text{font-size:22px;}.back-btn{font-size:18px;padding:6px 12px;}.logo-box{width:36px;height:36px;font-size:16px;}}
  main{padding:20px; text-align:center;}
  .cover{max-width:300px;width:100%;border-radius:12px;margin:0 auto;display:block;}
  .manga-title{font-size:30px;font-weight:800;margin-top:16px;background:linear-gradient(90deg,#a88bff,#e6c07b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 10px rgba(168,139,255,0.5);}
  .manga-description{max-width:800px;margin:10px auto 0;color:#bdb3d6;font-size:16px;line-height:1.8;}
  .tab-buttons{margin-top:20px; display:flex; justify-content:center; gap:10px;}
  .tab-buttons button{background: rgba(168,139,255,0.1); border:1px solid rgba(168,139,255,0.3); color:#cbb9ff; padding:10px 20px; border-radius:8px; cursor:pointer; transition:0.3s;}
  .tab-buttons button.active{background: rgba(168,139,255,0.3);}
  .tab-content{display:none; margin-top:20px; text-align:right;}
  .tab-content.active{display:block;}
  .tags-container{margin-top:20px; display:flex; flex-wrap:wrap; justify-content:center; gap:10px;}
  .tag{background: rgba(168,139,255,0.1); border:1px solid rgba(168,139,255,0.3); color:#cbb9ff; padding:6px 14px; border-radius:20px; font-size:14px; cursor:pointer; transition:0.2s;}
  .tag:hover{background: rgba(168,139,255,0.25); color:#fff; transform:scale(1.05);}
  .rating{display:flex; align-items:center; justify-content:center; gap:4px; font-size:22px; margin:10px 0;}
  .rating span{cursor:pointer; transition:0.2s;}
  .rating span.active{color: gold;}
  .comment-box{margin-top:20px;}
  .comment-box input{width:80%; padding:8px; border-radius:8px; border:1px solid rgba(168,139,255,0.3);}
  .comment-box button{padding:8px 16px; margin-top:10px; border-radius:8px; background: rgba(168,139,255,0.3); color:#fff; cursor:pointer;}
  .comments-list{margin-top:15px;}
  .comment{background: rgba(255,255,255,0.03); border-radius:8px; padding:10px; margin-bottom:8px; font-size:14px; text-align:right;}
  .chapter-search input{width:100%; padding:8px; border-radius:8px; border:1px solid rgba(168,139,255,0.3); margin-bottom:15px;}
  .chapters-list{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;}
  .chapter-item{background: rgba(168,139,255,0.08); border-radius:8px; padding:10px; text-align:center; cursor:pointer; transition:0.3s;}
  .chapter-item:hover{background: rgba(168,139,255,0.2);}
</style>
</head>
<body>
<header>
  <div class="left-section">
    <div class="back-btn" onclick="history.back()">⮌ عودة</div>
    <div class="logo-text">Manga Sanctum</div>
  </div>
  <div class="logo"><div class="logo-box">MS</div></div>
</header>

<main>
  <img id="cover" class="cover" src="" alt="غلاف المانجا">
  <h2 id="title" class="manga-title">جار التحميل...</h2>
  <p id="description" class="manga-description"></p>
  <div id="tagsContainer" class="tags-container"></div>

  <div class="tab-buttons">
    <button id="detailsBtn" class="active" onclick="switchTab('details')">التفاصيل</button>
    <button id="chaptersBtn" onclick="switchTab('chapters')">الفصول</button>
  </div>

  <div id="details" class="tab-content active">
    <div class="rating" id="rating"></div>
    <div class="comment-box">
      <input type="text" id="newComment" placeholder="اكتب تعليقك...">
      <button id="addCommentBtn">أضف التعليق</button>
    </div>
    <div id="comments" class="comments-list"></div>
  </div>

  <div id="chapters" class="tab-content">
    <div class="chapter-search">
      <input type="text" id="chapterSearch" placeholder="ابحث برقم أو عنوان الفصل..." oninput="filterChapters()">
    </div>
    <div id="chaptersList" class="chapters-list"></div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const mangaId = new URLSearchParams(window.location.search).get("manga_id");

async function getUser(){
  let id = localStorage.getItem("user_id");
  if(!id){ id=crypto.randomUUID(); localStorage.setItem("user_id",id);}
  return { id };
}

async function loadMangaInfo(){
  const { data: manga, error } = await supabase.from("manga_list").select("*").eq("id",mangaId).single();
  if(error) return console.error(error);
  document.getElementById("title").textContent=manga.title;
  document.getElementById("description").textContent=manga.description || "لا يوجد وصف متاح.";
  document.getElementById("cover").src=manga.cover_url;
  const tagsContainer=document.getElementById("tagsContainer");
  tagsContainer.innerHTML="";
  if(manga.tags){
    manga.tags.split(",").map(t=>t.trim()).filter(Boolean).forEach(tag=>{
      const tagEl=document.createElement("div");
      tagEl.className="tag"; tagEl.textContent=tag;
      tagEl.onclick=()=>{ window.location.href=`index13.html?tag=${encodeURIComponent(tag)}`; };
      tagsContainer.appendChild(tagEl);
    });
  }
  loadRating();
  loadComments();
  loadChapters();
}

async function loadRating(){
  const { data, error } = await supabase.from("manga_ratings").select("rating").eq("manga_id",mangaId);
  if(error) return console.error(error);
  const ratings=data.map(r=>r.rating);
  const avg = ratings.length ? (ratings.reduce((a,b)=>a+b,0)/ratings.length).toFixed(1) : 0;
  const ratingDiv=document.getElementById("rating");
  ratingDiv.innerHTML="";
  for(let i=1;i<=5;i++){
    const star=document.createElement("span");
    star.textContent="★";
    star.dataset.value=i;
    if(i<=avg) star.classList.add("active");
    star.onclick=()=>submitRating(i);
    ratingDiv.appendChild(star);
  }
  const avgText=document.createElement("span");
  avgText.style.marginLeft="8px";
  avgText.textContent=`(${avg}/5)`;
  ratingDiv.appendChild(avgText);
}

async function submitRating(value){
  const user=await getUser();
  await supabase.from("manga_ratings").upsert({ manga_id:mangaId,user_id:user.id,rating:value },{ onConflict:["manga_id","user_id"] });
  loadRating();
}

async function loadComments(){
  const { data: comments, error } = await supabase.from("comments").select("*").eq("manga_id",mangaId).order("created_at",{ascending:true});
  if(error) return console.error(error);
  const container=document.getElementById("comments");
  container.innerHTML="";
  comments.forEach(c=>{
    const div=document.createElement("div"); div.className="comment";
    div.textContent=`${c.username}: ${c.content}`;
    container.appendChild(div);
  });
}

document.getElementById("addCommentBtn").addEventListener("click", async ()=>{
  const user=await getUser();
  const input=document.getElementById("newComment");
  const text=input.value.trim();
  if(!text) return;
  await supabase.from("comments").insert({ manga_id:mangaId, username:"مستخدم", content:text });
  input.value="";
  loadComments();
});

let allChapters=[];
async function loadChapters(){
  const { data: chapters, error } = await supabase.from("chapters").select("*").eq("manga_id",mangaId).order("number",{ascending:true});
  if(error) return console.error(error);
  allChapters=chapters;
  renderChapters(chapters);
}

function renderChapters(chapters){
  const list=document.getElementById("chaptersList");
  list.innerHTML="";
  if(!chapters.length) { list.innerHTML="<p>لا توجد فصول بعد.</p>"; return;}
  chapters.forEach(ch=>{
    const div=document.createElement("div");
    div.className="chapter-item";
    div.textContent=`الفصل ${ch.number}: ${ch.title}`;
    div.onclick=()=>window.location.href=`index9.html?manga_id=${mangaId}&chapter_id=${ch.id}`;
    list.appendChild(div);
  });
}

function filterChapters(){
  const q=document.getElementById("chapterSearch").value.trim().toLowerCase();
  renderChapters(allChapters.filter(c=>c.title.toLowerCase().includes(q) || String(c.number).includes(q)));
}

function switchTab(tab){
  document.querySelectorAll(".tab-buttons button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.getElementById(tab).classList.add("active");
  document.getElementById(tab+"Btn").classList.add("active");
}

loadMangaInfo();
</script>
</body>
</html>
