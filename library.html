<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📜 قارئ المانجا الغامض</title>
<link rel="icon" href="images/book.png"/>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { box-sizing: border-box; transition: 0.3s ease; }
  body { margin:0; font-family:'Cairo',sans-serif; background: radial-gradient(circle at center, #111 40%, #000); color:#eee; display:flex; justify-content:center; padding:10px; min-height:100vh; }
  #content { width:100%; max-width:1200px; }

  /* شبكة المانجا */
  .manga-grid {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
    gap:14px;
    margin-top:18px;
  }
  .manga-item {
    display:flex;
    flex-direction:column;
    align-items:center;
    background: rgba(30,30,30,0.9);
    border-radius:14px;
    cursor:pointer;
    box-shadow:0 0 15px #400 inset;
    overflow:hidden;
    text-align:center;
    transition:0.25s;
  }
  .manga-item:hover {
    background:#222;
    box-shadow:0 0 20px #800 inset;
    transform:translateY(-4px);
  }
  .manga-cover {
    width:100%;
    aspect-ratio:2/3;
    object-fit:cover;
    border-radius:8px 8px 0 0;
    box-shadow:0 0 12px #c00;
  }
  .manga-item h3 {
    font-size:1rem;
    margin:10px 0;
    color:#ffdddd;
    text-shadow:0 0 6px #c00;
    padding:0 5px;
  }

  /* الفصول */
  .chapter-item {
    padding:10px;
    margin:6px 0;
    background: rgba(40,40,40,0.9);
    border-right:4px solid #a00;
    border-radius:8px;
    cursor:pointer;
    transition:0.2s;
    font-size:1.1rem;
  }
  .chapter-item:hover { background:#333; }

  /* أزرار */
  .back-btn, .sort-btn { padding:10px 18px; margin:6px; font-size:1rem; background:linear-gradient(90deg,#800,#b00); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold; box-shadow:0 0 10px #600; transition:0.25s; }
  .back-btn:hover, .sort-btn:hover { background:linear-gradient(90deg,#b00,#e00); transform:scale(1.05); }

  /* القائمة الجانبية */
  .sidebar {
    position: fixed;
    top:0;
    right:-250px;
    width:250px;
    height:100%;
    background:#333;
    padding:20px;
    transition:right 0.3s ease;
    z-index:1000;
  }
  .sidebar.active { right:0; }
  .sidebar a, .sidebar button {
    display:block;
    margin-bottom:10px;
    color:#fff;
    background:none;
    border:none;
    font-size:16px;
    cursor:pointer;
    text-align:right;
  }
  .overlay {
    position:fixed;
    top:0;
    right:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.5);
    display:none;
    z-index:999;
  }
  .overlay.active { display:block; }

  @media(max-width:768px){ .manga-item h3{ font-size:0.9rem; } .chapter-item{ font-size:0.95rem; } .back-btn, .sort-btn{ font-size:0.9rem; padding:8px 12px; } }
  @media(max-width:480px){ .manga-grid { grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:10px; } }
</style>
</head>
<body>

<button onclick="toggleMenu()" style="position:fixed;top:10px;left:10px;z-index:1100;">☰</button>

<div id="content">جارٍ التحميل...</div>

<div class="sidebar" id="sidebar">
  <a href="#" onclick="goToMembers()">الأعضاء</a>
  <button id="adminBtn" onclick="goToAdmin()" style="display:none;">لوحة التحكم</button>
  <button onclick="logout()">تسجيل الخروج</button>
</div>
<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<script>
const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentManga = null;
let currentChapters = [];
let sortAscending = true;
const content = document.getElementById('content');

function getNum(str=""){ const match = String(str).match(/\d+/); return match ? parseInt(match[0]) : 0; }

async function loadMangaList() {
  const { data, error } = await supabase.from('manga_list').select('id,title,cover_url').order('id',{ascending:true});
  if(error) return console.error(error);

  content.innerHTML = '<h2>📜 قائمة المانجا</h2><div class="manga-grid"></div>';
  const grid = content.querySelector('.manga-grid');
  (data||[]).forEach(manga=>{
    const div = document.createElement('div');
    div.className='manga-item';
    div.innerHTML=`<img src="${manga.cover_url||''}" class="manga-cover"><h3>${manga.title}</h3>`;
    div.onclick = ()=> loadChapters(manga);
    grid.appendChild(div);
  });
}

async function loadChapters(manga){
  currentManga = manga;
  const { data, error } = await supabase.from('chapters').select('id,title,number').eq('manga_id',manga.id).order('number',{ascending:true});
  if(error) return console.error(error);
  currentChapters = data||[];
  renderChapterList();
}

function renderChapterList(){
  const chapters = sortAscending ? currentChapters : [...currentChapters].reverse();
  content.innerHTML = `<button class="back-btn" onclick="loadMangaList()">← عودة</button>
  <h2>${currentManga.title}</h2>
  <button class="sort-btn" onclick="toggleSortOrder()">الترتيب: ${sortAscending?'تصاعدي ↑':'تنازلي ↓'}</button>`;
  
  chapters.forEach(ch=>{
    const div = document.createElement('div');
    div.className='chapter-item';
    div.textContent = `الفصل ${ch.number} — ${ch.title||''}`;
    div.onclick = ()=> location.href=`index8.html?chapter_id=${ch.id}`;
    content.appendChild(div);
  });
}

function toggleSortOrder(){ sortAscending = !sortAscending; renderChapterList(); }

function toggleMenu(){
  document.getElementById("sidebar").classList.toggle("active");
  document.getElementById("overlay").classList.toggle("active");
}

function logout(){
  supabase.auth.signOut().then(()=> location.href='index.html');
}

function goToMembers(){ location.href='index3.html'; }
function goToAdmin(){ location.href='index5.html'; }

async function initSession(){
  const { data:{session} } = await supabase.auth.getSession();
  if(!session) return location.href='index.html';
  const { data:profile } = await supabase.from("profiles").select("role").eq("id",session.user.id).single();
  if(["admin","owner"].includes(String(profile?.role||"").toLowerCase())) document.getElementById("adminBtn").style.display='block';
}

initSession();
loadMangaList();
</script>

</body>
</html>
