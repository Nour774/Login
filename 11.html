<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>Manga Sanctum - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="images/book.png" />
<style>
*{box-sizing:border-box;transition:0.25s}
body{margin:0;font-family:"Cairo",sans-serif;background:radial-gradient(circle at 50% 10%,#0b0b10,#050505 90%);color:#eaeaea;min-height:100vh;overflow-x:hidden;position:relative}
.fog{position:fixed;top:0;left:0;width:200%;height:200%;background:url('images/fog.png') repeat;opacity:0.15;animation:fogMove 120s linear infinite;z-index:0;pointer-events:none;transform:translate(-25%,-25%)}
@keyframes fogMove{0%{background-position:0 0}50%{background-position:1000px 800px}100%{background-position:0 0}}
.symbols{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;overflow:hidden}
.symbol{position:absolute;color:rgba(168,139,255,0.08);font-size:22px;animation-name:floatSymbol;animation-timing-function:linear;animation-iteration-count:infinite;user-select:none}
@keyframes floatSymbol{0%{transform:translateY(100vh) rotate(0deg);opacity:0}10%{opacity:1}90%{opacity:1}100%{transform:translateY(-10vh) rotate(360deg);opacity:0}}
header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:rgba(10,10,15,0.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.05);position:sticky;top:0;z-index:10}
.left-section{display:flex;align-items:center;gap:10px}
.back-btn{color:#eaeaea;font-size:20px;cursor:pointer;padding:8px 14px;border-radius:8px;background:rgba(255,255,255,0.05)}
.back-btn:hover{background:rgba(255,255,255,0.12)}
.logo-text{font-weight:800;font-size:26px;color:#d4c3ff;letter-spacing:1px;filter:drop-shadow(0 0 10px rgba(168,139,255,0.7));user-select:none}
.logo-box{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#a88bff,#e6c07b);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0b0710;font-size:21px;box-shadow:0 0 10px rgba(168,139,255,0.5)}
main{padding:20px;position:relative;z-index:5}
.manga-header{display:flex;flex-direction:column;align-items:center;text-align:center;padding:40px 20px 12px;position:relative}
.manga-header::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at center, rgba(168,139,255,0.06), transparent 70%);z-index:1}
.cover{width:220px;height:310px;object-fit:cover;border-radius:14px;box-shadow:0 0 50px rgba(168,139,255,0.35);z-index:2;position:relative}
.manga-title{font-size:30px;font-weight:800;margin-top:14px;background:linear-gradient(90deg,#a88bff,#e6c07b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 10px rgba(168,139,255,0.5);z-index:2;position:relative}
.rating-block{margin-top:18px;text-align:center;}
.stars-row{display:block;font-size:32px;letter-spacing:8px;user-select:none;margin:6px 0}
.stars-row span{color:#444;cursor:pointer;display:inline-block;transition:0.15s}
.stars-row span.full{color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,0.6)}
.stars-row span.half{color:#FFD700;text-shadow:0 0 10px rgba(255,215,0,0.6);clip-path:inset(0 50% 0 0);display:inline-block;position:relative;overflow:hidden}
.rating-value{color:#cbb9ff;margin-top:6px;font-size:15px}
.tabs{display:flex;gap:10px;justify-content:center;margin-top:18px}
.tabs button{background:rgba(168,139,255,0.1);border:1px solid rgba(168,139,255,0.3);color:#cbb9ff;padding:10px 18px;border-radius:8px;cursor:pointer}
.tabs button.active{background:rgba(168,139,255,0.3)}
.tab-content{display:none;margin-top:16px}
.tab-content.active{display:block}
.manga-description{max-width:900px;margin:14px auto;color:#bdb3d6;font-size:16px;line-height:1.8;text-align:center}
.tags-container{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.tag{background:rgba(168,139,255,0.1);border:1px solid rgba(168,139,255,0.3);color:#cbb9ff;padding:6px 14px;border-radius:20px;font-size:14px;cursor:pointer}
.tag:hover{background:rgba(168,139,255,0.25);color:#fff;transform:scale(1.05)}
.comments-area{max-width:860px;margin:18px auto 0;text-align:right}
.comment{background:rgba(255,255,255,0.03);padding:10px;border-radius:8px;margin-bottom:8px;font-size:14px}
.comment-form{display:flex;gap:8px;justify-content:center;margin-top:10px}
.comment-form input{width:60%;padding:8px;border-radius:8px;border:1px solid rgba(168,139,255,0.2);background:rgba(255,255,255,0.03);color:#fff}
.comment-form button{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,#a88bff,#e6c07b);color:#0b0710;cursor:pointer}
.search-bar{max-width:600px;margin:16px auto;display:flex;gap:10px;justify-content:center}
.search-bar input{flex:1;padding:8px 12px;border-radius:8px;border:1px solid rgba(168,139,255,0.2);background:rgba(255,255,255,0.03);color:#fff}
.chapter-list{max-width:760px;margin:10px auto;background:rgba(255,255,255,0.03);border-radius:12px;padding:8px;box-shadow:0 0 18px rgba(168,139,255,0.15)}
.chapter-item{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;display:flex;justify-content:space-between;align-items:center}
.chapter-item:hover{background:rgba(168,139,255,0.06)}
.chapter-item.rtl{text-align:right;direction:rtl}
.chapter-item.ltr{text-align:left;direction:ltr}
.chapter-item .num{color:#a88bff;font-weight:700;margin-left:12px}
footer{padding:18px;text-align:center;color:#666;font-size:13px;margin-top:30px}
@media(max-width:720px){.stars-row{font-size:26px}.manga-title{font-size:22px}.cover{width:180px;height:250px}}
</style>
</head>
<body>
<div class="fog"></div>
<div class="symbols" id="symbols"></div>
<header>
  <div class="left-section">
    <div class="back-btn" onclick="history.back()">â®Œ Ø¹ÙˆØ¯Ø©</div>
    <div class="logo-text">Manga Sanctum</div>
  </div>
  <div class="logo-box">MS</div>
</header>
<main>
<section class="manga-header">
  <img id="cover" class="cover" src="" alt="ØºÙ„Ø§Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§">
  <div id="title" class="manga-title">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</section>

<div class="tabs">
  <button id="detailsBtn" class="active" onclick="openTab('details')">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
  <button id="chaptersBtn" onclick="openTab('chapters')">Ø§Ù„ÙØµÙˆÙ„</button>
</div>

<div id="details" class="tab-content active">
  <div style="display:flex;justify-content:center;gap:30px;margin-bottom:20px">
    <div style="text-align:center;cursor:pointer" onclick="goToComments()">
      <div style="font-size:28px;color:#a88bff">ğŸ’¬</div>
      <div style="color:#cbb9ff;font-size:14px;margin-top:4px">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
    </div>
    <div style="text-align:center;cursor:pointer" onclick="addToLibrary()">
      <div style="font-size:28px;color:#e6c07b">â•</div>
      <div style="color:#cbb9ff;font-size:14px;margin-top:4px">Ø£Ø¶Ù Ù„Ù„Ù…ÙƒØªØ¨Ø©</div>
    </div>
    <div style="text-align:center;cursor:pointer" onclick="openRatingModal()">
      <div style="font-size:28px;color:#FFD700">â­</div>
      <div style="color:#cbb9ff;font-size:14px;margin-top:4px">ØªÙ‚ÙŠÙŠÙ…Ùƒ</div>
    </div>
  </div>

  <div class="rating-block">
    <div style="margin-bottom:6px;font-weight:700;color:#cbb9ff">ØªÙ‚ÙŠÙŠÙ…Ùƒ:</div>
    <div id="userStars" class="stars-row" aria-label="ØªÙ‚ÙŠÙŠÙ…Ùƒ"></div>
    <div style="margin-top:12px;margin-bottom:6px;font-weight:700;color:#cbb9ff">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª:</div>
    <div id="avgStars" class="stars-row" aria-label="Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…"></div>
    <div id="avgText" class="rating-value"></div>
  </div>

  <div id="description" class="manga-description">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.</div>
  <div id="tagsContainer" class="tags-container"></div>

  <div class="comments-area">
    <div style="text-align:center;color:#cbb9ff;margin-bottom:8px;font-weight:700">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
    <div id="commentsList"></div>
    <div class="comment-form">
      <input id="commentInput" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." />
      <button id="addCommentBtn">Ø£Ø¶Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
    </div>
  </div>
</div>

<div id="chapters" class="tab-content">
  <div class="search-bar">
    <input id="chapterSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„..." />
  </div>
  <div id="chaptersList" class="chapter-list"></div>
</div>
</main>

<footer>Â© 2025 Manga Sanctum | Realm of Shadows & Light</footer>

<div id="ratingModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50">
  <div style="background:#111;padding:20px;border-radius:12px;max-width:360px;width:90%;text-align:center;position:relative">
    <div style="position:absolute;top:10px;right:12px;cursor:pointer;font-size:20px" onclick="closeRatingModal()">âœ–</div>
    <div style="font-weight:700;font-size:18px;margin-bottom:12px;color:#cbb9ff">Ù‚ÙŠÙ… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</div>
    <div id="modalUserStars" class="stars-row" style="justify-content:center;margin-bottom:10px"></div>
    <div id="modalAvgStars" class="stars-row" style="justify-content:center;margin-bottom:6px"></div>
    <div id="modalAvgText" class="rating-value" style="margin-bottom:12px"></div>
    <button onclick="submitRating()" style="padding:8px 14px;border-radius:8px;border:none;background:linear-gradient(90deg,#a88bff,#e6c07b);color:#0b0710;cursor:pointer">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscXd4Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const supabase = window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const mangaId = new URLSearchParams(window.location.search).get('manga_id');

/* Ø§Ù„Ø±Ù…ÙˆØ² */
function spawnSymbols(){
  const SYMBOLS=["â˜½","âœ¦","âœ¶","â›§","â˜¥","â™†","å","âšš"];
  const c=document.getElementById('symbols'); c.innerHTML='';
  for(let i=0;i<24;i++){
    const s=document.createElement('div'); s.className='symbol';
    s.textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
    s.style.left=(Math.random()*100)+'%';
    s.style.top=(Math.random()*110)+'%';
    s.style.fontSize=(12+Math.random()*36)+'px';
    const dur=15+Math.random()*25; // Ø³Ø±Ø¹Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
    const delay=Math.random()*5;
    s.style.animationDuration=dur+'s';
    s.style.animationDelay=delay+'s';
    s.style.opacity=0.06+Math.random()*0.12;
    c.appendChild(s);
  }
}

/* Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
async function getCurrentUser(){
  try{
    const { data } = await supabase.auth.getUser();
    if(data?.user){
      const { data: profile } = await supabase.from('profiles').select('username').eq('id', data.user.id).maybeSingle();
      return { id: data.user.id, username: profile?.username || data.user.email || null, isAuth:true };
    }
  }catch(e){}
  let id = localStorage.getItem('uid');
  if(!id){ id = crypto.randomUUID(); localStorage.setItem('uid', id);}
  const name = localStorage.getItem('user_name')||null;
  return { id, username: name, isAuth:false };
}

/* Ø§Ù„Ù†Ø¬ÙˆÙ… */
function renderStars(container,value,editable=false,onSelect=null){
  container.innerHTML='';
  const full=Math.floor(value);
  const half=value-full>=0.5?1:0;
  for(let i=0;i<5;i++){
    const span=document.createElement('span'); span.textContent='â˜…';
    if(i<full) span.classList.add('full');
    else if(i===full && half) span.classList.add('half');
    if(editable){span.style.cursor='pointer';span.addEventListener('click', async ()=>{if(onSelect) await onSelect(i+1);});}
    container.appendChild(span);
    if(i<4) container.appendChild(document.createTextNode(' '));
  }
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ */
async function loadMangaInfo(){
  if(!mangaId) return;
  const { data, error } = await supabase.from('manga_list').select('title,description,cover_url,tags').eq('id', mangaId).maybeSingle();
  if(error){ console.error(error); return; }
  if(!data) return;
  document.getElementById('title').textContent=data.title||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  document.getElementById('cover').src=data.cover_url||'images/book.png';
  document.getElementById('description').textContent=data.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­';
  const tagsEl=document.getElementById('tagsContainer'); tagsEl.innerHTML='';
  if(data.tags) data.tags.split(',').map(t=>t.trim()).filter(Boolean).forEach(tag=>{
    const d=document.createElement('div'); d.className='tag'; d.textContent=tag;
    d.addEventListener('click', ()=> window.location.href=`index13.html?tag=${encodeURIComponent(tag)}`);
    tagsEl.appendChild(d);
  });
}

/* Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª */
async function loadRatings(){
  if(!mangaId) return;
  const me = await getCurrentUser();
  let userRating=0;
  if(me && me.id){
    const { data: row } = await supabase.from('manga_ratings').select('rating').eq('manga_id', mangaId).
    eq('user_id', me.id).maybeSingle();
    if(row) userRating = row.rating;
  }

  const { data: allRatings } = await supabase.from('manga_ratings').select('rating').eq('manga_id', mangaId);
  let avg = 0;
  if(allRatings && allRatings.length){
    avg = allRatings.reduce((sum,r)=>sum+r.rating,0)/allRatings.length;
  }

  renderStars(document.getElementById('userStars'), userRating, false);
  renderStars(document.getElementById('avgStars'), avg, false);
  document.getElementById('avgText').textContent = `(${allRatings?.length||0} ØªÙ‚ÙŠÙŠÙ…)`;
  renderStars(document.getElementById('modalUserStars'), userRating, true, async val=>{
    userRating = val;
    renderStars(document.getElementById('modalUserStars'), userRating, true, ()=>{});
  });
  renderStars(document.getElementById('modalAvgStars'), avg, false);
  document.getElementById('modalAvgText').textContent = `(${allRatings?.length||0} ØªÙ‚ÙŠÙŠÙ…)`;
}

/* Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„ */
async function loadChapters(){
  if(!mangaId) return;
  const { data: chapters } = await supabase.from('manga_chapters').select('id,number,title').eq('manga_id', mangaId).order('number',{ascending:true});
  const list = document.getElementById('chaptersList');
  list.innerHTML = '';
  if(!chapters) return;

  function isArabic(str){
    if(!str) return false;
    const c = str.trim().charAt(0);
    return /[\u0600-\u06FF]/.test(c);
  }

  chapters.forEach(ch=>{
    const div = document.createElement('div');
    div.className = `chapter-item ${isArabic(ch.title)?'rtl':'ltr'}`;
    const label = isArabic(ch.title) ? `Ø§Ù„ÙØµÙ„ ${ch.number}: ${ch.title}` : `Chapter ${ch.number}: ${ch.title}`;
    div.textContent = label;
    div.addEventListener('click', ()=> window.location.href=`read.html?chapter_id=${ch.id}`);
    list.appendChild(div);
  });
}

/* Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙØµÙˆÙ„ */
document.getElementById('chapterSearch').addEventListener('input', e=>{
  const val = e.target.value.toLowerCase();
  const items = document.querySelectorAll('#chaptersList .chapter-item');
  items.forEach(item=>{
    item.style.display = item.textContent.toLowerCase().includes(val)?'flex':'none';
  });
});

/* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
function openTab(tab){
  document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  if(tab==='details') document.getElementById('detailsBtn').classList.add('active');
  else document.getElementById('chaptersBtn').classList.add('active');
}

/* ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
async function loadComments(){
  const { data: comments } = await supabase.from('manga_comments').select('id,user_name,text').eq('manga_id', mangaId).order('id',{ascending:true});
  const list = document.getElementById('commentsList'); list.innerHTML='';
  if(!comments) return;
  comments.forEach(c=>{
    const div = document.createElement('div'); div.className='comment';
    div.textContent = `${c.user_name||'Ø²Ø§Ø¦Ø±'}: ${c.text}`;
    list.appendChild(div);
  });
}
document.getElementById('addCommentBtn').addEventListener('click', async ()=>{
  const inp = document.getElementById('commentInput'); const val=inp.value.trim();
  if(!val) return;
  const user = await getCurrentUser();
  await supabase.from('manga_comments').insert({manga_id:mangaId,user_name:user.username||'Ø²Ø§Ø¦Ø±',text:val});
  inp.value='';
  loadComments();
});

/* Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
function openRatingModal(){ document.getElementById('ratingModal').style.display='flex'; }
function closeRatingModal(){ document.getElementById('ratingModal').style.display='none'; }
async function submitRating(){
  const user = await getCurrentUser(); if(!user) return;
  const val = Array.from(document.getElementById('modalUserStars').children).filter(s=>s.classList.contains('full')).length;
  const { data: existing } = await supabase.from('manga_ratings').select('id').eq('manga_id',mangaId).eq('user_id',user.id).maybeSingle();
  if(existing) await supabase.from('manga_ratings').update({rating:val}).eq('id',existing.id);
  else await supabase.from('manga_ratings').insert({manga_id:mangaId,user_id:user.id,rating:val});
  closeRatingModal();
  loadRatings();
}

/* Ø¥Ø¶Ø§ÙØ§Øª */
function addToLibrary(){ alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ Ù„Ù„Ù…ÙƒØªØ¨Ø©'); }
function goToComments(){ openTab('details'); window.scrollTo({top:document.getElementById('commentsList').offsetTop-50,behavior:'smooth'}); }

/* Ø¨Ø¯Ø¡ Ø§Ù„ØµÙØ­Ø© */
spawnSymbols();
loadMangaInfo();
loadChapters();
loadComments();
loadRatings();
</script>
</body>
</html>
