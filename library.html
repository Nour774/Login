<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>المكتبة</title>
<link rel="icon" href="images/book.png"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { box-sizing: border-box; transition: 0.3s ease; }
  body { margin:0;font-family:"Cairo","Tahoma",sans-serif;background:#1a1a1d;color:#f5f5f5;overflow-x:hidden; }
  header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#0f0e14;border-bottom:1px solid rgba(255,255,255,0.05);}
  .menu-btn{cursor:pointer;font-size:24px;}
  .profile-pic{width:40px;height:40px;border-radius:50%;}
  .sub-header{display:flex;gap:16px;padding:10px 20px;background:#2a2a2d;}
  .sub-header a{color:#f5f5f5;text-decoration:none;font-weight:bold;cursor:pointer;}
  .hero img{width:100%;max-height:300px;object-fit:cover;}
  .content{padding:20px;}
  .sidebar{position:fixed;top:0;right:-250px;width:250px;height:100%;background:#333;padding:20px;transition:right 0.3s ease;z-index:1000;}
  .sidebar.active{right:0;}
  .sidebar a,.sidebar button{display:block;margin-bottom:10px;color:#fff;background:none;border:none;font-size:16px;cursor:pointer;text-align:right;}
  .overlay{position:fixed;top:0;right:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;z-index:999;}
  .overlay.active{display:block;}
  .section{display:none;padding:20px;}
  .section.active{display:block;}
  .logo{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
  .logo div:first-child{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#a88bff,#e6c07b);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0b0710;font-size:18px;}
  .logo .title{font-weight:700;font-size:18px;}
  nav{display:flex;gap:16px;margin-bottom:10px;}
  nav button{padding:6px 12px;border:none;border-radius:8px;background:transparent;color:#9b8fb3;cursor:pointer;font-weight:700;}
  nav button.active{color:#fff;background:rgba(168,139,255,0.12);}
  .panel{display:none;}
  .panel.active{display:block;}
  .hint{margin-top:12px;color:#9b8fb3;}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-top:18px;}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px;align-items:stretch;}
  .ext-card{display:flex;gap:10px;align-items:flex-start;cursor:pointer;}
  .ext-thumb{width:72px;height:100px;border-radius:8px;object-fit:cover;flex-shrink:0;background:#111;border:1px solid rgba(255,255,255,0.03);}
  .ext-body{flex:1;display:flex;flex-direction:column;gap:6px;}
  .ext-title{font-weight:800;font-size:15px;}
  .ext-meta{color:#9b8fb3;font-size:13px;}
  .btn{padding:8px 10px;border-radius:8px;border:0;cursor:pointer;background:#7b5cff;color:#fff;font-weight:700;}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:#fff;}
  .small{font-size:13px;color:#9b8fb3;}
  .muted{color:#9b8fb3;}
  .repo-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
  .repo-tab{padding:6px 10px;border-radius:8px;cursor:pointer;background:transparent;color:#9b8fb3;font-weight:700;}
  .repo-tab.active{background:rgba(168,139,255,0.08);color:#fff;}
  @media (max-width:700px){.ext-thumb{width:60px;height:84px}.grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}}
</style>
</head>
<body>
<header>
<span class="menu-btn" onclick="toggleMenu()">☰</span>
<h1>المكتبة</h1>
<img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="بروفايل">
</header>

<div class="sub-header">
<a href="index5.html">الرئيسية</a>
<a onclick="showSection('library')">مكتبتي</a>
<a onclick="showSection('repository')">المانجا/المانهوا</a>
<a onclick="showSection('settings')">الروايات</a>
</div>

<div class="hero"><img src="images/imag1.jpg" alt="صورة المقدمة"></div>

<div id="library" class="section active"><div class="content"><div id="welcome" class="welcome">جار التحميل...</div></div></div>

<div id="repository" class="section">
<div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div>

<div class="repo-tabs" id="repoTabs"></div>

<nav>
<button id="tabSources" class="active" onclick="switchPanel('sources')">المصادر</button>
<button id="tabExtensions" onclick="switchPanel('extensions')">الإضافات</button>
</nav>

<div id="panelSources" class="panel active">
<div class="hint">المصادر المستوردة ستظهر هنا. اضغط على "استيراد كمصدر" من أي إضافة.</div>
<div id="sourcesGrid" class="grid" aria-live="polite"></div>
</div>

<div id="panelExtensions" class="panel">
<div class="hint">اختر تبويب مستودع أعلى لتحميل الإضافات.</div>
<div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
<input id="repoUrlInput" class="input" placeholder="لصق رابط JSON لمستودع"/>
<button class="btn" onclick="addRepoFromInput()">أضف مستودع</button>
<button class="btn" onclick="loadPrepopulated()">تحميل المستودعات المضمّنة</button>
</div>
<div style="margin-top:10px">
<textarea id="repoPaste" rows="5" style="width:100%;border-radius:8px;padding:8px;background:#0f0f12;color:#fff" placeholder='أو ألصق JSON هنا'></textarea>
<div style="margin-top:8px;display:flex;gap:8px">
<button class="btn" onclick="importFromPaste()">استيراد من النص</button>
<button class="btn btn-ghost" onclick="clearRepos()">مسح المستودعات</button>
</div>
</div>
<div id="extensionsContainer" style="margin-top:14px">
<div id="extensionsGrid" class="grid"></div>
</div>
</div>
</div>

<div id="settings" class="section"><p>الروايات ستظهر هنا لاحقًا.</p></div>

<div class="sidebar" id="sidebar">
<a href="#" onclick="goToMembers()">الأعضاء</a>
<button id="adminBtn" onclick="goToAdmin()" style="display:none;">لوحة التحكم</button>
<button onclick="logout()">تسجيل الخروج</button>
</div>
<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<script>
const supabaseUrl="https://dxpqkojigblqgwqxwbmg.supabase.co";
const supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const supabaseClient = (typeof window.supabase!=='undefined'&&supabase.createClient)?supabase.createClient(supabaseUrl,supabaseKey):null;

async function loadUser(){
  try{
    if(!supabaseClient) throw new Error('Supabase SDK غير متاح');
    const {data,error}=await supabaseClient.auth.getUser();
    if(error||!data.user) return window.location.href="index.html";
    const {data:profile} = await supabaseClient.from("profiles").select("username, role, avatar_url").eq("id",data.user.id).single();
    document.getElementById("welcome").textContent=`مرحباً بك، ${profile?.username||"مستخدم"} 👋`;
    if(profile?.avatar_url) document.getElementById("profileImage").src=profile.avatar_url;
    if(['admin','owner'].includes((profile?.role||"").toLowerCase())) document.getElementById("adminBtn").style.display="block";
  }catch(e){console.warn(e);document.getElementById("welcome").textContent="مرحباً بك، زائر — (Supabase غير متاح حالياً).";}
}
loadUser();

function toggleMenu(){document.getElementById("sidebar").classList.toggle("active");document.getElementById("overlay").classList.toggle("active");}
function logout(){if(supabaseClient?.auth?.signOut) supabaseClient.auth.signOut().then(()=>location.href='index.html').catch(()=>location.href='index.html'); else location.href='index.html';}
function goToMembers(){location.href='index3.html'}
function goToAdmin(){location.href='index5.html'}
function showSection(id){document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='repository') switchPanel('extensions');}

const state={repos:[],currentRepoIndex:null,sources:[]};
const PREPOPULATED_REPOS=[
{name:"Keiyoushi",url:"https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json"},
{name:"ThePBone (revived)",url:"https://raw.githubusercontent.com/ThePBone/tachiyomi-extensions-revived/repo/index.min.json"},
{name:"Mihon (chaerun)",url:"https://raw.githubusercontent.com/chaerun/mihon-extensions/repo/index.min.json"},
{name:"Kaciin (examples)",url:"https://raw.githubusercontent.com/kaciin/tachiyomi-extensions-source/repo/index.min.json"}];

function renderRepoTabs(){
  const tabs=document.getElementById('repoTabs'); tabs.innerHTML='';
  state.repos.forEach((r,idx)=>{
    const el=document.createElement('button');
    el.className='repo-tab'+(state.currentRepoIndex===idx?' active':'');
    el.textContent=r.name||`repo ${idx+1}`;
    el.onclick=()=>selectRepo(idx);
    tabs.appendChild(el);
  });
  if(state.repos.length===0){ const hint=document.createElement('div'); hint.className='small muted'; hint.style.marginTop='8px'; hint.textContent='لم يتم إضافة مستودعات.'; tabs.appendChild(hint);}
}

function selectRepo(idx){state.currentRepoIndex=idx; renderRepoTabs(); if(!state.repos[idx].loaded) fetchRepo(idx); else renderExtensionsGrid(state.repos[idx].items||[]);}

async function fetchRepo(idx){
  const repo=state.repos[idx]; if(!repo) return; setDetails(`جاري جلب: ${repo.url}`);
  try{
    const res=await fetch(repo.url); if(!res.ok) throw new Error('HTTP '+res.status);
    const json=await res.json(); let extensions=[];
    if(Array.isArray(json)){json.forEach(it=>extensions.push(normalizeExtension(it))); }
    else if(json.repositories){json.repositories.forEach(it=>extensions.push(normalizeExtension(it))); }
    else if(json.extensions){json.extensions.forEach(it=>extensions.push(normalizeExtension(it))); }
    else if(json.sources){json.sources.forEach(it=>extensions.push(normalizeExtension(it))); }
    else { extensions.push({title:repo.name||repo.url, raw:json}); }
    repo.items=extensions; repo.loaded=true; renderRepoTabs(); if(state.currentRepoIndex===idx) renderExtensionsGrid(extensions);
    setDetails(`تم تحميل المستودع: ${repo.name} — ${extensions.length} عناصر.`);
  }catch(err){console.error(err); repo.loaded=false; setDetails(`فشل تحميل repo: ${repo.url} — ${err.message}`); alert(`فشل جلب المستودع (${repo.name}): ${err.message}`);}
}

function normalizeExtension(it){const title=it.title||it.name||'إضافة'; const lang=it.lang||it.language||''; const description=it.description||it.desc||''; const icon=it.icon||it.logo||it.image||it.cover||null; const url=it.url||it.repo||it.index||null; return {title,lang,description,icon,url,raw:it};}

function renderExtensionsGrid(items){
  const grid=document.getElementById('extensionsGrid'); grid.innerHTML='';
  if(!items||items.length===0){grid.innerHTML='<div class="muted">لا توجد إضافات.</div>'; return;}
  items.forEach((ex,i)=>{
    const card=document.createElement('div'); card.className='card';
    const thumbUrl=ex.icon||placeholderThumb(ex.title);
    card.innerHTML=`<div class="ext-card">
      <img class="ext-thumb" src="${escapeHtml(thumbUrl)}" onerror="this.src='${placeholderThumb(ex.title)}'"/>
      <div class="ext-body">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><div class="ext-title">${escapeHtml(ex.title)}</div><div class="ext-meta">${escapeHtml(ex.lang||'')}</div></div>
          <div style="text-align:left"><button class="btn" onclick="importAsSource(${state.currentRepoIndex},${i})">استيراد كمصدر</button></div>
        </div>
        <div class="small muted" style="margin-top:6px">${escapeHtml(shorten(ex.description||'لا وصف متاح'))}</div>
        <div class="small muted" style="margin-top:8px">رابط: ${escapeHtml(ex.url||'—')}</div>
      </div>
    </div>`; grid.appendChild(card);
  });
}

function importAsSource(repoIdx,extIdx){
  const repo=state.repos[repoIdx]; if(!repo||!repo.items||!repo.items[extIdx]) return; const ex=repo.items[extIdx];
  const sourceObj={name:ex.title||'مصدر',url:ex.url||repo.url,raw:ex.raw||null};
  if(state.sources.some(s=>(s.url===sourceObj.url)||(s.name===sourceObj.name))){alert('هذا المصدر موجود بالفعل');return;}
  state.sources.push(sourceObj); renderSourcesGrid(); switchPanel('sources'); setDetails(`استوردت: ${sourceObj.name}`);
}

function renderSourcesGrid(){const grid=document.getElementById('sourcesGrid'); grid.innerHTML=''; if(state.sources.length===0){grid.innerHTML='<div class="muted">لم تقم باستيراد أي مصدر بعد.</div>';return;} state.sources.forEach((s,idx)=>{ const d=document.createElement('div'); d.className='card'; d.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
  <div><div style="font-weight:800">${escapeHtml(s.name)}</div><div class="small muted" style="margin-top:6px">${escapeHtml(s.url)}</div></div>
  <div style="display:flex;gap:8px">
    <button class="btn" onclick="openSource(${idx})">افتح المصدر</button>
    <button class="btn" style="background:#c94a4a" onclick="removeSource(${idx})">حذف</button>
  </div>
</div>`;grid.appendChild(d);});}

function openSource(idx){const s=state.sources[idx];if(!s)return; setDetails(`فتح المصدر: ${s.name}`); alert('فتح المصدر متاح لاحقاً عند إضافة مانجا');}

function addRepoFromInput(){const url=(document.getElementById('repoUrlInput').value||'').trim(); if(!url)return alert('أدخل رابط JSON'); const name=url.split('/').slice(-2,-1)[0]||url; state.repos.push({name,url,loaded:false,items:[]}); document.getElementById('repoUrlInput').value=''; renderRepoTabs(); selectRepo(state.repos.length-1);}
function loadPrepopulated(){PREPOPULATED_REPOS.forEach(r=>state.repos.push({name:r.name,url:r.url,loaded:false,items:[]})); renderRepoTabs(); if(state.repos.length>0) selectRepo(0);}
function importFromPaste(){const txt=document.getElementById('repoPaste').value.trim();if(!txt)return alert('ألصق JSON أولاً'); try{const json=JSON.parse(txt); if(Array.isArray(json)){json.forEach(it=>{ if(it && (it.url||it.name)) state.repos.push({name: it.name||it.title||'repo', url: it.url||it.repo||it.index, loaded:false, items:[]}); else state.repos.push({name:'repo-pasted', url:'', loaded:true, items:[normalizeExtension(it)]}); });} else if(json.name&&json.url){state.repos.push({name:json.name,url:json.url,loaded:false,items:[]});} else {state.repos.push({name:'repo-pasted',url:'(pasted)',loaded:true,items:Array.isArray(json)?json:[json]});} document.getElementById('repoPaste').value=''; renderRepoTabs(); selectRepo(state.repos.length-1);}catch(e){alert('JSON غير صالح');console.error(e);}}
function clearRepos(){state.repos=[];state.currentRepoIndex=null;renderRepoTabs();renderExtensionsGrid([]);}
function switchPanel(name){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById('panel'+capitalize(name)).classList.add('active');document.getElementById('tabSources').classList.toggle('active',name==='sources');document.getElementById('tabExtensions').classList.toggle('active',name==='extensions');}
function capitalize(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function setDetails(msg){console.log(msg);}
function escapeHtml(str){return str.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function shorten(str,len=100){return str.length>len?str.slice(0,len)+'…':str;}
function placeholderThumb(title){return 'https://via.placeholder.com/72x100.png?text='+encodeURIComponent(title||'؟');}
</script>
</body>
</html>
