<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>لوحة التحكم</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
body { font-family:"Tahoma",sans-serif; background:#1e1e2f; color:white; margin:0; padding:20px; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #444; padding:8px; text-align:center; font-size:14px; }
th { background:#2a2a3d; }
button { padding:5px 8px; margin:2px; border:none; border-radius:5px; cursor:pointer; font-size:13px; }
.badge { padding:4px 8px; border-radius:6px; background:#34495e; display:inline-block; }
</style>
</head>
<body>
<h1>لوحة التحكم</h1>
<input type="text" id="searchInput" placeholder="ابحث باسم المستخدم أو البريد..." autocomplete="off">
<table id="usersTable">
<thead>
<tr>
<th>الاسم</th><th>البريد</th><th>الحالة</th><th>الدور</th><th>الإجراءات</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentUserRole = "";

// ✅ init بعد تحميل DOM
document.addEventListener("DOMContentLoaded", init);

async function init() {
    const { data: { session }, error } = await supabase.auth.getSession();
    if(error || !session) {
        alert("لم يتم تسجيل الدخول. إعادة التوجيه...");
        window.location.href = "index5.html";
        return;
    }
    currentUserId = session.user.id;

    const { data: profile, error: profileErr } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', currentUserId)
        .single();

    if(profileErr || !profile) {
        alert("لم يتم العثور على المستخدم. إعادة التوجيه...");
        window.location.href = "index5.html";
        return;
    }

    currentUserRole = (profile.role || "user").toLowerCase();
    if(currentUserRole === "user") {
        alert("ليس لديك صلاحية الدخول!");
        window.location.href = "index5.html";
        return;
    }

    fetchAndRenderUsers();
}

async function fetchAndRenderUsers() {
    const { data: users, error } = await supabase.from('profiles').select('*').order('username');
    if(error || !users) { console.error(error); return; }

    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";
    users.forEach(u=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${u.username || ""}${u.id===currentUserId ? " ⇽ أنت" : ""}</td>
            <td>${u.email || ""}</td>
            <td>${u.status || "active"}</td>
            <td>${u.role || "user"}</td>
            <td>${getActionButtons(currentUserRole,u)}</td>
        `;
        tbody.appendChild(tr);
    });
}

function getActionButtons(role,user){
    if(user.id===currentUserId) return `<span class="badge">أنت (${role})</span>`;
    if(role==="owner" || (role==="admin" && user.role==="user")) {
        return `<button onclick="alert('إجراء')">إجراء</button>`;
    }
    return `<span class="badge">---</span>`;
}
</script>
</body>
</html>
