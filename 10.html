<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>Manga Sanctum - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="images/book.png" />
<style>
*{box-sizing:border-box;transition:0.25s}
body{
  margin:0;font-family:"Cairo",sans-serif;
  background:radial-gradient(circle at 50% 10%,#0b0b10,#050505 90%);
  color:#eaeaea;min-height:100vh;overflow-x:hidden;position:relative;
}

/* --- Ø§Ù„Ø¶Ø¨Ø§Ø¨ --- */
.fog{
  position:fixed;top:0;left:0;width:200%;height:200%;
  background:url('images/fog.png') repeat;opacity:0.15;
  animation:fogMove 120s linear infinite;z-index:0;
  pointer-events:none;transform:translate(-25%,-25%);
}
@keyframes fogMove{
  0%{background-position:0 0}
  50%{background-position:1000px 800px}
  100%{background-position:0 0}
}

/* --- Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© --- */
.symbols{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1;overflow:hidden}
.symbol{
  position:absolute;color:rgba(168,139,255,0.12);
  font-size:22px;animation-name:floatSymbol,glowSymbol;
  animation-timing-function:linear;
  animation-iteration-count:infinite;user-select:none;
}
@keyframes floatSymbol{
  0%{transform:translateY(100vh) rotate(0deg);opacity:0}
  10%{opacity:1}
  90%{opacity:1}
  100%{transform:translateY(-20vh) rotate(360deg);opacity:0}
}
@keyframes glowSymbol{
  0%,100%{opacity:0.1}
  50%{opacity:0.35}
}

/* --- Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ø§Ù… --- */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;background:rgba(10,10,15,0.85);
  backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,0.05);
  position:sticky;top:0;z-index:10;
}
.left-section{display:flex;align-items:center;gap:10px}
.back-btn{color:#eaeaea;font-size:20px;cursor:pointer;padding:8px 14px;border-radius:8px;background:rgba(255,255,255,0.05)}
.back-btn:hover{background:rgba(255,255,255,0.12)}
.logo-text{font-weight:800;font-size:26px;color:#d4c3ff;letter-spacing:1px;filter:drop-shadow(0 0 10px rgba(168,139,255,0.7));user-select:none}
.logo-box{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#a88bff,#e6c07b);display:flex;align-items:center;justify-content:center;font-weight:900;color:#0b0710;font-size:21px;box-shadow:0 0 10px rgba(168,139,255,0.5)}
main{padding:20px;position:relative;z-index:5}
.manga-header{display:flex;flex-direction:column;align-items:center;text-align:center;padding:40px 20px 12px;position:relative}
.manga-header::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at center, rgba(168,139,255,0.06), transparent 70%);z-index:1}
.cover{width:220px;height:310px;object-fit:cover;border-radius:14px;box-shadow:0 0 50px rgba(168,139,255,0.35);z-index:2;position:relative}
.manga-title{font-size:30px;font-weight:800;margin-top:14px;background:linear-gradient(90deg,#a88bff,#e6c07b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 10px rgba(168,139,255,0.5);z-index:2;position:relative}
.tabs{display:flex;gap:10px;justify-content:center;margin-top:18px}
.tabs button{background:rgba(168,139,255,0.1);border:1px solid rgba(168,139,255,0.3);color:#cbb9ff;padding:10px 18px;border-radius:8px;cursor:pointer}
.tabs button.active{background:rgba(168,139,255,0.3)}
.tab-content{display:none;margin-top:16px}
.tab-content.active{display:block}
.manga-description{max-width:900px;margin:14px auto;color:#bdb3d6;font-size:16px;line-height:1.8;text-align:center}
.tags-container{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.tag{background:rgba(168,139,255,0.1);border:1px solid rgba(168,139,255,0.3);color:#cbb9ff;padding:6px 14px;border-radius:20px;font-size:14px;cursor:pointer}
.tag:hover{background:rgba(168,139,255,0.25);color:#fff;transform:scale(1.05)}
footer{padding:18px;text-align:center;color:#666;font-size:13px;margin-top:30px}

/* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª --- */
.icon-bar{display:flex;justify-content:center;gap:40px;margin-bottom:20px;margin-top:20px}
.icon-item{text-align:center;cursor:pointer;transition:0.3s}
.icon-item div:first-child{font-size:30px;transition:0.3s}
.icon-item:hover div:first-child{transform:scale(1.3);filter:drop-shadow(0 0 10px #a88bff)}
.icon-item:hover div:last-child{color:#fff}

/* --- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´ÙƒØ± (Fade + Slide up) --- */
.thank-message {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(0);
  background: linear-gradient(90deg, #a88bff, #e6c07b);
  color: #0b0710;
  padding: 10px 22px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 14px;
  box-shadow: 0 0 14px rgba(168, 139, 255, 0.6);
  opacity: 0;
  transition: opacity 0.6s ease, transform 0.6s ease;
  z-index: 100;
}
.thank-message.show {
  opacity: 1;
  transform: translateX(-50%) translateY(-10px);
}
</style>
</head>
<body>
<div class="fog"></div>
<div class="symbols" id="symbols"></div>

<header>
  <div class="left-section">
    <div class="back-btn" onclick="history.back()">â®Œ Ø¹ÙˆØ¯Ø©</div>
    <div class="logo-text">Manga Sanctum</div>
  </div>
  <div class="logo-box">MS</div>
</header>

<main>
<section class="manga-header">
  <img id="cover" class="cover" src="" alt="ØºÙ„Ø§Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§">
  <div id="title" class="manga-title">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</section>

<div class="tabs">
  <button id="detailsBtn" class="active" onclick="openTab('details')">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
  <button id="chaptersBtn" onclick="openTab('chapters')">Ø§Ù„ÙØµÙˆÙ„</button>
</div>

<!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
<div id="details" class="tab-content active">
  <div class="icon-bar">
    <div class="icon-item" onclick="goToComments()">
      <div style="color:#a88bff">ğŸ’¬</div>
      <div style="color:#cbb9ff;font-size:14px;margin-top:4px">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
    </div>
    <div class="icon-item" onclick="addToLibrary()">
      <div style="color:#e6c07b">â•</div>
      <div style="color:#cbb9ff;font-size:14px;margin-top:4px">Ø£Ø¶Ù Ù„Ù„Ù…ÙƒØªØ¨Ø©</div>
    </div>
    <div class="icon-item" onclick="openRatingModal()">
      <div style="color:#FFD700">â­</div>
      <div style="color:#cbb9ff;font-size:14px;margin-top:4px">ØªÙ‚ÙŠÙŠÙ…Ùƒ</div>
    </div>
  </div>

  <div id="description" class="manga-description">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.</div>
  <div id="tagsContainer" class="tags-container"></div>
</div>

<!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙØµÙˆÙ„ -->
<div id="chapters" class="tab-content">
  <div class="search-bar">
    <input id="chapterSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„..." />
  </div>
  <div id="chaptersList" class="chapter-list"></div>
</div>
</main>

<footer>Â© 2025 Manga Sanctum | Realm of Shadows & Light</footer>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="ratingModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:50">
  <div style="background:#111;padding:20px;border-radius:12px;max-width:360px;width:90%;text-align:center;position:relative">
    <div style="position:absolute;top:10px;right:12px;cursor:pointer;font-size:20px" onclick="closeRatingModal()">âœ–</div>
    <div style="font-weight:700;font-size:18px;margin-bottom:12px;color:#cbb9ff">Ù‚ÙŠÙ… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</div>
    <div id="modalUserStars" class="stars-row" style="justify-content:center;margin-bottom:10px"></div>
    <button onclick="submitRating()" style="padding:8px 14px;border-radius:8px;border:none;background:linear-gradient(90deg,#a88bff,#e6c07b);color:#0b0710;cursor:pointer">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
  </div>
</div>

<div id="thankMsg" class="thank-message">â­ ØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­!</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL="https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const mangaId=new URLSearchParams(window.location.search).get('manga_id');

/* --- Ø§Ù„Ø±Ù…ÙˆØ² --- */
function spawnSymbols(){
  const SYMBOLS=["â˜½","âœ¦","âœ¶","â›§","â˜¥","â™†","å","âšš"];
  const c=document.getElementById('symbols'); c.innerHTML='';
  for(let i=0;i<20;i++){
    const s=document.createElement('div'); s.className='symbol';
    s.textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
    s.style.left=(Math.random()*100)+'%'; s.style.top=(Math.random()*110)+'%';
    s.style.fontSize=(14+Math.random()*30)+'px';
    s.style.animationDuration=(20+Math.random()*20)+'s';
    s.style.animationDelay=(Math.random()*5)+'s';
    c.appendChild(s);
  }
}

/* --- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… --- */
function renderStars(container,value,editable=false,onSelect=null){
  container.innerHTML='';
  const full=Math.floor(value);
  for(let i=0;i<5;i++){
    const s=document.createElement('span'); s.textContent='â˜…';
    s.style.cursor='pointer'; s.style.fontSize='32px';
    s.style.color=i<full?'#FFD700':'#444';
    s.addEventListener('click',()=>{
      if(editable){
        value=i+1;if(onSelect)onSelect(value);
        renderStars(container,value,editable,onSelect);
      }
    });
    container.appendChild(s);
  }
}

async function getCurrentUser(){
  const {data}=await supabase.auth.getUser();
  if(data?.user) return {id:data.user.id,isAuth:true};
  let id=localStorage.getItem('uid');
  if(!id){id=crypto.randomUUID();localStorage.setItem('uid',id);}
  return {id,isAuth:false};
}

function openRatingModal(){document.getElementById('ratingModal').style.display='flex';loadModalStars();}
function closeRatingModal(){document.getElementById('ratingModal').style.display='none';}

async function loadModalStars(){
  const me=await getCurrentUser();
  const {data:row}=await supabase.from('manga_ratings').select('rating').eq('manga_id',mangaId).eq('user_id',me.id).maybeSingle();
  const rating=row?.rating||0;
  renderStars(document.getElementById('modalUserStars'),rating,true,val=>window.modalSelectedRating=val);
}

async function submitRating(){
  const me=await getCurrentUser();
  if(!window.modalSelectedRating)return;
  await supabase.from('manga_ratings').upsert({manga_id:parseInt(mangaId),user_id:me.id,rating:window.modalSelectedRating},{onConflict:['manga_id','user_id']});
  closeRatingModal();
  showThankMessage();
}

function showThankMessage(){
  const msg=document.getElementById('thankMsg');
  msg.classList.add('show');
  setTimeout(()=>msg.classList.remove('show'),3000);
}

/* --- ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ --- */
async function loadMangaInfo(){
  const {data}=await supabase.from('manga_list').select('title,description,cover_url,tags').eq('id',mangaId).maybeSingle();
  if(!data)return;
  document.getElementById('title').textContent=data.title;
  document.getElementById('cover').src=data.cover_url||'images/book.png';
  document.getElementById('description').textContent=data.description||'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.';
  const t=document.getElementById('tagsContainer');t.innerHTML='';
  if(data.tags)data.tags.split(',').forEach(tag=>{
    const d=document.createElement('div');d.className='tag';d.textContent=tag.trim();
    t.appendChild(d);
  });
}

async function addToLibrary(){
  const me=await getCurrentUser();
  await supabase.from('library').upsert({manga_id:parseInt(mangaId),user_id:me.id},{onConflict:['manga_id','user_id']});
  showThankMessage();
}

function goToComments(){window.location.href=`comments.html?manga_id=${mangaId}`;}
function openTab(tab){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tab+'Btn').classList.add('active');
}

spawnSymbols();
loadMangaInfo();
</script>
</body>
</html>
