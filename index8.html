<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>📖 قراءة المانجا</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { margin:0; font-family:'Cairo',sans-serif; background:#111; color:#eee; text-align:center; }
    .back-btn, .nav-btn { padding:10px 18px; margin:6px; font-size:1rem; background:linear-gradient(90deg,#800,#b00); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold; }
    .back-btn:hover, .nav-btn:hover { background:linear-gradient(90deg,#b00,#e00); transform:scale(1.05); }
    img.manga-page { display:block; width:100%; margin:0; padding:0; }
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">← العودة لقائمة الفصول</button>
  <h2 id="chapterTitle">جارٍ التحميل...</h2>
  <div id="pagesContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: { persistSession:true, autoRefreshToken:true }
    });

    function getNum(str=""){ const m=str.match(/\d+/); return m?parseInt(m[0]):0; }
    const urlParams = new URLSearchParams(window.location.search);
    const mangaId = urlParams.get('manga_id');

    async function checkUser() {
      const { data: { session } } = await supabase.auth.getSession();
      if(!session) location.href='index.html';
      return session.user.id;
    }

    async function loadChapters() {
      const userId = await checkUser();
      const { data: chapters, error } = await supabase.from('chapters').select('id, title, number').eq('manga_id', mangaId).order('number');
      if(error) return console.error(error);

      const container = document.getElementById('pagesContainer');
      container.innerHTML='';
      chapters.forEach(ch => {
        const btn = document.createElement('button');
        btn.className='nav-btn';
        btn.textContent=`الفصل ${ch.number} — ${ch.title}`;
        btn.onclick=()=> loadPages(ch.id, ch.number, ch.title);
        container.appendChild(btn);
      });
    }

    async function loadPages(chapterId, number, title) {
      const { data: pages, error } = await supabase.from('pages').select('image_url').eq('chapter_id', chapterId);
      if(error) return console.error(error);

      document.getElementById('chapterTitle').textContent = `📖 الفصل ${number} — ${title}`;
      const container = document.getElementById('pagesContainer');
      container.innerHTML='';
      pages.sort((a,b)=>getNum(a.image_url)-getNum(b.image_url)).forEach(p=>{
        const img = document.createElement('img');
        img.src=p.image_url;
        img.className='manga-page';
        container.appendChild(img);
      });
    }

    loadChapters();
  </script>
</body>
</html>
