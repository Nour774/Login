<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…ÙƒØªØ¨Ø©</title>
  <link rel="icon" href="images/book.png"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* --- Ù†Ø³Ù‚Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡ --- */
    * { box-sizing: border-box; transition: 0.3s ease; }
    body { margin: 0; font-family: "Cairo", "Tahoma", sans-serif; background: #1a1a1d; color: #f5f5f5; overflow-x: hidden; }
    header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #0f0e14; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-btn { cursor: pointer; font-size: 24px; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; }
    .sub-header { display: flex; gap: 16px; padding: 10px 20px; background: #2a2a2d; }
    .sub-header a { color: #f5f5f5; text-decoration: none; font-weight: bold; cursor: pointer; }
    .hero img { width: 100%; max-height: 300px; object-fit: cover; }
    .content { padding: 20px; }
    .sidebar { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background: #333; padding: 20px; transition: right 0.3s ease; z-index: 1000; }
    .sidebar.active { right: 0; }
    .sidebar a, .sidebar button { display: block; margin-bottom: 10px; color: #fff; background: none; border: none; font-size: 16px; cursor: pointer; text-align: right; }
    .overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
    .overlay.active { display: block; }
    .section { display: none; padding: 20px; }
    .section.active { display: block; }
    .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .logo div:first-child { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #a88bff, #e6c07b); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #0b0710; font-size: 18px; }
    .logo .title { font-weight: 700; font-size: 18px; }
    nav { display: flex; gap: 16px; margin-bottom: 10px; }
    nav button { padding: 6px 12px; border: none; border-radius: 8px; background: transparent; color: #9b8fb3; cursor: pointer; font-weight: 700; }
    nav button.active { color: #fff; background: rgba(168,139,255,0.12); }
    .panel { display: none; }
    .panel.active { display: block; }
    .hint { margin-top: 12px; color: #9b8fb3; }
    /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø«Ù„ ØªØ§Ø´ÙŠÙˆÙ…ÙŠ ÙˆÙ„ÙƒÙ† Ø­Ø³Ø¨ Ø³ØªØ§ÙŠÙ„Ùƒ */
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 14px; margin-top: 18px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
    /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø´Ø¨ÙŠÙ‡ Ø¨ØªØ§Ø´ÙŠÙˆÙ…ÙŠ */
    .ext-card { display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
    .ext-thumb { width:72px; height:100px; border-radius:8px; object-fit:cover; flex-shrink:0; background:#111; border:1px solid rgba(255,255,255,0.03) }
    .ext-body { flex:1; display:flex; flex-direction:column; gap:6px }
    .ext-title { font-weight:800; font-size:15px }
    .ext-meta { color:#9b8fb3; font-size:13px }
    .btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#7b5cff; color:#fff; font-weight:700 }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.05); color:#fff }
    .small { font-size:13px; color:#9b8fb3 }
    .muted { color:#9b8fb3 }
    .repo-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .repo-tab { padding:6px 10px; border-radius:8px; cursor:pointer; background:transparent; color:#9b8fb3; font-weight:700 }
    .repo-tab.active { background:rgba(168,139,255,0.08); color:#fff }
    @media (max-width:700px){ .ext-thumb{width:60px;height:84px} .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
  </style>
</head>
<body>
  <header>
    <span class="menu-btn" onclick="toggleMenu()">â˜°</span>
    <h1>Ø§Ù„Ù…ÙƒØªØ¨Ø©</h1>
    <img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="Ø¨Ø±ÙˆÙØ§ÙŠÙ„">
  </header>

  <div class="sub-header">
    <a href="index5.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a onclick="showSection('library')">Ù…ÙƒØªØ¨ØªÙŠ</a>
    <a onclick="showSection('repository')">Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§</a>
    <a onclick="showSection('settings')">Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª</a>
  </div>

  <div class="hero"><img src="images/imag1.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©"></div>

  <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
  <div id="library" class="section active">
    <div class="content">
      <div id="welcome" class="welcome">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <!-- ======= Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ (Ø§Ù„Ù…ÙØ­Ø¯Ù‘Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) ======= -->
  <div id="repository" class="section">
    <div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª -->
    <div class="repo-tabs" id="repoTabs"></div>

    <nav>
      <button id="tabSources" class="active" onclick="switchPanel('sources')">Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
      <button id="tabExtensions" onclick="switchPanel('extensions')">Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</button>
    </nav>

    <div id="panelSources" class="panel active">
      <div class="hint">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ…ØµØ¯Ø±" Ù…Ù† Ø£ÙŠ Ø¥Ø¶Ø§ÙØ© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.</div>
      <div id="sourcesGrid" class="grid" aria-live="polite"></div>
    </div>

    <div id="panelExtensions" class="panel" style="display:none">
      <div class="hint">Ø§Ø®ØªØ± ØªØ¨ÙˆÙŠØ¨ Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ø¹Ù„Ù‰ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª. Ø¥Ø°Ø§ Ø¸Ù‡Ø± ØªØ­Ø°ÙŠØ± CORSØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.</div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="repoUrlInput" class="input" placeholder="Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· JSON Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (raw GitHub)"/>
        <button class="btn" onclick="addRepoFromInput()">Ø£Ø¶Ù Ù…Ø³ØªÙˆØ¯Ø¹</button>
        <button class="btn" onclick="loadPrepopulated()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©</button>
      </div>

      <div style="margin-top:10px">
        <textarea id="repoPaste" rows="5" style="width:100%;border-radius:8px;padding:8px;background:#0f0f12;color:#fff" placeholder='Ø£Ùˆ Ø£Ù„ØµÙ‚ JSON Ù‡Ù†Ø§ (Ù…ØµÙÙˆÙØ© Ø£Ùˆ ÙƒØ§Ø¦Ù† repository).'></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" onclick="importFromPaste()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„Ù†Øµ</button>
          <button class="btn btn-ghost" onclick="clearRepos()">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</button>
        </div>
      </div>

      <div id="extensionsContainer" style="margin-top:14px">
        <div id="extensionsGrid" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="settings" class="section">
    <p>Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="#" onclick="goToMembers()">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
    <button id="adminBtn" onclick="goToAdmin()" style="display:none;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <script>
    /****************** Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…) ******************/
    const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";

    // Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù…Ø§ÙŠØ§Øª Ù„Ø¹Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ Ø§Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    const supabaseClient = (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function')
      ? window.supabase.createClient(supabaseUrl, supabaseKey)
      : (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function')
        ? supabase.createClient(supabaseUrl, supabaseKey)
        : null;

    async function loadUser() {
      try {
        if(!supabaseClient) throw new Error('Supabase SDK ØºÙŠØ± Ù…ØªØ§Ø­');
        const { data, error } = await supabaseClient.auth.getUser();
        if (error || !data.user) return window.location.href = "index.html";
        const { data: profile } = await supabaseClient.from("profiles").select("username, role, avatar_url").eq("id", data.user.id).single();
        document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${profile?.username || "Ù…Ø³ØªØ®Ø¯Ù…"} ğŸ‘‹`;
        if (profile?.avatar_url) document.getElementById("profileImage").src = profile.avatar_url;
        if ([(profile?.role||"")].some(r => String(r).toLowerCase() === 'admin' || String(r).toLowerCase() === 'owner')) {
          document.getElementById("adminBtn").style.display = "block";
        }
      } catch(e) {
        // Ù„Ùˆ Supabase ÙØ´Ù„ Ù„Ø£ÙŠ Ø³Ø¨Ø¨ØŒ Ù†Ø³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        console.warn(e);
        document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ Ø²Ø§Ø¦Ø± â€” (Supabase ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹).`;
      }
    }
    loadUser();

    /****************** ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø© ******************/
    function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); document.getElementById("overlay").classList.toggle("active"); }
    function logout() {
      if(supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.signOut === 'function'){
        supabaseClient.auth.signOut().then(()=> location.href='index.html').catch(()=> location.href='index.html');
      } else {
        location.href = 'index.html';
      }
    }
    function goToMembers(){ location.href='index3.html' }
    function goToAdmin(){ location.href='index5.html' }
    function showSection(id){ document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='repository') { switchPanel('extensions'); } }

    /****************** Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (state) ******************/
    const state = { repos: [], currentRepoIndex: null, sources: [] };

    const PREPOPULATED_REPOS = [
      { name: "Keiyoushi", url: "https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json" },
      { name: "ThePBone (revived)", url: "https://raw.githubusercontent.com/ThePBone/tachiyomi-extensions-revived/repo/index.min.json" },
      { name: "Mihon (chaerun)", url: "https://raw.githubusercontent.com/chaerun/mihon-extensions/repo/index.min.json" },
      { name: "Kaciin (examples)", url: "https://raw.githubusercontent.com/kaciin/tachiyomi-extensions-source/repo/index.min.json" }
    ];

    /****************** Ø±Ù†Ø¯Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ******************/
    function renderRepoTabs(){
      const tabs = document.getElementById('repoTabs'); tabs.innerHTML = '';
      state.repos.forEach((r, idx)=>{
        const el = document.createElement('button'); el.className = 'repo-tab' + (state.currentRepoIndex===idx ? ' active' : ''); el.textContent = r.name || `repo ${idx+1}`; el.onclick = ()=> { selectRepo(idx); };
        tabs.appendChild(el);
      });
      if(state.repos.length===0){ const hint = document.createElement('div'); hint.className='small muted'; hint.style.marginTop='8px'; hint.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. Ø§Ø¶ØºØ· "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©" Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· JSON.'; tabs.appendChild(hint); }
    }

    function selectRepo(idx){ state.currentRepoIndex = idx; renderRepoTabs(); if(!state.repos[idx].loaded) fetchRepo(idx); else renderExtensionsGrid(state.repos[idx].items || []); }

    /****************** Ø¬Ù„Ø¨ ÙˆØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙˆØ¯Ø¹ (Ù…Ø±Ù†) ******************/
    async function fetchRepo(idx){
      const repo = state.repos[idx]; if(!repo) return; setDetails(`Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨: ${repo.url}`);
      try {
        const res = await fetch(repo.url);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        let extensions = [];
        if(Array.isArray(json)){
          json.forEach(it => { if(it && (it.name || it.title)) extensions.push(normalizeExtension(it)); else extensions.push({ title: it.name||it.title||JSON.stringify(it).slice(0,40), raw: it }); });
        } else if(json.repositories && Array.isArray(json.repositories)) { json.repositories.forEach(it=> extensions.push(normalizeExtension(it))); }
        else if(json.extensions && Array.isArray(json.extensions)) { json.extensions.forEach(it=> extensions.push(normalizeExtension(it))); }
        else if(json.sources && Array.isArray(json.sources)) { json.sources.forEach(it=> extensions.push(normalizeExtension(it))); }
        else {
          const maybe = [];
          Object.keys(json).forEach(k=>{ if(Array.isArray(json[k])) { json[k].forEach(it => { if(it && (it.name || it.title)) maybe.push(it); }); } });
          if(maybe.length>0){ maybe.forEach(it=>extensions.push(normalizeExtension(it))); }
          else { extensions.push({ title: repo.name || repo.url, raw: json }); }
        }
        repo.items = extensions; repo.loaded = true; renderRepoTabs(); if(state.currentRepoIndex === idx) renderExtensionsGrid(extensions); setDetails(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${repo.name} â€” ${extensions.length} Ø¹Ù†Ø§ØµØ±.`);
      } catch(err){ console.error(err); repo.loaded = false; setDetails(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ repo: ${repo.url} â€” ${err.message}. Ø¥Ø°Ø§ Ø¸Ù‡Ø± "CORS" Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.`); alert(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (${repo.name}): ${err.message}\nÙ…Ø´ÙƒÙ„Ø© Ø´Ø§Ø¦Ø¹Ø©: CORS. Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON.`);
      }
    }

    function normalizeExtension(it){
      const title = it.title || it.name || it.id || it.pkg || it.apk || 'Ø¥Ø¶Ø§ÙØ©';
      const lang = it.lang || it.language || it.languages || (it.availableLanguages ? (Array.isArray(it.availableLanguages)?it.availableLanguages.join(',') : it.availableLanguages) : '');
      const description = it.description || it.desc || it.summary || '';
      const icon = it.icon || it.logo || it.image || it.cover || (it.thumbnail || null);
      const url = it.url || it.repo || it.index || it.apk || it.link || it.json || null;
      return { title, lang, description, icon, url, raw: it };
    }

    /****************** Ø±Ù†Ø¯Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª (Ø¨Ø·Ø§Ù‚Ø§Øª Ø´Ø¨ÙŠÙ‡Ø© Ø¨ØªØ§Ø´ÙŠÙˆÙ…ÙŠ) ******************/
    function renderExtensionsGrid(items){
      const grid = document.getElementById('extensionsGrid'); grid.innerHTML = '';
      if(!items || items.length===0){ grid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ùˆ Ø§Ù„Ø¨Ù†ÙŠØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©.</div>'; return; }
      items.forEach((ex, i) => {
        const card = document.createElement('div'); card.className = 'card';
        const thumbUrl = ex.icon || placeholderThumb(ex.title);
        card.innerHTML = `
          <div class="ext-card">
            <img class="ext-thumb" src="${escapeHtml(thumbUrl)}" onerror="this.src='${placeholderThumb(ex.title)}'"/>
            <div class="ext-body">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div class="ext-title">${escapeHtml(ex.title)}</div>
                  <div class="ext-meta">${escapeHtml(ex.lang || (ex.raw && ex.raw.language) || '')}</div>
                </div>
                <div style="text-align:left">
                  <button class="btn" onclick="importAsSource(${state.currentRepoIndex}, ${i})">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ…ØµØ¯Ø±</button>
                </div>
              </div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(shorten(ex.description || (ex.raw && ex.raw.summary) || 'Ù„Ø§ ÙˆØµÙ Ù…ØªØ§Ø­'))}</div>
              <div class="small muted" style="margin-top:8px">Ø±Ø§Ø¨Ø·: ${escapeHtml(ex.url || (ex.raw && guessUrlFromRaw(ex.raw)) || 'â€”')}</div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    /****************** Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ€ Ù…ØµØ¯Ø± (ÙŠÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ panelSources) ******************/
    function importAsSource(repoIdx, extIdx){
      const repo = state.repos[repoIdx]; if(!repo || !repo.items || !repo.items[extIdx]) return; const ex = repo.items[extIdx];
      const sourceObj = { name: ex.title || ex.raw?.name || 'Ù…ØµØ¯Ø±', url: ex.url || guessUrlFromRaw(ex.raw) || repo.url, raw: ex.raw || null };
      if(state.sources.some(s => (s.url && s.url===sourceObj.url) || (s.name && s.name===sourceObj.name))){ alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø±.'); return; }
      state.sources.push(sourceObj); renderSourcesGrid(); switchPanel('sources'); setDetails(`Ø§Ø³ØªÙˆØ±Ø¯Øª: ${sourceObj.name}`);
    }

    /****************** Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ******************/
    function renderSourcesGrid(){
      const grid = document.getElementById('sourcesGrid'); grid.innerHTML = '';
      if(state.sources.length===0){ grid.innerHTML = '<div class="muted">Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…ØµØ¯Ø± Ø¨Ø¹Ø¯.</div>'; return; }
      state.sources.forEach((s, idx) => {
        const d = document.createElement('div'); d.className='card';
        d.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">${escapeHtml(s.name)}</div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(s.url)}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" onclick="openSource(${idx})">Ø§ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±</button>
              <button class="btn" style="background:#c94a4a" onclick="removeSource(${idx})">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
        grid.appendChild(d);
      });
    }

    async function openSource(idx){
      const s = state.sources[idx]; if(!s) return; setDetails(`ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±: ${s.name}`);
      if(s.raw && Array.isArray(s.raw.manga)){ showMangaList(s.raw.manga, s); return; }
      try{
        const res = await fetch(s.url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        if(Array.isArray(json)) { showMangaList(json, s); return; }
        if(json.manga && Array.isArray(json.manga)) { showMangaList(json.manga, s); return; }
        alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø§Ù†Ø¬Ø§ Ø¨Ù…Ø¹ÙŠØ§Ø±ÙŠØ© Ù…ÙÙ‡ÙˆÙ…Ø©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¨Ù†ÙŠØ© Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }catch(e){ console.error(e); alert('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø± â€” Ø±Ø¨Ù…Ø§ CORS Ø£Ùˆ Ø¨Ù†ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©. Ø¬Ø±Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.'); setDetails('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±: ' + e.message); }
    }

    function showMangaList(list, source){
      const panel = document.getElementById('extensionsGrid'); panel.innerHTML = '';
      if(!Array.isArray(list) || list.length===0){ panel.innerHTML = '<div class="muted">Ù„Ù… Ø£Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù…Ø§Ù†Ø¬Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±.</div>'; return; }
      list.forEach(m => {
        const card = document.createElement('div'); card.className='card';
        const thumb = (m.image || m.thumbnail || m.cover) || placeholderThumb(m.title || m.name);
        // Ù†Ø³ØªØ®Ø¯Ù… escapeJson Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© Ø¯Ø§Ø®Ù„ onclick (Ù…Ø±Ù…Ù‘Ø²Ø© base64)
        const payload = escapeJson(m);
        card.innerHTML = `
          <div style="display:flex;gap:10px;align-items:flex-start">
            <img src="${escapeHtml(thumb)}" class="ext-thumb" onerror="this.src='${placeholderThumb(m.title||m.name)}'"/>
            <div style="flex:1">
              <div style="font-weight:800">${escapeHtml(m.title||m.name||'Ù…Ø§Ù†Ø¬Ø§')}</div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(m.description||m.summary||'Ù„Ø§ ÙˆØµÙ')}</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="btn" onclick='openManga(${JSON.stringify(payload)})'>Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„</button>
                <a class="btn btn-ghost" href="${escapeHtml(m.url||m.link||m.page||'#')}" target="_blank">ØµÙØ­Ø© Ø§Ù„Ù…ØµØ¯Ø±</a>
              </div>
            </div>
          </div>
        `;
        panel.appendChild(card);
      });
    }

    function openManga(mB64){
      // mB64 Ù‡Ùˆ Ø³Ù„Ø³Ù„Ø© base64 Ù…Ø±Ù…Ù‘Ø²Ø© Ø¯Ø§Ø®Ù„ JSON literal
      const m = unescapeJson(mB64);
      if(Array.isArray(m.chapters) && m.chapters.length>0){ showChaptersInPanel(m.chapters, m); return; }
      if(m.chaptersUrl){ (async ()=>{ try{ const res = await fetch(m.chaptersUrl); if(!res.ok) throw new Error('HTTP '+res.status); const json = await res.json(); if(Array.isArray(json)) showChaptersInPanel(json, m); else alert('Ø¨Ù†ÙŠØ© Ø§Ù„ÙØµÙˆÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©.'); }catch(e){ alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙØµÙˆÙ„: '+e.message + ' (Ø±Ø¨Ù…Ø§ CORS)'); console.error(e); } })(); return; }
      alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙØµÙˆÙ„ ÙˆØ§Ø¶Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù†.');
    }

    function showChaptersInPanel(chapters, manga){
      const panel = document.getElementById('extensionsGrid'); panel.innerHTML = '';
      chapters.forEach(ch=>{ const d = document.createElement('div'); d.className='card'; d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">${escapeHtml(ch.title||ch.name||'ÙØµÙ„')}</div>
            <div class="small muted">${escapeHtml(ch.date||'')}</div>
          </div>
          <div style="display:flex;gap:8px">
            <a class="btn" href="${escapeHtml(ch.chapterUrl||ch.url||ch.readUrl||'#')}" target="_blank">ÙØªØ­</a>
            ${Array.isArray(ch.images) ? `<button class="btn" onclick='openReader(${JSON.stringify(escapeJson(ch))})'>Ø§Ù‚Ø±Ø£</button>` : ''}
          </div>
        </div>
      `; panel.appendChild(d); });
    }

    function openReader(chB64){
      const ch = unescapeJson(chB64);
      const w = window.open('','_blank');
      let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${escapeHtml(ch.title||'Ø§Ù„Ù‚Ø§Ø±Ø¦')}</title></head><body style="background:#0f0f12;color:#fff;font-family:Cairo;padding:12px">`;
      if(Array.isArray(ch.images) && ch.images.length>0){ ch.images.forEach(img => html += `<img src="${escapeHtml(img)}" style="display:block;max-width:100%;margin:12px auto;border-radius:8px" />`); }
      else { html += `<p class="small">Ù„Ø§ ØµÙˆØ± Ù…ØªØ§Ø­Ø©. Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ.</p><a href="${escapeHtml(ch.chapterUrl||'#')}" target="_blank" class="btn">ÙØªØ­ Ø§Ù„ÙØµÙ„</a>`; }
      html += '</body></html>';
      w.document.write(html); w.document.close();
    }

    /****************** Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ******************/
    function addRepoFromInput(){ const url = (document.getElementById('repoUrlInput').value||'').trim(); if(!url) return alert('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· JSON Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹'); state.repos.push({name: url.split('/').slice(-2,-1)[0]||url, url, loaded:false, items:[]}); document.getElementById('repoUrlInput').value=''; renderRepoTabs(); }
    function loadPrepopulated(){ PREPOPULATED_REPOS.forEach(r=> state.repos.push({name:r.name,url:r.url, loaded:false, items:[]})); renderRepoTabs(); if(state.repos.length>0) selectRepo(0); }
    function importFromPaste(){ const txt = document.getElementById('repoPaste').value.trim(); if(!txt) return alert('Ø£Ù„ØµÙ‚ JSON Ø£ÙˆÙ„Ø§Ù‹'); try{ const json = JSON.parse(txt); if(Array.isArray(json)) { json.forEach(it=> { if(it && (it.url||it.name)) state.repos.push({name: it.name||it.title||'repo', url: it.url||it.repo||it.index, loaded:false, items:[]}); else state.repos.push({name:'repo-pasted', url: '', loaded:false, items:[normalizeExtension(it)]}); }); } else if(json.name && json.url){ state.repos.push({name: json.name, url: json.url, loaded:false, items:[]}); } else { state.repos.push({name:'repo-pasted', url:'(pasted)', loaded:true, items:Array.isArray(json)?json:[json]}); } document.getElementById('repoPaste').value=''; renderRepoTabs(); } catch(e){ alert('JSON ØºÙŠØ± ØµØ§Ù„Ø­'); console.error(e); } }
    function clearRepos(){ if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§ØªØŸ')){ state.repos=[]; state.currentRepoIndex=null; renderRepoTabs(); document.getElementById('extensionsGrid').innerHTML=''; } }

    /****************** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ----------------- */
    function placeholderThumb(text){ const t = encodeURIComponent((text||'cover').slice(0,20)); return `https://via.placeholder.com/160x240.png?text=${t}&bg=111111&fg=d9d0ff`; }
    function shorten(s, n=120){ return s && s.length>n ? s.slice(0,n-1)+'â€¦' : s || ''; }
    function guessUrlFromRaw(raw){ if(!raw) return ''; return raw.url || raw.repo || raw.index || raw.apk || raw.link || ''; }
    function setDetails(txt){ document.getElementById('repoTabs').title = txt; }

    function switchPanel(p){ document.getElementById('panelSources').style.display = p==='sources' ? 'block' : 'none'; document.getElementById('panelExtensions').style.display = p==='extensions' ? 'block' : 'none'; document.getElementById('tabSources').classList.toggle('active', p==='sources'); document.getElementById('tabExtensions').classList.toggle('active', p==='extensions'); }
    function removeSource(i){ if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±ØŸ')){ state.sources.splice(i,1); renderSourcesGrid(); } }

    /* ---- ØªØ­ÙˆÙŠÙ„ JSON Ø¥Ù„Ù‰ base64 ÙˆØ¨Ø§Ù„Ø¹ÙƒØ³ - Ø¢Ù…Ù† Ù„Ù„ÙŠÙˆÙ†ÙŠÙƒÙˆØ¯ ---- */
    function escapeJson(obj){
      // ØªØ±Ù…ÙŠØ² UTF-8 Ø«Ù… base64
      const utf8 = encodeURIComponent(JSON.stringify(obj)).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1));
      return btoa(utf8);
    }
    function unescapeJson(b64){
      const str = atob(b64);
      const dec = decodeURIComponent(Array.prototype.map.call(str, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      try{ return JSON.parse(dec); }catch(e){ console.error('ÙØ´Ù„ ÙÙƒ JSON:', e); return null; }
    }

    renderRepoTabs(); renderSourcesGrid();

    /****************** Ø­Ù…Ø§ÙŠØ© HTML ----------------- */
    function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /*********** Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙ‚Ù†ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù…Ù‡Ù…Ø©): ***********
      - Ù…Ø¹Ø¸Ù… Ø±ÙˆØ§Ø¨Ø· raw Ù…Ù† GitHub ØªØ¹Ù…Ù„ Ù„ÙƒÙ† Ø§Ù„Ù…ØªØµÙÙ‘Ø­ ÙŠÙ…Ù†Ø¹ fetch Ø¨Ø³Ø¨Ø¨ CORS Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ (file://).
      - Ù„ØªÙØ§Ø¯ÙŠ Ø°Ù„Ùƒ Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ (python -m http.server Ø£Ùˆ npx serve) Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ØµØµ.
      - Ø¥Ø°Ø§ Ø£Ø±Ø¯ØªØŒ Ø£Ø¶ÙŠÙ Ø²Ø± Ù„Ø¥Ø³ØªØ®Ø¯Ø§Ù… proxy (Ù…Ø«Ù„ https://cors.bridged.cc/) Ù„ÙƒÙ† Ù‡Ø°Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ø®Ø§Ø±Ø¬ÙŠ ÙˆØºÙŠØ± Ø¢Ù…Ù† Ø¯Ø§Ø¦Ù…Ø§Ù‹.
    ***************************************************/
  </script>
</body>
</html>
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 14px; margin-top: 18px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
    /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø´Ø¨ÙŠÙ‡ Ø¨ØªØ§Ø´ÙŠÙˆÙ…ÙŠ */
    .ext-card { display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
    .ext-thumb { width:72px; height:100px; border-radius:8px; object-fit:cover; flex-shrink:0; background:#111; border:1px solid rgba(255,255,255,0.03) }
    .ext-body { flex:1; display:flex; flex-direction:column; gap:6px }
    .ext-title { font-weight:800; font-size:15px }
    .ext-meta { color:#9b8fb3; font-size:13px }
    .btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#7b5cff; color:#fff; font-weight:700 }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.05); color:#fff }
    .small { font-size:13px; color:#9b8fb3 }
    .muted { color:#9b8fb3 }
    .repo-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .repo-tab { padding:6px 10px; border-radius:8px; cursor:pointer; background:transparent; color:#9b8fb3; font-weight:700 }
    .repo-tab.active { background:rgba(168,139,255,0.08); color:#fff }
    @media (max-width:700px){ .ext-thumb{width:60px;height:84px} .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
  </style>
</head>
<body>
  <header>
    <span class="menu-btn" onclick="toggleMenu()">â˜°</span>
    <h1>Ø§Ù„Ù…ÙƒØªØ¨Ø©</h1>
    <img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="Ø¨Ø±ÙˆÙØ§ÙŠÙ„">
  </header>

  <div class="sub-header">
    <a href="index5.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a onclick="showSection('library')">Ù…ÙƒØªØ¨ØªÙŠ</a>
    <a onclick="showSection('repository')">Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§</a>
    <a onclick="showSection('settings')">Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª</a>
  </div>

  <div class="hero"><img src="images/imag1.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©"></div>

  <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
  <div id="library" class="section active">
    <div class="content">
      <div id="welcome" class="welcome">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </div>
  </div>

  <!-- ======= Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§/Ø§Ù„Ù…Ø§Ù†Ù‡ÙˆØ§ (Ø§Ù„Ù…ÙØ­Ø¯Ù‘Ø« Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) ======= -->
  <div id="repository" class="section">
    <div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª -->
    <div class="repo-tabs" id="repoTabs"></div>

    <nav>
      <button id="tabSources" class="active" onclick="switchPanel('sources')">Ø§Ù„Ù…ØµØ§Ø¯Ø±</button>
      <button id="tabExtensions" onclick="switchPanel('extensions')">Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</button>
    </nav>

    <div id="panelSources" class="panel active">
      <div class="hint">Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªÙˆØ±Ø¯Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ…ØµØ¯Ø±" Ù…Ù† Ø£ÙŠ Ø¥Ø¶Ø§ÙØ© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹.</div>
      <div id="sourcesGrid" class="grid" aria-live="polite"></div>
    </div>

    <div id="panelExtensions" class="panel" style="display:none">
      <div class="hint">Ø§Ø®ØªØ± ØªØ¨ÙˆÙŠØ¨ Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ø¹Ù„Ù‰ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª. Ø¥Ø°Ø§ Ø¸Ù‡Ø± ØªØ­Ø°ÙŠØ± CORSØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.</div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="repoUrlInput" class="input" placeholder="Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· JSON Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (raw GitHub)"/>
        <button class="btn" onclick="addRepoFromInput()">Ø£Ø¶Ù Ù…Ø³ØªÙˆØ¯Ø¹</button>
        <button class="btn" onclick="loadPrepopulated()">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©</button>
      </div>

      <div style="margin-top:10px">
        <textarea id="repoPaste" rows="5" style="width:100%;border-radius:8px;padding:8px;background:#0f0f12;color:#fff" placeholder='Ø£Ùˆ Ø£Ù„ØµÙ‚ JSON Ù‡Ù†Ø§ (Ù…ØµÙÙˆÙØ© Ø£Ùˆ ÙƒØ§Ø¦Ù† repository).'></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" onclick="importFromPaste()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„Ù†Øµ</button>
          <button class="btn btn-ghost" onclick="clearRepos()">Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª</button>
        </div>
      </div>

      <div id="extensionsContainer" style="margin-top:14px">
        <div id="extensionsGrid" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="settings" class="section">
    <p>Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="#" onclick="goToMembers()">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</a>
    <button id="adminBtn" onclick="goToAdmin()" style="display:none;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <script>
    /****************** Ø¥Ø¹Ø¯Ø§Ø¯ Supabase (ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…) ******************/
    const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";

    // Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ù…Ø§ÙŠØ§Øª Ù„Ø¹Ø¯Ù… Ø§ÙØªØ±Ø§Ø¶ Ø§Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    const supabaseClient = (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function')
      ? window.supabase.createClient(supabaseUrl, supabaseKey)
      : (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function')
        ? supabase.createClient(supabaseUrl, supabaseKey)
        : null;

    async function loadUser() {
      try {
        if(!supabaseClient) throw new Error('Supabase SDK ØºÙŠØ± Ù…ØªØ§Ø­');
        const { data, error } = await supabaseClient.auth.getUser();
        if (error || !data.user) return window.location.href = "index.html";
        const { data: profile } = await supabaseClient.from("profiles").select("username, role, avatar_url").eq("id", data.user.id).single();
        document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${profile?.username || "Ù…Ø³ØªØ®Ø¯Ù…"} ğŸ‘‹`;
        if (profile?.avatar_url) document.getElementById("profileImage").src = profile.avatar_url;
        if ([(profile?.role||"")].some(r => String(r).toLowerCase() === 'admin' || String(r).toLowerCase() === 'owner')) {
          document.getElementById("adminBtn").style.display = "block";
        }
      } catch(e) {
        // Ù„Ùˆ Supabase ÙØ´Ù„ Ù„Ø£ÙŠ Ø³Ø¨Ø¨ØŒ Ù†Ø³Ù…Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        console.warn(e);
        document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ Ø²Ø§Ø¦Ø± â€” (Supabase ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹).`;
      }
    }
    loadUser();

    /****************** ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø§Ù…Ø© ******************/
    function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); document.getElementById("overlay").classList.toggle("active"); }
    function logout() {
      if(supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.signOut === 'function'){
        supabaseClient.auth.signOut().then(()=> location.href='index.html').catch(()=> location.href='index.html');
      } else {
        location.href = 'index.html';
      }
    }
    function goToMembers(){ location.href='index3.html' }
    function goToAdmin(){ location.href='index5.html' }
    function showSection(id){ document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='repository') { switchPanel('extensions'); } }

    /****************** Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (state) ******************/
    const state = { repos: [], currentRepoIndex: null, sources: [] };

    const PREPOPULATED_REPOS = [
      { name: "Keiyoushi", url: "https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json" },
      { name: "ThePBone (revived)", url: "https://raw.githubusercontent.com/ThePBone/tachiyomi-extensions-revived/repo/index.min.json" },
      { name: "Mihon (chaerun)", url: "https://raw.githubusercontent.com/chaerun/mihon-extensions/repo/index.min.json" },
      { name: "Kaciin (examples)", url: "https://raw.githubusercontent.com/kaciin/tachiyomi-extensions-source/repo/index.min.json" }
    ];

    /****************** Ø±Ù†Ø¯Ø± ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ******************/
    function renderRepoTabs(){
      const tabs = document.getElementById('repoTabs'); tabs.innerHTML = '';
      state.repos.forEach((r, idx)=>{
        const el = document.createElement('button'); el.className = 'repo-tab' + (state.currentRepoIndex===idx ? ' active' : ''); el.textContent = r.name || `repo ${idx+1}`; el.onclick = ()=> { selectRepo(idx); };
        tabs.appendChild(el);
      });
      if(state.repos.length===0){ const hint = document.createElement('div'); hint.className='small muted'; hint.style.marginTop='8px'; hint.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª. Ø§Ø¶ØºØ· "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª Ø§Ù„Ù…Ø¶Ù…Ù‘Ù†Ø©" Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· JSON.'; tabs.appendChild(hint); }
    }

    function selectRepo(idx){ state.currentRepoIndex = idx; renderRepoTabs(); if(!state.repos[idx].loaded) fetchRepo(idx); else renderExtensionsGrid(state.repos[idx].items || []); }

    /****************** Ø¬Ù„Ø¨ ÙˆØªØ­Ù„ÙŠÙ„ Ù…Ø³ØªÙˆØ¯Ø¹ (Ù…Ø±Ù†) ******************/
    async function fetchRepo(idx){
      const repo = state.repos[idx]; if(!repo) return; setDetails(`Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨: ${repo.url}`);
      try {
        const res = await fetch(repo.url);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const json = await res.json();
        let extensions = [];
        if(Array.isArray(json)){
          json.forEach(it => { if(it && (it.name || it.title)) extensions.push(normalizeExtension(it)); else extensions.push({ title: it.name||it.title||JSON.stringify(it).slice(0,40), raw: it }); });
        } else if(json.repositories && Array.isArray(json.repositories)) { json.repositories.forEach(it=> extensions.push(normalizeExtension(it))); }
        else if(json.extensions && Array.isArray(json.extensions)) { json.extensions.forEach(it=> extensions.push(normalizeExtension(it))); }
        else if(json.sources && Array.isArray(json.sources)) { json.sources.forEach(it=> extensions.push(normalizeExtension(it))); }
        else {
          const maybe = [];
          Object.keys(json).forEach(k=>{ if(Array.isArray(json[k])) { json[k].forEach(it => { if(it && (it.name || it.title)) maybe.push(it); }); } });
          if(maybe.length>0){ maybe.forEach(it=>extensions.push(normalizeExtension(it))); }
          else { extensions.push({ title: repo.name || repo.url, raw: json }); }
        }
        repo.items = extensions; repo.loaded = true; renderRepoTabs(); if(state.currentRepoIndex === idx) renderExtensionsGrid(extensions); setDetails(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: ${repo.name} â€” ${extensions.length} Ø¹Ù†Ø§ØµØ±.`);
      } catch(err){ console.error(err); repo.loaded = false; setDetails(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ repo: ${repo.url} â€” ${err.message}. Ø¥Ø°Ø§ Ø¸Ù‡Ø± "CORS" Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.`); alert(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (${repo.name}): ${err.message}\nÙ…Ø´ÙƒÙ„Ø© Ø´Ø§Ø¦Ø¹Ø©: CORS. Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON.`);
      }
    }

    function normalizeExtension(it){
      const title = it.title || it.name || it.id || it.pkg || it.apk || 'Ø¥Ø¶Ø§ÙØ©';
      const lang = it.lang || it.language || it.languages || (it.availableLanguages ? (Array.isArray(it.availableLanguages)?it.availableLanguages.join(',') : it.availableLanguages) : '');
      const description = it.description || it.desc || it.summary || '';
      const icon = it.icon || it.logo || it.image || it.cover || (it.thumbnail || null);
      const url = it.url || it.repo || it.index || it.apk || it.link || it.json || null;
      return { title, lang, description, icon, url, raw: it };
    }

    /****************** Ø±Ù†Ø¯Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª (Ø¨Ø·Ø§Ù‚Ø§Øª Ø´Ø¨ÙŠÙ‡Ø© Ø¨ØªØ§Ø´ÙŠÙˆÙ…ÙŠ) ******************/
    function renderExtensionsGrid(items){
      const grid = document.getElementById('extensionsGrid'); grid.innerHTML = '';
      if(!items || items.length===0){ grid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¶Ø§ÙØ§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø£Ùˆ Ø§Ù„Ø¨Ù†ÙŠØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©.</div>'; return; }
      items.forEach((ex, i) => {
        const card = document.createElement('div'); card.className = 'card';
        const thumbUrl = ex.icon || placeholderThumb(ex.title);
        card.innerHTML = `
          <div class="ext-card">
            <img class="ext-thumb" src="${escapeHtml(thumbUrl)}" onerror="this.src='${placeholderThumb(ex.title)}'"/>
            <div class="ext-body">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div class="ext-title">${escapeHtml(ex.title)}</div>
                  <div class="ext-meta">${escapeHtml(ex.lang || (ex.raw && ex.raw.language) || '')}</div>
                </div>
                <div style="text-align:left">
                  <button class="btn" onclick="importAsSource(${state.currentRepoIndex}, ${i})">Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ…ØµØ¯Ø±</button>
                </div>
              </div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(shorten(ex.description || (ex.raw && ex.raw.summary) || 'Ù„Ø§ ÙˆØµÙ Ù…ØªØ§Ø­'))}</div>
              <div class="small muted" style="margin-top:8px">Ø±Ø§Ø¨Ø·: ${escapeHtml(ex.url || (ex.raw && guessUrlFromRaw(ex.raw)) || 'â€”')}</div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    /****************** Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒÙ€ Ù…ØµØ¯Ø± (ÙŠÙ†ØªÙ‚Ù„ Ø¥Ù„Ù‰ panelSources) ******************/
    function importAsSource(repoIdx, extIdx){
      const repo = state.repos[repoIdx]; if(!repo || !repo.items || !repo.items[extIdx]) return; const ex = repo.items[extIdx];
      const sourceObj = { name: ex.title || ex.raw?.name || 'Ù…ØµØ¯Ø±', url: ex.url || guessUrlFromRaw(ex.raw) || repo.url, raw: ex.raw || null };
      if(state.sources.some(s => (s.url && s.url===sourceObj.url) || (s.name && s.name===sourceObj.name))){ alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø±.'); return; }
      state.sources.push(sourceObj); renderSourcesGrid(); switchPanel('sources'); setDetails(`Ø§Ø³ØªÙˆØ±Ø¯Øª: ${sourceObj.name}`);
    }

    /****************** Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ******************/
    function renderSourcesGrid(){
      const grid = document.getElementById('sourcesGrid'); grid.innerHTML = '';
      if(state.sources.length===0){ grid.innerHTML = '<div class="muted">Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø£ÙŠ Ù…ØµØ¯Ø± Ø¨Ø¹Ø¯.</div>'; return; }
      state.sources.forEach((s, idx) => {
        const d = document.createElement('div'); d.className='card';
        d.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">${escapeHtml(s.name)}</div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(s.url)}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" onclick="openSource(${idx})">Ø§ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±</button>
              <button class="btn" style="background:#c94a4a" onclick="removeSource(${idx})">Ø­Ø°Ù</button>
            </div>
          </div>
        `;
        grid.appendChild(d);
      });
    }

    async function openSource(idx){
      const s = state.sources[idx]; if(!s) return; setDetails(`ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±: ${s.name}`);
      if(s.raw && Array.isArray(s.raw.manga)){ showMangaList(s.raw.manga, s); return; }
      try{
        const res = await fetch(s.url);
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json = await res.json();
        if(Array.isArray(json)) { showMangaList(json, s); return; }
        if(json.manga && Array.isArray(json.manga)) { showMangaList(json.manga, s); return; }
        alert('Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø± Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø§Ù†Ø¬Ø§ Ø¨Ù…Ø¹ÙŠØ§Ø±ÙŠØ© Ù…ÙÙ‡ÙˆÙ…Ø©. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¨Ù†ÙŠØ© Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.');
      }catch(e){ console.error(e); alert('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø± â€” Ø±Ø¨Ù…Ø§ CORS Ø£Ùˆ Ø¨Ù†ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©. Ø¬Ø±Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø®Ø§Ø¯Ù… Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹.'); setDetails('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…ØµØ¯Ø±: ' + e.message); }
    }

    function showMangaList(list, source){
      const panel = document.getElementById('extensionsGrid'); panel.innerHTML = '';
      if(!Array.isArray(list) || list.length===0){ panel.innerHTML = '<div class="muted">Ù„Ù… Ø£Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ù…Ø§Ù†Ø¬Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±.</div>'; return; }
      list.forEach(m => {
        const card = document.createElement('div'); card.className='card';
        const thumb = (m.image || m.thumbnail || m.cover) || placeholderThumb(m.title || m.name);
        // Ù†Ø³ØªØ®Ø¯Ù… escapeJson Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© Ø¯Ø§Ø®Ù„ onclick (Ù…Ø±Ù…Ù‘Ø²Ø© base64)
        const payload = escapeJson(m);
        card.innerHTML = `
          <div style="display:flex;gap:10px;align-items:flex-start">
            <img src="${escapeHtml(thumb)}" class="ext-thumb" onerror="this.src='${placeholderThumb(m.title||m.name)}'"/>
            <div style="flex:1">
              <div style="font-weight:800">${escapeHtml(m.title||m.name||'Ù…Ø§Ù†Ø¬Ø§')}</div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(m.description||m.summary||'Ù„Ø§ ÙˆØµÙ')}</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="btn" onclick='openManga(${JSON.stringify(payload)})'>Ø¹Ø±Ø¶ Ø§Ù„ÙØµÙˆÙ„</button>
                <a class="btn btn-ghost" href="${escapeHtml(m.url||m.link||m.page||'#')}" target="_blank">ØµÙØ­Ø© Ø§Ù„Ù…ØµØ¯Ø±</a>
              </div>
            </div>
          </div>
        `;
        panel.appendChild(card);
      });
    }

    function openManga(mB64){
      // mB64 Ù‡Ùˆ Ø³Ù„Ø³Ù„Ø© base64 Ù…Ø±Ù…Ù‘Ø²Ø© Ø¯Ø§Ø®Ù„ JSON literal
      const m = unescapeJson(mB64);
      if(Array.isArray(m.chapters) && m.chapters.length>0){ showChaptersInPanel(m.chapters, m); return; }
      if(m.chaptersUrl){ (async ()=>{ try{ const res = await fetch(m.chaptersUrl); if(!res.ok) throw new Error('HTTP '+res.status); const json = await res.json(); if(Array.isArray(json)) showChaptersInPanel(json, m); else alert('Ø¨Ù†ÙŠØ© Ø§Ù„ÙØµÙˆÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©.'); }catch(e){ alert('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ÙØµÙˆÙ„: '+e.message + ' (Ø±Ø¨Ù…Ø§ CORS)'); console.error(e); } })(); return; }
      alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙØµÙˆÙ„ ÙˆØ§Ø¶Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù†.');
    }

    function showChaptersInPanel(chapters, manga){
      const panel = document.getElementById('extensionsGrid'); panel.innerHTML = '';
      chapters.forEach(ch=>{ const d = document.createElement('div'); d.className='card'; d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">${escapeHtml(ch.title||ch.name||'ÙØµÙ„')}</div>
            <div class="small muted">${escapeHtml(ch.date||'')}</div>
          </div>
          <div style="display:flex;gap:8px">
            <a class="btn" href="${escapeHtml(ch.chapterUrl||ch.url||ch.readUrl||'#')}" target="_blank">ÙØªØ­</a>
            ${Array.isArray(ch.images) ? `<button class="btn" onclick='openReader(${JSON.stringify(escapeJson(ch))})'>Ø§Ù‚Ø±Ø£</button>` : ''}
          </div>
        </div>
      `; panel.appendChild(d); });
    }

    function openReader(chB64){
      const ch = unescapeJson(chB64);
      const w = window.open('','_blank');
      let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${escapeHtml(ch.title||'Ø§Ù„Ù‚Ø§Ø±Ø¦')}</title></head><body style="background:#0f0f12;color:#fff;font-family:Cairo;padding:12px">`;
      if(Array.isArray(ch.images) && ch.images.length>0){ ch.images.forEach(img => html += `<img src="${escapeHtml(img)}" style="display:block;max-width:100%;margin:12px auto;border-radius:8px" />`); }
      else { html += `<p class="small">Ù„Ø§ ØµÙˆØ± Ù…ØªØ§Ø­Ø©. Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø£ØµÙ„ÙŠ.</p><a href="${escapeHtml(ch.chapterUrl||'#')}" target="_blank" class="btn">ÙØªØ­ Ø§Ù„ÙØµÙ„</a>`; }
      html += '</body></html>';
      w.document.write(html); w.document.close();
    }

    /****************** Ø£Ø¯ÙˆØ§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹ ******************/
    function addRepoFromInput(){ const url = (document.getElementById('repoUrlInput').value||'').trim(); if(!url) return alert('Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· JSON Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹'); state.repos.push({name: url.split('/').slice(-2,-1)[0]||url, url, loaded:false, items:[]}); document.getElementById('repoUrlInput').value=''; renderRepoTabs(); }
    function loadPrepopulated(){ PREPOPULATED_REPOS.forEach(r=> state.repos.push({name:r.name,url:r.url, loaded:false, items:[]})); renderRepoTabs(); if(state.repos.length>0) selectRepo(0); }
    function importFromPaste(){ const txt = document.getElementById('repoPaste').value.trim(); if(!txt) return alert('Ø£Ù„ØµÙ‚ JSON Ø£ÙˆÙ„Ø§Ù‹'); try{ const json = JSON.parse(txt); if(Array.isArray(json)) { json.forEach(it=> { if(it && (it.url||it.name)) state.repos.push({name: it.name||it.title||'repo', url: it.url||it.repo||it.index, loaded:false, items:[]}); else state.repos.push({name:'repo-pasted', url: '', loaded:false, items:[normalizeExtension(it)]}); }); } else if(json.name && json.url){ state.repos.push({name: json.name, url: json.url, loaded:false, items:[]}); } else { state.repos.push({name:'repo-pasted', url:'(pasted)', loaded:true, items:Array.isArray(json)?json:[json]}); } document.getElementById('repoPaste').value=''; renderRepoTabs(); } catch(e){ alert('JSON ØºÙŠØ± ØµØ§Ù„Ø­'); console.error(e); } }
    function clearRepos(){ if(confirm('Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§ØªØŸ')){ state.repos=[]; state.currentRepoIndex=null; renderRepoTabs(); document.getElementById('extensionsGrid').innerHTML=''; } }

    /****************** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ----------------- */
    function placeholderThumb(text){ const t = encodeURIComponent((text||'cover').slice(0,20)); return `https://via.placeholder.com/160x240.png?text=${t}&bg=111111&fg=d9d0ff`; }
    function shorten(s, n=120){ return s && s.length>n ? s.slice(0,n-1)+'â€¦' : s || ''; }
    function guessUrlFromRaw(raw){ if(!raw) return ''; return raw.url || raw.repo || raw.index || raw.apk || raw.link || ''; }
    function setDetails(txt){ document.getElementById('repoTabs').title = txt; }

    function switchPanel(p){ document.getElementById('panelSources').style.display = p==='sources' ? 'block' : 'none'; document.getElementById('panelExtensions').style.display = p==='extensions' ? 'block' : 'none'; document.getElementById('tabSources').classList.toggle('active', p==='sources'); document.getElementById('tabExtensions').classList.toggle('active', p==='extensions'); }
    function removeSource(i){ if(confirm('Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±ØŸ')){ state.sources.splice(i,1); renderSourcesGrid(); } }

    /* ---- ØªØ­ÙˆÙŠÙ„ JSON Ø¥Ù„Ù‰ base64 ÙˆØ¨Ø§Ù„Ø¹ÙƒØ³ - Ø¢Ù…Ù† Ù„Ù„ÙŠÙˆÙ†ÙŠÙƒÙˆØ¯ ---- */
    function escapeJson(obj){
      // ØªØ±Ù…ÙŠØ² UTF-8 Ø«Ù… base64
      const utf8 = encodeURIComponent(JSON.stringify(obj)).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1));
      return btoa(utf8);
    }
    function unescapeJson(b64){
      const str = atob(b64);
      const dec = decodeURIComponent(Array.prototype.map.call(str, c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      try{ return JSON.parse(dec); }catch(e){ console.error('ÙØ´Ù„ ÙÙƒ JSON:', e); return null; }
    }

    renderRepoTabs(); renderSourcesGrid();

    /****************** Ø­Ù…Ø§ÙŠØ© HTML ----------------- */
    function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    /*********** Ù…Ù„Ø§Ø­Ø¸Ø© ØªÙ‚Ù†ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ© (Ù…Ù‡Ù…Ø©): ***********
      - Ù…Ø¹Ø¸Ù… Ø±ÙˆØ§Ø¨Ø· raw Ù…Ù† GitHub ØªØ¹Ù…Ù„ Ù„ÙƒÙ† Ø§Ù„Ù…ØªØµÙÙ‘Ø­ ÙŠÙ…Ù†Ø¹ fetch Ø¨Ø³Ø¨Ø¨ CORS Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ (file://).
      - Ù„ØªÙØ§Ø¯ÙŠ Ø°Ù„Ùƒ Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø³ÙŠØ±ÙØ± Ù…Ø­Ù„ÙŠ (python -m http.server Ø£Ùˆ npx serve) Ø£Ùˆ Ø§Ù„ØµÙ‚ JSON ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ØµØµ.
      - Ø¥Ø°Ø§ Ø£Ø±Ø¯ØªØŒ Ø£Ø¶ÙŠÙ Ø²Ø± Ù„Ø¥Ø³ØªØ®Ø¯Ø§Ù… proxy (Ù…Ø«Ù„ https://cors.bridged.cc/) Ù„ÙƒÙ† Ù‡Ø°Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§ØªØµØ§Ù„ Ø®Ø§Ø±Ø¬ÙŠ ÙˆØºÙŠØ± Ø¢Ù…Ù† Ø¯Ø§Ø¦Ù…Ø§Ù‹.
    ***************************************************/
  </script>
</body>
</html>
