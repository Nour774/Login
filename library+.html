<!DOCTYPE html> <html lang="ar" dir="rtl"> <head> <meta charset="UTF-8" /> <title>المكتبة</title> <link rel="icon" href="images/book.png"/> <meta name="viewport" content="width=device-width, initial-scale=1" /> <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> <style> /* --- نسقك الأصلي محافظ عليه --- */ * { box-sizing: border-box; transition: 0.3s ease; } body { margin: 0; font-family: "Cairo", "Tahoma", sans-serif; background: #1a1a1d; color: #f5f5f5; overflow-x: hidden; } header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #0f0e14; border-bottom: 1px solid rgba(255,255,255,0.05); } .menu-btn { cursor: pointer; font-size: 24px; } .profile-pic { width: 40px; height: 40px; border-radius: 50%; } .sub-header { display: flex; gap: 16px; padding: 10px 20px; background: #2a2a2d; } .sub-header a { color: #f5f5f5; text-decoration: none; font-weight: bold; cursor: pointer; } .hero img { width: 100%; max-height: 300px; object-fit: cover; } .content { padding: 20px; } .sidebar { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background: #333; padding: 20px; transition: right 0.3s ease; z-index: 1000; } .sidebar.active { right: 0; } .sidebar a, .sidebar button { display: block; margin-bottom: 10px; color: #fff; background: none; border: none; font-size: 16px; cursor: pointer; text-align: right; } .overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; } .overlay.active { display: block; } .section { display: none; padding: 20px; } .section.active { display: block; } .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; } .logo div:first-child { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #a88bff, #e6c07b); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #0b0710; font-size: 18px; } .logo .title { font-weight: 700; font-size: 18px; } nav { display: flex; gap: 16px; margin-bottom: 10px; } nav button { padding: 6px 12px; border: none; border-radius: 8px; background: transparent; color: #9b8fb3; cursor: pointer; font-weight: 700; } nav button.active { color: #fff; background: rgba(168,139,255,0.12); } .panel { display: none; } .panel.active { display: block; } .hint { margin-top: 12px; color: #9b8fb3; } /* شبكة البطاقات مثل تاشيومي ولكن حسب ستايلك */ .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 14px; margin-top: 18px; } .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; gap: 8px; align-items: stretch; } /* تصميم بطاقة شبيه بتاشيومي */ .ext-card { display:flex; gap:10px; align-items:flex-start; cursor:pointer; } .ext-thumb { width:72px; height:100px; border-radius:8px; object-fit:cover; flex-shrink:0; background:#111; border:1px solid rgba(255,255,255,0.03) } .ext-body { flex:1; display:flex; flex-direction:column; gap:6px } .ext-title { font-weight:800; font-size:15px } .ext-meta { color:#9b8fb3; font-size:13px } .btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#7b5cff; color:#fff; font-weight:700 } .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.05); color:#fff } .small { font-size:13px; color:#9b8fb3 } .muted { color:#9b8fb3 } .repo-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px } .repo-tab { padding:6px 10px; border-radius:8px; cursor:pointer; background:transparent; color:#9b8fb3; font-weight:700 } .repo-tab.active { background:rgba(168,139,255,0.08); color:#fff } @media (max-width:700px){ .ext-thumb{width:60px;height:84px} .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} } </style> </head> <body> <header> <span class="menu-btn" onclick="toggleMenu()">☰</span> <h1>المكتبة</h1> <img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="بروفايل"> </header> <div class="sub-header"> <a href="index5.html">الرئيسية</a> <a onclick="showSection('library')">مكتبتي</a> <a onclick="showSection('repository')">المانجا/المانهوا</a> <a onclick="showSection('settings')">الروايات</a> </div> <div class="hero"><img src="images/imag1.jpg" alt="صورة المقدمة"></div> <!-- الأقسام --> <div id="library" class="section active"> <div class="content"> <div id="welcome" class="welcome">جار التحميل...</div> </div> </div> <!-- ======= قسم المانجا/المانهوا (المُحدّث بالكامل) ======= --> <div id="repository" class="section"> <div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div> <!-- تبويبات المستودعات --> <div class="repo-tabs" id="repoTabs"></div> <nav> <button id="tabSources" class="active" onclick="switchPanel('sources')">المصادر</button> <button id="tabExtensions" onclick="switchPanel('extensions')">الإضافات</button> </nav> <!-- لوحة المصادر الموحدة (كل ما تم استيراده يظهر هنا) --> <div id="panelSources" class="panel active"> <div class="hint">المصادر المستوردة ستظهر هنا. اضغط على "استيراد كمصدر" من أي إضافة في تبويب المستودع.</div> <div id="sourcesGrid" class="grid" aria-live="polite"></div> </div> <!-- لوحة الإضافات: تُظهِر تبويب المستودع المختار --> <div id="panelExtensions" class="panel" style="display:none"> <div class="hint">اختر تبويب مستودع أعلى لتحميل الإضافات. إذا ظهر تحذير CORS، استخدم خادم محلي أو الصق JSON يدوياً.</div> <!-- التحكم اليدوي (لصق JSON أو رابط) --> <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap"> <input id="repoUrlInput" class="input" placeholder="لصق رابط JSON لمستودع (raw GitHub)"/> <button class="btn" onclick="addRepoFromInput()">أضف مستودع</button> <button class="btn" onclick="loadPrepopulated()">تحميل المستودعات المضمّنة</button> </div> <div style="margin-top:10px"><textarea id="repoPaste" rows="5" style="width:100%;border-radius:8px;padding:8px;background:#0f0f12;color:#fff" placeholder='أو ألصق JSON هنا (مصفوفة أو كائن repository).'></textarea> <div style="margin-top:8px;display:flex;gap:8px"> <button class="btn" onclick="importFromPaste()">استيراد من النص</button> <button class="btn btn-ghost" onclick="clearRepos()">مسح المستودعات</button> </div> </div> <!-- عرض قائمة الإضافات للمستودع الحالي --> <div id="extensionsContainer" style="margin-top:14px"> <div id="extensionsGrid" class="grid"></div> </div> </div> </div> <div id="settings" class="section"> <p>الروايات ستظهر هنا لاحقًا.</p> </div> <!-- القائمة الجانبية --> <div class="sidebar" id="sidebar"> <a href="#" onclick="goToMembers()">الأعضاء</a> <button id="adminBtn" onclick="goToAdmin()" style="display:none;">لوحة التحكم</button> <button onclick="logout()">تسجيل الخروج</button> </div> <div class="overlay" id="overlay" onclick="toggleMenu()"></div> <script> /****************** إعداد Supabase الأصلي والمحاكاة ******************/ const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co"; const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg"; const supabase = window.supabase.createClient(supabaseUrl, supabaseKey); async function loadUser() { try { const { data, error } = await supabase.auth.getUser(); if (error || !data.user) return window.location.href = "index.html"; const { data: profile } = await supabase.from("profiles").select("username, role, avatar_url").eq("id", data.user.id).single(); document.getElementById("welcome").textContent = `مرحباً بك، ${profile?.username || "مستخدم"} 👋`; if (profile?.avatar_url) document.getElementById("profileImage").src = profile.avatar_url; if (["admin","owner"].includes((profile?.role||"").toLowerCase())) { document.getElementById("adminBtn").style.display = "block"; } } catch(e) { // لو Supabase فشل لأي سبب، نسمح للمستخدم بالمتابعة محلياً document.getElementById("welcome").textContent = `مرحباً بك، زائر — (Supabase غير متاح حالياً).`; } } loadUser(); /****************** وظائف واجهة عامة ******************/ function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); document.getElementById("overlay").classList.toggle("active"); } function logout() { supabase.auth?.signOut?.().then(()=> location.href='index.html').catch(()=> location.href='index.html'); } function goToMembers(){ location.href='index3.html' } function goToAdmin(){ location.href='index5.html' } function showSection(id){ document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active')); document.getElementById(id).classList.add('active'); // اجعل تبويب المصادر الافتراضي مرئيًا إن أردنا if(id==='repository') { switchPanel('extensions'); // نفتح إضافات أولاً كي ترى تبويبات المستودع } } /****************** حالة التطبيق (state) ******************/ const state = { repos: [], // [{name,url,loaded:boolean,items:[]}] currentRepoIndex: null, sources: [] // unified sources (المستوردة من الإضافات) }; /* --- قائمة مستودعات مضمّنة (raw links شائعة للبنية repo/index.min.json) --- */ const PREPOPULATED_REPOS = [ { name: "Keiyoushi", url: "https://raw.githubusercontent.com/keiyoushi/extensions/repo/index.min.json" }, { name: "ThePBone (revived)", url: "https://raw.githubusercontent.com/ThePBone/tachiyomi-extensions-revived/repo/index.min.json" }, { name: "Mihon (chaerun)", url: "https://raw.githubusercontent.com/chaerun/mihon-extensions/repo/index.min.json" }, { name: "Kaciin (examples)", url: "https://raw.githubusercontent.com/kaciin/tachiyomi-extensions-source/repo/index.min.json" } ]; /****************** رندر تبويبات المستودعات ******************/ function renderRepoTabs(){ const tabs = document.getElementById('repoTabs'); tabs.innerHTML = ''; state.repos.forEach((r, idx)=>{ const el = document.createElement('button'); el.className = 'repo-tab' + (state.currentRepoIndex===idx ? ' active' : ''); el.textContent = r.name || `repo ${idx+1}`; el.onclick = ()=> { selectRepo(idx); }; tabs.appendChild(el); }); if(state.repos.length===0){ const hint = document.createElement('div'); hint.className='small muted'; hint.style.marginTop='8px'; hint.textContent = 'لم يتم إضافة مستودعات. اضغط "تحميل المستودعات المضمّنة" أو ألصق رابط JSON.'; tabs.appendChild(hint); } } function selectRepo(idx){ state.currentRepoIndex = idx; renderRepoTabs(); // إذا لم يتم تحميله مسبقًا فاجلبه if(!state.repos[idx].loaded) fetchRepo(idx); else renderExtensionsGrid(state.repos[idx].items || []); } /****************** جلب وتحليل مستودع (مرن) ******************/ async function fetchRepo(idx){ const repo = state.repos[idx]; if(!repo) return; setDetails(`جاري جلب: ${repo.url}`); try { const res = await fetch(repo.url); if(!res.ok) throw new Error('HTTP ' + res.status); const json = await res.json(); // تحليل مرن: نبحث عن بنى شائعة let extensions = []; if(Array.isArray(json)) { // مصفوفة مباشرة: غالباً امتدادات أو عناصر repo json.forEach(it => { // محادثة شائعة: {name,lang,version,apk,url,links} أو عناصر repo if(it && (it.name && (it.url || it.apk || it.repo || it.index))) { extensions.push(normalizeExtension(it)); } else { // أضف كـ raw item لكي ترى شيئاً extensions.push({ title: it.name || it.title || JSON.stringify(it).slice(0,40), raw: it }); } }); } else if(json.repositories && Array.isArray(json.repositories)) { json.repositories.forEach(it=> extensions.push(normalizeExtension(it))); } else if(json.extensions && Array.isArray(json.extensions)) { json.extensions.forEach(it=> extensions.push(normalizeExtension(it))); } else if(json.sources && Array.isArray(json.sources)) { json.sources.forEach(it=> extensions.push(normalizeExtension(it))); } else { // ربما هذا الملف هو index يحتوي حقول أخرى؛ حاول استنتاج العناصر // إذا كان الكائن يحتوي على مفاتيح تشير إلى امتدادات: const maybe = []; Object.keys(json).forEach(k=>{ if(Array.isArray(json[k])) { json[k].forEach(it => { if(it && (it.name || it.title)) maybe.push(it); }); } }); if(maybe.length>0){ maybe.forEach(it=>extensions.push(normalizeExtension(it))); } else { // لا بنية معروفة: خزّن الـ JSON كـ عنصر واحد extensions.push({ title: repo.name || repo.url, raw: json }); } } // خزّن النتائج repo.items = extensions; repo.loaded = true; renderRepoTabs(); // لو هذا هو المستودع المُختار الآن، اعرضه if(state.currentRepoIndex === idx) renderExtensionsGrid(extensions); setDetails(`تم تحميل المستودع: ${repo.name} — ${extensions.length} عناصر.`); } catch(err){ console.error(err); repo.loaded = false; setDetails(`فشل تحميل repo: ${repo.url} — ${err.message}. إذا ظهر "CORS" استخدم خادم محلي أو الصق JSON يدوياً.`); alert(`فشل جلب المستودع (${repo.name}): ${err.message}\nمشكلة شائعة: CORS. شغّل الصفحة عبر سيرفر محلي أو الصق JSON.`); } } function normalizeExtension(it){ // نجرب استخراج الحقول المفيدة بأقل قدر من الفشل const title = it.title || it.name || it.id || it.pkg || it.apk || 'إضافة'; const lang = it.lang || it.language || it.languages || (it.availableLanguages ? it.availableLanguages.join(',') : ''); const description = it.description || it.desc || it.summary || ''; // أيقونة/صورة ممكن أن تظهر في بعض المستودعات const icon = it.icon || it.logo || it.image || it.cover || (it.thumbnail || null); // رابط فعلي قد يكون داخل url, repo, index, apk, link const url = it.url || it.repo || it.index || it.apk || it.link || it.json || null; return { title, lang, description, icon, url, raw: it }; } /****************** رندر الإضافات (بطاقات شبيهة بتاشيومي) ******************/ function renderExtensionsGrid(items){ const grid = document.getElementById('extensionsGrid'); grid.innerHTML = ''; if(!items || items.length===0){ grid.innerHTML = '<div class="muted">لا توجد إضافات في هذا المستودع أو البنية غير مدعومة.</div>'; return; } items.forEach((ex, i) => { const card = document.createElement('div'); card.className = 'card'; const thumbUrl = ex.icon || placeholderThumb(ex.title); card.innerHTML = ` <div class="ext-card"> <img class="ext-thumb" src="${escapeHtml(thumbUrl)}" onerror="this.src='${placeholderThumb(ex.title)}'"/> <div class="ext-body"> <div style="display:flex;justify-content:space-between;align-items:flex-start"> <div> <div class="ext-title">${escapeHtml(ex.title)}</div> <div class="ext-meta">${escapeHtml(ex.lang || (ex.raw && ex.raw.language) || '')}</div> </div> <div style="text-align:left"> <button class="btn" onclick="importAsSource(${state.currentRepoIndex}, ${i})">استيراد كمصدر</button> </div> </div> <div class="small muted" style="margin-top:6px">${escapeHtml(shorten(ex.description || (ex.raw && ex.raw.summary) || 'لا وصف متاح'))}</div> <div class="small muted" style="margin-top:8px">رابط: ${escapeHtml(ex.url || (ex.raw && guessUrlFromRaw(ex.raw)) || '—')}</div> </div> </div> `; grid.appendChild(card); }); } /****************** استيراد كـ مصدر (ينتقل إلى panelSources) ******************/ function importAsSource(repoIdx, extIdx){ const repo = state.repos[repoIdx]; if(!repo || !repo.items || !repo.items[extIdx]) return; const ex = repo.items[extIdx]; // نمط المصدر النهائي: name, url, raw const sourceObj = { name: ex.title || ex.raw?.name || 'مصدر', url: ex.url || guessUrlFromRaw(ex.raw) || repo.url, raw: ex.raw || null }; // تجنب التكرار حسب url أو name if(state.sources.some(s => (s.url && s.url===sourceObj.url) || (s.name && s.name===sourceObj.name))){ alert('هذا المصدر موجود بالفعل في قائمة المصادر.'); return; } state.sources.push(sourceObj); renderSourcesGrid(); // انتقل مباشرة إلى tab المصادر الموحدة switchPanel('sources'); setDetails(`استوردت: ${sourceObj.name}`); } /****************** عرض المصادر الموحدة ******************/ function renderSourcesGrid(){ const grid = document.getElementById('sourcesGrid'); grid.innerHTML = ''; if(state.sources.length===0){ grid.innerHTML = '<div class="muted">لم تقم باستيراد أي مصدر بعد.</div>'; return; } state.sources.forEach((s, idx) => { const d = document.createElement('div'); d.className='card'; d.innerHTML = ` <div style="display:flex;justify-content:space-between;align-items:center"> <div> <div style="font-weight:800">${escapeHtml(s.name)}</div> <div class="small muted" style="margin-top:6px">${escapeHtml(s.url)}</div> </div> <div style="display:flex;gap:8px"> <button class="btn" onclick="openSource(${idx})">افتح المصدر</button> <button class="btn" style="background:#c94a4a" onclick="removeSource(${idx})">حذف</button> </div> </div> `; grid.appendChild(d); }); } function openSource(idx){ // محاولة سريعة: لو المصدر يحتوي على raw.manga اعرضها، وإلا حاول fetch(s.url) const s = state.sources[idx]; if(!s) return; setDetails(`فتح المصدر: ${s.name}`); if(s.raw && Array.isArray(s.raw.manga)){ showMangaList(s.raw.manga, s); return; } // محاولة fetch (احتمال CORS) (async ()=>{ try{ const res = await fetch(s.url); if(!res.ok) throw new Error('HTTP '+res.status); const json = await res.json(); if(Array.isArray(json)) { showMangaList(json, s); return; } if(json.manga && Array.isArray(json.manga)) { showMangaList(json.manga, s); return; } alert('هذا المصدر لا يحتوي على قائمة مانجا بمعيارية مفهومة. راجع البنية أو الصق JSON يدوياً.'); }catch(e){ console.error(e); alert('فشل فتح المصدر — ربما CORS أو بنية غير متوقعة. جرب تشغيل الصفحة عبر خادم محلي أو الصق JSON يدوياً.'); setDetails('فشل فتح المصدر: ' + e.message); } })(); } function showMangaList(list, source){ // عرض مبسّط للمانجا في منطقة extensionsGrid — نستخدم نفس الـ panel لعرض القائمة const panel = document.getElementById('extensionsGrid'); panel.innerHTML = ''; if(!Array.isArray(list) || list.length===0){ panel.innerHTML = '<div class="muted">لم أعثر على مانجا في هذا المصدر.</div>'; return; } list.forEach(m => { const card = document.createElement('div'); card.className='card'; const thumb = (m.image || m.thumbnail || m.cover) || placeholderThumb(m.title || m.name); card.innerHTML = ` <div style="display:flex;gap:10px;align-items:flex-start"> <img src="${escapeHtml(thumb)}" class="ext-thumb" onerror="this.src='${placeholderThumb(m.title||m.name)}'"/> <div style="flex:1"> <div style="font-weight:800">${escapeHtml(m.title||m.name||'مانجا')}</div> <div class="small muted" style="margin-top:6px">${escapeHtml(m.description||m.summary||'لا وصف')}</div> <div style="margin-top:8px;display:flex;gap:8px"> <button class="btn" onclick='openManga(${JSON.stringify(escapeJson(m))})'>عرض الفصول</button> <a class="btn btn-ghost" href="${escapeHtml(m.url||m.link||m.page||'#')}" target="_blank">صفحة المصدر</a> </div> </div> </div> `; panel.appendChild(card); }); } function openManga(mB64){ const m = JSON.parse(unescapeJson(mB64)); // نحاول جلب الفصول من m.chapters أو m.chaptersUrl if(Array.isArray(m.chapters) && m.chapters.length>0){ showChaptersInPanel(m.chapters, m); return; } if(m.chaptersUrl){ (async ()=>{ try{ const res = await fetch(m.chaptersUrl); if(!res.ok) throw new Error('HTTP '+res.status); const json = await res.json(); if(Array.isArray(json)) showChaptersInPanel(json, m); else alert('بنية الفصول غير متوقعة.'); }catch(e){ alert('فشل جلب الفصول: '+e.message + ' (ربما CORS)'); console.error(e); } })(); return; } alert('لا يوجد رابط فصول واضح في هذا الكائن.'); } function showChaptersInPanel(chapters, manga){ const panel = document.getElementById('extensionsGrid'); panel.innerHTML = ''; chapters.forEach(ch=>{ const d = document.createElement('div'); d.className='card'; d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"> <div> <div style="font-weight:800">${escapeHtml(ch.title||ch.name||'فصل')}</div> <div class="small muted">${escapeHtml(ch.date||'')}</div> </div> <div style="display:flex;gap:8px"> <a class="btn" href="${escapeHtml(ch.chapterUrl||ch.url||ch.readUrl||'#')}" target="_blank">فتح</a> ${Array.isArray(ch.images) ? `<button class="btn" onclick='openReader(${JSON.stringify(escapeJson(ch))})'>اقرأ</button>` : ''} </div> </div>`; panel.appendChild(d); }); } function openReader(chB64){ const ch = JSON.parse(unescapeJson(chB64)); // نفتح نافذة جديدة ونضع الصور const w = window.open('','_blank'); let html = `<html dir="rtl"><head><meta charset="utf-8"><title>${escapeHtml(ch.title||'القارئ')}</title></head><body style="background:#0f0f12;color:#fff;font-family:Cairo;padding:12px">`; if(Array.isArray(ch.images) && ch.images.length>0){ ch.images.forEach(img => html += `<img src="${escapeHtml(img)}" style="display:block;max-width:100%;margin:12px auto;border-radius:8px" />`); } else { html += `<p class="small">لا صور متاحة. افتح الرابط الأصلي.</p><a href="${escapeHtml(ch.chapterUrl||'#')}" target="_blank" class="btn">فتح الفصل</a>`; } html += '</body></html>'; w.document.write(html); w.document.close(); } /****************** أدوات إدارة المستودعات يدوياً ******************/ function addRepoFromInput(){ const url = (document.getElementById('repoUrlInput').value||'').trim(); if(!url) return alert('أدخل رابط JSON للمستودع'); state.repos.push({name: url.split('/').slice(-2,-1)[0]||url, url, loaded:false, items:[]}); document.getElementById('repoUrlInput').value=''; renderRepoTabs(); } function loadPrepopulated(){ PREPOPULATED_REPOS.forEach(r=> state.repos.push({name:r.name,url:r.url, loaded:false, items:[]})); renderRepoTabs(); // اختَر الأول تلقائياً if(state.repos.length>0) selectRepo(0); } function importFromPaste(){ const txt = document.getElementById('repoPaste').value.trim(); if(!txt) return alert('ألصق JSON أولاً'); try{ const json = JSON.parse(txt); if(Array.isArray(json)) { // نضيف كل عنصر كمستودع إن كان يحتوي url أو name json.forEach(it=> { if(it && (it.url||it.name)) state.repos.push({name: it.name||it.title||'repo', url: it.url||it.repo||it.index, loaded:false, items:[]}); else state.repos.push({name:'repo-pasted', url: '', loaded:false, items:[normalizeExtension(it)]}); }); } else if(json.name && json.url){ state.repos.push({name: json.name, url: json.url, loaded:false, items:[]}); } else { // ربما الملف نفسه يحتوي قائمة إضافات -> خزّن كـ repo محلي state.repos.push({name:'repo-pasted', url:'(pasted)', loaded:true, items:Array.isArray(json)?json:[json]}); } document.getElementById('repoPaste').value=''; renderRepoTabs(); } catch(e){ alert('JSON غير صالح'); console.error(e); } } function clearRepos(){ if(confirm('مسح كل المستودعات؟')){ state.repos=[]; state.currentRepoIndex=null; renderRepoTabs(); document.getElementById('extensionsGrid').innerHTML=''; } } /****************** أدوات صغيرة ومساعدة ----------------- */ function placeholderThumb(text){ // غلاف افتراضي جميل بطريقة بسيطة (يستخدم خدمة placeholder) const t = encodeURIComponent((text||'cover').slice(0,20)); return `https://via.placeholder.com/160x240.png?text=${t}&bg=111111&fg=d9d0ff`; } function shorten(s, n=120){ return s && s.length>n ? s.slice(0,n-1)+'…' : s || ''; } function guessUrlFromRaw(raw){ if(!raw) return ''; return raw.url || raw.repo || raw.index || raw.apk || raw.link || ''; } function setDetails(txt){ document.getElementById('repoTabs').title = txt; /* ثانوي */ } /* ---- switch panel sources/extensions ---- */ function switchPanel(p){ document.getElementById('panelSources').style.display = p==='sources' ? 'block' : 'none'; document.getElementById('panelExtensions').style.display = p==='extensions' ? 'block' : 'none'; document.getElementById('tabSources').classList.toggle('active', p==='sources'); document.getElementById('tabExtensions').classList.toggle('active', p==='extensions'); } /* ---- إزالة مصدر موحّد ---- */ function removeSource(i){ if(confirm('حذف المصدر؟')){ state.sources.splice(i,1); renderSourcesGrid(); } } /* ---- مساعدة JSON -> escape/unescape للأزرار التي تمرر كـ onclick ---- */ function escapeJson(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); } function unescapeJson(b64){ return decodeURIComponent(escape(atob(b64))); } /* ---- وظائف للمستخدم: render initial UI ---- */ renderRepoTabs(); renderSourcesGrid(); /* ---- دوال مساعدة لأمان HTML ---- */ function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); } /*********** ملاحظة تقنية نهائية (مهمة): *********** - معظم روابط raw من GitHub تعمل لكن المتصفّح يمنع fetch بسبب CORS عند تشغيل الملف محلياً (file://). - لتفادي ذلك شغّل الصفحة عبر سيرفر محلي (python -m http.server أو npx serve) أو الصق JSON يدوياً في الحقل المخصص. - إذا أردت، أضيف زر لإستخدام proxy (مثل https://cors.bridged.cc/) لكن هذا يعتمد على اتصال خارجي وغير آمن دائماً. ***************************************************/ </script> </body> </html> 

