<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù‡ÙŠØ¨Ø©</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: linear-gradient(135deg,#1a1a2e,#0f0f1a); color:#e0e0e0; font-family:"Tahoma",sans-serif; }
  .container{margin-top:40px}
  h2{ text-align:center;color:#f97316;margin-bottom:20px;font-weight:700;letter-spacing:1px;text-shadow:1px 1px 5px #000}
  table{ background:#2b2b3d;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.5) }
  th{ background:linear-gradient(90deg,#11121a,#1b1b2f); color:#f97316; font-weight:700 }
  td{ vertical-align:middle; font-size:13px }
  .btn-action{ margin:3px; font-size:12px; border-radius:6px; font-weight:700; padding:6px 8px }
  .block{ background:#dc2626;color:#fff;border:none }
  .unblock{ background:#16a34a;color:#fff;border:none }
  .promote{ background:#f97316;color:#fff;border:none }
  .demote{ background:#2563eb;color:#fff;border:none }
  .delete{ background:#4b5563;color:#fff;border:none }
  .ban{ background:#7c2d12;color:#fff;border:none }
  .status-box{ text-align:center;padding:10px;border-radius:6px;margin-bottom:15px;font-weight:700;text-shadow:1px 1px 3px #000 }
  .status-info{ background:#27273d;color:#cbd5e1 }
  .status-error{ background:#7f1d1d;color:#fee2e2 }
  .muted-badge{ background:#11121a;color:#f97316;padding:4px 8px;border-radius:6px;font-weight:700 }
  @media (max-width:700px){ td, th{font-size:12px} .btn-action{font-size:11px;padding:5px 6px} }
</style>
</head>
<body>
<div class="container">
  <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù‡ÙŠØ¨Ø©</h2>
  <div id="statusBox" class="status-box status-info">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead>
        <tr><th>ID</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>
</div>

<script>
/*
  Ù†Ø³Ø®Ø© HTML Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙƒØ±Ø¨Øª:
  - Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙƒØ±Ø¨Øª (SCRIPT_URL) ØªÙ… ØªØ²ÙˆÙŠØ¯Ù‡ Ù…Ù† Ø·Ø±ÙÙƒ.
  - CURRENT_ROLE: Ø¹ÙŠÙ‘Ù†Ù‡ "owner" Ø£Ùˆ "admin" Ø­Ø³Ø¨ Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙˆØ­Ø©.
  - secret ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ ADMIN_SECRET ÙÙŠ Ø§Ù„Ø³ÙƒØ±Ø¨Øª.
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxb2Fe2mSZJ_OTS2vzjSYeVpqlHWZjyz222dGyXqJ6Bgu0cMy1qFOEeUFPxrY4Fz8iV/exec";
const ADMIN_SECRET = "mySecret123";
const CURRENT_ROLE = "owner"; // ØºÙŠÙ‘Ø±Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©: "owner" Ø£Ùˆ "admin"

const statusBox = document.getElementById("statusBox");
const tbody = document.getElementById("usersTable");

function setStatus(msg, isError=false){
  statusBox.textContent = msg;
  statusBox.className = "status-box " + (isError ? "status-error" : "status-info");
}

async function fetchUsers(){
  setStatus("Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
  try{
    const url = `${SCRIPT_URL}?secret=${encodeURIComponent(ADMIN_SECRET)}&action=list_users&currentRole=${encodeURIComponent(CURRENT_ROLE)}`;
    const res = await fetch(url, { method: "GET", mode: "cors" });
    const data = await res.json();
    if(data.error) throw new Error(data.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±");

    renderUsers(data.users || []);
    setStatus("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­.");
  } catch (err){
    console.error("fetchUsers error:", err);
    setStatus("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + (err.message || err), true);
  }
}

function renderUsers(users){
  tbody.innerHTML = "";
  if(!users || users.length === 0){
    tbody.innerHTML = `<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>`;
    return;
  }

  users.forEach(user=>{
    const id = user.id ?? "-";
    const username = user.username ?? "";
    const email = user.email ?? "-";
    const status = user.status ?? "-";
    const role = (user.role || "user").toString().toLowerCase();

    // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø£ÙˆÙ†Ø±
    const displayName = role === "owner" ? "ğŸ‘‘" : (username || "-");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(id)}</td>
      <td>${escapeHtml(displayName)}</td>
      <td>${escapeHtml(email)}</td>
      <td>${escapeHtml(status)}</td>
      <td>${escapeHtml(role)}</td>
      <td></td>
    `;
    const actionsCell = tr.querySelector("td:last-child");

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:
    // - Ù„Ø§ ØªÙØ¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ù„Ø£ÙŠ ØµÙ Ø¯ÙˆØ±Ù‡ owner (Ù„Ø§ ØªØªØµØ±Ù Ø¹Ù„Ù‰ Ù…Ø§Ù„ÙƒÙŠÙ†)
    // - admin ÙŠÙ…ÙƒÙ†Ù‡ ÙÙ‚Ø· ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† (user)
    // - owner ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„ Ù…Ø§ Ø¹Ø¯Ø§ Ù…Ø§Ù„ÙƒÙŠÙ† Ø¢Ø®Ø±ÙŠÙ† (Ø£ÙŠ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù„ÙŠ role === "owner" Ù„Ù† ØªÙØ¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø±)
    const current = (CURRENT_ROLE || "admin").toLowerCase();
    const targetRole = role;

    const ownerRow = targetRole === "owner";
    const adminRow = targetRole === "admin";

    const canEdit = (current === "owner" && !ownerRow) || (current === "admin" && !adminRow && !ownerRow && targetRole === "user");

    if(!canEdit){
      // Ø¹Ø±Ø¶ Ø¨Ø§Ø¯Ø¬ Ù…Ø®ØªØµØ± ÙŠÙˆØ¶Ø­ Ø§Ù„Ø³Ø¨Ø¨ (Ø£ÙˆÙ†Ø±/Ù…Ø³Ø¤ÙˆÙ„) Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø© Ù†Ø§Ù‚ØµØ©
      const badge = document.createElement("span");
      badge.className = "muted-badge";
      badge.textContent = ownerRow ? "Ø£ÙˆÙ†Ø±" : (adminRow ? "Ù…Ø³Ø¤ÙˆÙ„" : "-");
      actionsCell.appendChild(badge);
    } else {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ Ø§Ù„Ø§Ø³ÙƒØ±Ø¨Øª (action names)
      const btn = (label, cls, action) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = `btn-action ${cls}`;
        b.textContent = label;
        b.onclick = async () => {
          const ok = confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${label} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (${id})ØŸ`);
          if(!ok) return;
          b.disabled = true;
          b.classList.add("opacity-50");
          try {
            await adminAction(action, id);
          } finally {
            b.disabled = false;
            b.classList.remove("opacity-50");
          }
        };
        return b;
      };

      actionsCell.appendChild(btn("Ø­Ø¸Ø±","block","block"));
      actionsCell.appendChild(btn("Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±","unblock","unblock"));
      actionsCell.appendChild(btn("ØªØ±Ù‚ÙŠØ©","promote","promote"));
      actionsCell.appendChild(btn("ØªØ®ÙÙŠØ¶","demote","demote"));
      actionsCell.appendChild(btn("Ø­Ø¸Ø± Ù†Ù‡Ø§Ø¦ÙŠ","ban","ban"));
      actionsCell.appendChild(btn("Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨","delete","delete_account"));
    }

    tbody.appendChild(tr);
  });
}

async function adminAction(action, userId){
  setStatus(`Ø¬Ø§Ø±Ù ØªÙ†ÙÙŠØ° ${action} Ø¹Ù„Ù‰ ${userId}...`);
  try{
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        secret: ADMIN_SECRET,
        action: action,
        userId: userId,
        currentRole: CURRENT_ROLE
      })
    });
    const data = await res.json();
    if(data.error){
      // Ø±Ø³Ø§Ù„Ø© Ù…ÙÙ‡ÙˆÙ…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      throw new Error(data.error + (data.details ? " â€” " + JSON.stringify(data.details) : ""));
    }
    alert(data.result || "ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­");
    await fetchUsers();
  } catch (err){
    console.error("adminAction error:", err);
    alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: " + (err.message || err));
    setStatus("ÙØ´Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: " + (err.message || err), true);
  }
}

// Ø¨Ø³ÙŠØ· ÙˆØ¢Ù…Ù†: Ù‡Ø±ÙˆØ¨ Ù…Ø­ØªÙˆÙ‰ Ù„Ù…Ù†Ø¹ XSS Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† API
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'", "&#039;");
}

// Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„
fetchUsers();
</script>
</body>
</html>
