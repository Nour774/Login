<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Manga Sanctum</title>
  <link rel="icon" href="images/book.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; transition: 0.3s ease; }
    body {
      margin: 0;
      font-family: "Cairo", sans-serif;
      background: radial-gradient(circle at 50% 10%, #0b0b10, #050505 90%);
      color: #eaeaea;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .back-btn {
      color: #eaeaea;
      font-size: 18px;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
    }
    .back-btn:hover { background: rgba(255,255,255,0.12); }

    .logo-text {
      font-weight: 800;
      font-size: 26px;
      color: #d4c3ff;
      letter-spacing: 1px;
    }

    .manga-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 50px 20px 30px;
      z-index: 5;
    }

    .manga-header img {
      width: 220px;
      height: 310px;
      object-fit: cover;
      border-radius: 14px;
      box-shadow: 0 0 50px rgba(168,139,255,0.4);
    }

    .manga-title {
      font-size: 30px;
      font-weight: 800;
      margin-top: 16px;
      background: linear-gradient(90deg, #a88bff, #e6c07b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .manga-description {
      max-width: 800px;
      margin-top: 10px;
      color: #bdb3d6;
      font-size: 16px;
      line-height: 1.8;
    }

    /* --- الوسوم --- */
    .tags-container {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .tag {
      background: rgba(168,139,255,0.1);
      border: 1px solid rgba(168,139,255,0.3);
      color: #cbb9ff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }
    .tag:hover {
      background: rgba(168,139,255,0.25);
      color: #fff;
      transform: scale(1.05);
    }

    /* --- التقييم --- */
    .rating-section {
      margin-top: 25px;
      text-align: center;
    }

    .stars {
      display: inline-flex;
      flex-direction: row-reverse;
      gap: 5px;
      cursor: pointer;
    }

    .star {
      font-size: 30px;
      color: rgba(168,139,255,0.3);
      transition: color 0.3s ease, transform 0.2s;
    }

    .star:hover,
    .star.active {
      color: #e6c07b;
      transform: scale(1.2);
    }

    .rating-info {
      margin-top: 8px;
      font-size: 14px;
      color: #bdb3d6;
    }

    footer {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <div class="back-btn" onclick="history.back()">⮌ عودة</div>
    <div class="logo-text">Manga Sanctum</div>
  </header>

  <div id="mangaInfo" class="manga-header">
    <img id="cover" src="" alt="غلاف المانجا">
    <div class="manga-title" id="title">جار التحميل...</div>
    <div class="manga-description" id="description"></div>
    <div id="tagsContainer" class="tags-container"></div>

    <!-- ⭐ التقييم -->
    <div class="rating-section">
      <div id="stars" class="stars"></div>
      <div id="ratingInfo" class="rating-info">جار تحميل التقييم...</div>
    </div>
  </div>

  <footer>© 2025 Manga Sanctum | Realm of Shadows & Light</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const mangaId = new URLSearchParams(window.location.search).get("manga_id");

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user;
    }

    async function loadMangaInfo() {
      const { data: manga } = await supabase
        .from("manga_list")
        .select("title, description, cover_url, tags")
        .eq("id", mangaId)
        .single();

      if (!manga) return;
      document.getElementById("title").textContent = manga.title;
      document.getElementById("description").textContent = manga.description || "لا يوجد وصف.";
      document.getElementById("cover").src = manga.cover_url;

      const tagsContainer = document.getElementById("tagsContainer");
      tagsContainer.innerHTML = "";
      if (manga.tags) {
        manga.tags.split(",").map(t => t.trim()).forEach(tag => {
          const el = document.createElement("div");
          el.className = "tag";
          el.textContent = tag;
          el.onclick = () => window.location.href = `index13.html?tag=${encodeURIComponent(tag)}`;
          tagsContainer.appendChild(el);
        });
      }

      loadRating();
    }

    async function loadRating() {
      const user = await getUser();
      const { data: avg } = await supabase
        .from("manga_ratings")
        .select("rating", { count: "exact" })
        .eq("manga_id", mangaId);

      const allRatings = avg?.map(r => r.rating) || [];
      const avgValue = allRatings.length ? (allRatings.reduce((a,b)=>a+b,0)/allRatings.length).toFixed(1) : 0;

      const starsDiv = document.getElementById("stars");
      starsDiv.innerHTML = "";

      for (let i = 5; i >= 1; i--) {
        const star = document.createElement("span");
        star.textContent = "★";
        star.className = "star";
        star.onclick = () => user ? submitRating(i) : alert("الرجاء تسجيل الدخول لتقييم المانجا");
        starsDiv.appendChild(star);
      }

      // لون النجوم حسب المتوسط
      highlightStars(Math.round(avgValue));

      const info = document.getElementById("ratingInfo");
      info.textContent = `متوسط التقييم: ${avgValue} (${allRatings.length} تقييم)`;
    }

    function highlightStars(rating) {
      document.querySelectorAll(".star").forEach((star, index) => {
        star.classList.toggle("active", 5 - index <= rating);
      });
    }

    async function submitRating(rating) {
      const user = await getUser();
      if (!user) return;

      await supabase
        .from("manga_ratings")
        .upsert([{ manga_id: mangaId, user_id: user.id, rating }], { onConflict: ["manga_id", "user_id"] });

      loadRating();
    }

    loadMangaInfo();
  </script>
</body>
</html>
