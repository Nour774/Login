<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Manga Sanctum - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ù†Ø¬Ø§</title>
<link rel="icon" href="images/book.png">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
/* --- Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ --- */
body {
  margin: 0;
  font-family: "Cairo", sans-serif;
  background: radial-gradient(circle at 50% 10%, #0b0b10, #050505 90%);
  color: #eaeaea;
  overflow-x: hidden;
  min-height: 100vh;
  position: relative;
}

/* --- Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© --- */
.fog {
  position: fixed;
  top: 0; left: 0;
  width: 200%; height: 200%;
  background: url('images/fog.png') repeat;
  opacity: 0.15;
  animation: fogMove 120s linear infinite;
  z-index: 0;
  pointer-events: none;
  transform: translate(-25%, -25%);
}
@keyframes fogMove {0% {background-position:0 0;}50%{background-position:1000px 800px;}100%{background-position:0 0;}}

.symbols {
  position: fixed; top:0; left:0; width:100%; height:100%;
  pointer-events:none; z-index:1; overflow:hidden;
}
.symbol { position:absolute; color: rgba(168,139,255,0.08); font-size:22px; animation: floatSymbol 30s linear infinite; user-select:none;}
@keyframes floatSymbol {0%{transform:translateY(100vh) rotate(0deg);opacity:0;}10%{opacity:1;}90%{opacity:1;}100%{transform:translateY(-10vh) rotate(360deg);opacity:0;}}

/* --- Ø§Ù„Ø±Ø£Ø³ --- */
header { display:flex; justify-content:space-between; align-items:center; padding:14px 20px; background: rgba(10,10,15,0.85); backdrop-filter: blur(10px); border-bottom:1px solid rgba(255,255,255,0.05); position: sticky; top:0; z-index:10;}
.back-btn { color:#eaeaea; font-size:18px; cursor:pointer; padding:8px 14px; border-radius:8px; background: rgba(255,255,255,0.05);}
.back-btn:hover {background: rgba(255,255,255,0.12);}
.logo-text { font-weight:800; font-size:26px; color:#d4c3ff; letter-spacing:1px; user-select:none;}

/* --- Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ --- */
.manga-header { display:flex; flex-direction:column; align-items:center; text-align:center; padding:50px 20px 30px; position:relative; z-index:5;}
.manga-header img { width:220px; height:310px; object-fit:cover; border-radius:14px; box-shadow:0 0 50px rgba(168,139,255,0.4);}
.manga-title { font-size:30px; font-weight:800; margin-top:16px; background: linear-gradient(90deg, #a88bff, #e6c07b); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 0 10px rgba(168,139,255,0.5);}
.manga-description { max-width:800px; margin-top:10px; color:#bdb3d6; font-size:16px; line-height:1.8;}

/* --- Ø§Ù„ÙˆØ³ÙˆÙ… --- */
.tags-container { margin-top:20px; display:flex; flex-wrap:wrap; justify-content:center; gap:10px;}
.tag { background: rgba(168,139,255,0.1); border:1px solid rgba(168,139,255,0.3); color:#cbb9ff; padding:6px 14px; border-radius:20px; font-size:14px; cursor:pointer; transition:0.2s;}
.tag:hover { background: rgba(168,139,255,0.25); color:#fff; transform:scale(1.05); }

/* --- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… --- */
.stars { display:inline-flex; flex-direction: row-reverse; gap:5px; cursor:pointer; margin-top:10px;}
.star { font-size:30px; color: rgba(168,139,255,0.3); position: relative; display:inline-block;}
.star.full { color:#e6c07b;}
.star.half::before { content:"â˜…"; position:absolute; left:0; width:50%; overflow:hidden; color:#e6c07b;}

/* --- Ø§Ù„Ù…ÙƒØªØ¨Ø© --- */
.library-btn { margin-top:10px; background: rgba(168,139,255,0.2); color:#eaeaea; border:1px solid rgba(168,139,255,0.4); border-radius:8px; padding:8px 16px; cursor:pointer;}

/* --- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª --- */
.comment-box { margin-top:20px; width:100%; max-width:600px;}
.comment-box textarea { width:100%; background: rgba(255,255,255,0.05); color:#fff; border:1px solid rgba(168,139,255,0.3); border-radius:8px; padding:10px; resize:none;}
.comment-box button { margin-top:8px; background: rgba(168,139,255,0.2); color:#cbb9ff; border:1px solid rgba(168,139,255,0.3); border-radius:8px; padding:6px 12px; cursor:pointer;}
.comments-list { margin-top:15px; max-width:600px; }
.comment { background: rgba(255,255,255,0.03); border-radius:8px; padding:10px; margin-bottom:8px; font-size:14px;}

/* --- Ø§Ù„ÙØµÙˆÙ„ --- */
.chapter-search { margin-bottom:15px; max-width:600px; margin-inline:auto;}
.chapter-search input { width:100%; background: rgba(255,255,255,0.05); border:1px solid rgba(168,139,255,0.3); border-radius:8px; padding:8px; color:#fff;}
.chapters-list { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; max-width:600px; margin-inline:auto;}
.chapter-item { background: rgba(168,139,255,0.08); border-radius:8px; padding:10px; text-align:center; cursor:pointer; transition:0.3s;}
.chapter-item:hover { background: rgba(168,139,255,0.2);}
</style>
</head>
<body>
<div class="fog"></div>
<div class="symbols" id="symbols"></div>

<header>
  <div class="back-btn" onclick="history.back()">â®Œ Ø¹ÙˆØ¯Ø©</div>
  <div class="logo-text">Manga Sanctum</div>
</header>

<div class="manga-header">
  <img id="cover" src="" alt="ØºÙ„Ø§Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§">
  <div class="manga-title" id="title">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  <div class="manga-description" id="description"></div>
  <div id="tagsContainer" class="tags-container"></div>

  <div class="stars" id="stars"></div>
  <div id="ratingInfo" class="rating-info"></div>
  <button class="library-btn" onclick="addToLibrary()">ğŸ“š Ø£Ø¶Ù Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨ØªÙŠ</button>

  <div class="comment-box">
    <textarea id="commentInput" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
    <button onclick="addComment()">Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚</button>
  </div>
  <div id="commentsList" class="comments-list"></div>
</div>

<div class="chapter-search">
  <input type="text" id="chapterSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„..." oninput="filterChapters()">
</div>
<div id="chaptersList" class="chapters-list"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const mangaId = new URLSearchParams(window.location.search).get("manga_id");

let userId = localStorage.getItem("user_id");
if(!userId){ userId=crypto.randomUUID(); localStorage.setItem("user_id",userId); }

const SYMBOLS = ["â˜½","âœ¦","âœ¶","â›§","â˜¥","â™†","å","âšš"];
function spawnSymbols(){
  const c = document.getElementById("symbols");
  for(let i=0;i<20;i++){
    const s=document.createElement("div");
    s.className="symbol";
    s.textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
    s.style.left=Math.random()*100+"%";
    s.style.animationDelay=Math.random()*30+"s";
    s.style.fontSize=16+Math.random()*24+"px";
    c.appendChild(s);
  }
}
spawnSymbols();

async function loadManga(){
  const {data,error} = await supabase.from("manga_list").select("*").eq("id",mangaId).single();
  if(error||!data) return console.error(error);
  document.getElementById("title").textContent=data.title;
  document.getElementById("description").textContent=data.description||"Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.";
  document.getElementById("cover").src=data.cover_url;

  const tagsContainer=document.getElementById("tagsContainer");
  tagsContainer.innerHTML="";
  if(data.tags){
    data.tags.split(",").map(t=>t.trim()).forEach(tag=>{
      const el=document.createElement("div");
      el.className="tag";
      el.textContent=tag;
      el.onclick=()=>window.location.href=`index13.html?tag=${encodeURIComponent(tag)}`;
      tagsContainer.appendChild(el);
    });
  }
  loadRating();
  loadComments();
  loadChapters();
}

async function loadRating(){
  const {data,error} = await supabase.from("manga_ratings").select("rating").eq("manga_id",mangaId);
  if(error) return console.error(error);

  let avg=0;
  if(data.length>0){ avg=data.reduce((sum,r)=>sum+r.rating,0)/data.length; }
  const starsDiv=document.getElementById("stars");
  starsDiv.innerHTML="";
  for(let i=1;i<=5;i++){
    const star=document.createElement("span");
    star.className="star";
    star.onclick=()=>rateManga(i);
    if(i<=Math.floor(avg)){ star.classList.add("full"); star.textContent="â˜…"; }
    else if(i-0.5<=avg){ star.classList.add("half"); star.textContent="â˜†"; }
    else star.textContent="â˜†";
    starsDiv.appendChild(star);
  }
  document.getElementById("ratingInfo").textContent=`${avg.toFixed(1)} Ù…Ù† 5 (${data.length} ØªÙ‚ÙŠÙŠÙ…)`;
}

async function rateManga(rating){
  const {error} = await supabase.from("manga_ratings")
    .upsert({manga_id:mangaId,user_id:userId,rating:rating},{onConflict:["manga_id","user_id"]});
  if(error) return console.error(error);
  loadRating();
}

function addToLibrary(){
  let lib = JSON.parse(localStorage.getItem("library")||"[]");
  if(!lib.includes(mangaId)) lib.push(mangaId);
  localStorage.setItem("library",JSON.stringify(lib));
  alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨ØªÙƒ ğŸ“š");
}

// --- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ---
async function loadComments(){
  const {data,error}=await supabase.from("comments").select("*").eq("manga_id",mangaId).order("created_at",{ascending:false});
  if(error) return console.error(error);
  const list=document.getElementById("commentsList"); list.innerHTML="";
  data.forEach(c=>{
    const div=document.createElement("div"); div.className="comment";
    div.innerHTML=`<strong>${c.username}</strong>: ${c.content}`;
    list.appendChild(div);
  });
}
async function addComment(){
  const input=document.getElementById("commentInput");
  if(!input.value.trim()) return;
  await supabase.from("comments").insert({manga_id:mangaId,username=userId,content:input.value.trim()});
  input.value=""; loadComments();
}

// --- Ø§Ù„ÙØµÙˆÙ„ ---
let chapters=[];
async function loadChapters(){
  const {data,error}=await supabase.from("chapters").select("*").eq("manga_id",mangaId).order("chapter_number",{ascending:true});
  if(error) return console.error(error);
  chapters=data; renderChapters(chapters);
}
function renderChapters(list){
  const container=document.getElementById("chaptersList");
  container.innerHTML="";
  list.forEach(ch=>{
    const div=document.createElement("div"); div.className="chapter-item";
    div.textContent=`${ch.chapter_number} - ${ch.title}`;
    div.onclick=()=>window.location.href=`index9.html?manga_id=${mangaId}&chapter_id=${ch.id}`;
    container.appendChild(div);
  });
}
function filterChapters(){
  const val=document.getElementById("chapterSearch").value.toLowerCase();
  renderChapters(chapters.filter(c=>`${c.chapter_number} ${c.title}`.toLowerCase().includes(val)));
}

loadManga();
</script>
</body>
</html>
