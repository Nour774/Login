<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة التحكم المهيبة</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: linear-gradient(135deg,#1a1a2e,#0f0f1a); color:#e0e0e0; font-family:"Tahoma",sans-serif; }
  .container{margin-top:40px}
  h2{ text-align:center;color:#f97316;margin-bottom:20px;font-weight:700;letter-spacing:1px;text-shadow:1px 1px 5px #000}
  table{ background:#2b2b3d;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,.5) }
  th{ background:linear-gradient(90deg,#11121a,#1b1b2f); color:#f97316; font-weight:700 }
  td{ vertical-align:middle; font-size:13px }
  .btn-action{ margin:3px; font-size:12px; border-radius:6px; font-weight:700; padding:6px 8px }
  .block{ background:#dc2626;color:#fff;border:none }
  .unblock{ background:#16a34a;color:#fff;border:none }
  .promote{ background:#f97316;color:#fff;border:none }
  .demote{ background:#2563eb;color:#fff;border:none }
  .delete{ background:#4b5563;color:#fff;border:none }
  .ban{ background:#7c2d12;color:#fff;border:none }
  .status-box{ text-align:center;padding:10px;border-radius:6px;margin-bottom:15px;font-weight:700;text-shadow:1px 1px 3px #000 }
  .status-info{ background:#27273d;color:#cbd5e1 }
  .status-error{ background:#7f1d1d;color:#fee2e2 }
  .muted-badge{ background:#11121a;color:#f97316;padding:4px 8px;border-radius:6px;font-weight:700 }
  @media (max-width:700px){ td, th{font-size:12px} .btn-action{font-size:11px;padding:5px 6px} }
</style>
</head>
<body>
<div class="container">
  <h2>لوحة التحكم المهيبة</h2>
  <div id="statusBox" class="status-box status-info">جارٍ تحميل المستخدمين...</div>

  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle">
      <thead>
        <tr><th>ID</th><th>الاسم</th><th>البريد</th><th>الحالة</th><th>الدور</th><th>الإجراءات</th></tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>
</div>

<script>
/*
  نسخة HTML جاهزة للعمل مع السكربت:
  - رابط السكربت (SCRIPT_URL) تم تزويده من طرفك.
  - CURRENT_ROLE: عيّنه "owner" أو "admin" حسب دور المستخدم الذي يستخدم اللوحة.
  - secret يجب أن يطابق ADMIN_SECRET في السكربت.
*/
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxb2Fe2mSZJ_OTS2vzjSYeVpqlHWZjyz222dGyXqJ6Bgu0cMy1qFOEeUFPxrY4Fz8iV/exec";
const ADMIN_SECRET = "mySecret123";
const CURRENT_ROLE = "owner"; // غيّره عند الحاجة: "owner" أو "admin"

const statusBox = document.getElementById("statusBox");
const tbody = document.getElementById("usersTable");

function setStatus(msg, isError=false){
  statusBox.textContent = msg;
  statusBox.className = "status-box " + (isError ? "status-error" : "status-info");
}

async function fetchUsers(){
  setStatus("جارٍ تحميل البيانات...");
  try{
    const url = `${SCRIPT_URL}?secret=${encodeURIComponent(ADMIN_SECRET)}&action=list_users&currentRole=${encodeURIComponent(CURRENT_ROLE)}`;
    const res = await fetch(url, { method: "GET", mode: "cors" });
    const data = await res.json();
    if(data.error) throw new Error(data.error || "خطأ غير معروف من السيرفر");

    renderUsers(data.users || []);
    setStatus("تم تحميل المستخدمين بنجاح.");
  } catch (err){
    console.error("fetchUsers error:", err);
    setStatus("فشل جلب البيانات: " + (err.message || err), true);
  }
}

function renderUsers(users){
  tbody.innerHTML = "";
  if(!users || users.length === 0){
    tbody.innerHTML = `<tr><td colspan="6">لا توجد بيانات.</td></tr>`;
    return;
  }

  users.forEach(user=>{
    const id = user.id ?? "-";
    const username = user.username ?? "";
    const email = user.email ?? "-";
    const status = user.status ?? "-";
    const role = (user.role || "user").toString().toLowerCase();

    // عرض الاسم أو إيموجي الأونر
    const displayName = role === "owner" ? "👑" : (username || "-");

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(id)}</td>
      <td>${escapeHtml(displayName)}</td>
      <td>${escapeHtml(email)}</td>
      <td>${escapeHtml(status)}</td>
      <td>${escapeHtml(role)}</td>
      <td></td>
    `;
    const actionsCell = tr.querySelector("td:last-child");

    // منطق الصلاحيات:
    // - لا تُعرض أزرار لأي صف دوره owner (لا تتصرف على مالكين)
    // - admin يمكنه فقط تعديل المستخدمين العاديين (user)
    // - owner يمكنه تعديل الكل ما عدا مالكين آخرين (أي الصفوف اللي role === "owner" لن تُعرض أزرار)
    const current = (CURRENT_ROLE || "admin").toLowerCase();
    const targetRole = role;

    const ownerRow = targetRole === "owner";
    const adminRow = targetRole === "admin";

    const canEdit = (current === "owner" && !ownerRow) || (current === "admin" && !adminRow && !ownerRow && targetRole === "user");

    if(!canEdit){
      // عرض بادج مختصر يوضح السبب (أونر/مسؤول) أو علامة ناقصة
      const badge = document.createElement("span");
      badge.className = "muted-badge";
      badge.textContent = ownerRow ? "أونر" : (adminRow ? "مسؤول" : "-");
      actionsCell.appendChild(badge);
    } else {
      // إنشاء الأزرار المتوافقة مع الاسكربت (action names)
      const btn = (label, cls, action) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = `btn-action ${cls}`;
        b.textContent = label;
        b.onclick = async () => {
          const ok = confirm(`هل أنت متأكد من ${label} للمستخدم (${id})؟`);
          if(!ok) return;
          b.disabled = true;
          b.classList.add("opacity-50");
          try {
            await adminAction(action, id);
          } finally {
            b.disabled = false;
            b.classList.remove("opacity-50");
          }
        };
        return b;
      };

      actionsCell.appendChild(btn("حظر","block","block"));
      actionsCell.appendChild(btn("رفع الحظر","unblock","unblock"));
      actionsCell.appendChild(btn("ترقية","promote","promote"));
      actionsCell.appendChild(btn("تخفيض","demote","demote"));
      actionsCell.appendChild(btn("حظر نهائي","ban","ban"));
      actionsCell.appendChild(btn("حذف الحساب","delete","delete_account"));
    }

    tbody.appendChild(tr);
  });
}

async function adminAction(action, userId){
  setStatus(`جارٍ تنفيذ ${action} على ${userId}...`);
  try{
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        secret: ADMIN_SECRET,
        action: action,
        userId: userId,
        currentRole: CURRENT_ROLE
      })
    });
    const data = await res.json();
    if(data.error){
      // رسالة مفهومة من السيرفر
      throw new Error(data.error + (data.details ? " — " + JSON.stringify(data.details) : ""));
    }
    alert(data.result || "تم التنفيذ بنجاح");
    await fetchUsers();
  } catch (err){
    console.error("adminAction error:", err);
    alert("فشل الإجراء: " + (err.message || err));
    setStatus("فشل الإجراء: " + (err.message || err), true);
  }
}

// بسيط وآمن: هروب محتوى لمنع XSS من البيانات القادمة من API
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'", "&#039;");
}

// بداية التشغيل
fetchUsers();
</script>
</body>
</html>
