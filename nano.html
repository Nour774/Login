<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>قارئ المانجا الغامض</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    #content {
      width: 100%;
      max-width: 800px;
      padding: 10px;
    }
    .manga-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 10px 0;
      background: #1a1a1a;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.2s;
    }
    .manga-item:hover { background: #2a2a2a; }
    .manga-cover {
      width: 80px;
      height: 120px;
      object-fit: cover;
      margin-left: 10px;
      border-radius: 8px;
    }
    .chapter-item {
      padding: 8px;
      margin: 5px 0;
      background: #222;
      border-left: 3px solid #c00;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.2s;
    }
    .chapter-item:hover { background: #333; }
    .back-btn {
      padding: 6px 12px;
      margin: 4px;
      background: #c00;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .back-btn:hover { background: #e00; }
    img.manga-page {
      width: 100%;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 0 20px #c00;
    }
    button.sort-btn {
      background: #550000;
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    button.sort-btn:hover { background: #880000; }
  </style>
</head>
<body>
  <div id="content"></div>

  <script>
    const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentManga = null;
    let currentChapters = [];
    let sortAscending = true;
    const content = document.getElementById('content');

    // تحميل قائمة المانجا
    async function loadMangaList() {
      const { data, error } = await supabase
        .from('manga_list')
        .select('id, title, cover_url')
        .order('id', { ascending: true });
      if (error) return console.error(error);

      content.innerHTML = '';
      data.forEach(manga => {
        const div = document.createElement('div');
        div.className = 'manga-item';
        div.innerHTML = `<img src="${manga.cover_url || ''}" class="manga-cover"><h3>${manga.title}</h3>`;
        div.onclick = () => loadChapters(manga);
        content.appendChild(div);
      });
    }

    // تحميل فصول مانجا
    async function loadChapters(manga) {
      currentManga = manga;
      const { data, error } = await supabase
        .from('chapters')
        .select('id, title, number')
        .eq('manga_id', manga.id)
        .order('number', { ascending: true });
      if (error) return console.error(error);

      currentChapters = data || [];
      renderChapterList();
    }

    // عرض قائمة الفصول
    function renderChapterList() {
      const chapters = sortAscending ? currentChapters : [...currentChapters].reverse();
      content.innerHTML = `
        <button class="back-btn" onclick="loadMangaList()">الرجوع</button>
        <h2>${currentManga.title}</h2>
        <button class="sort-btn" onclick="toggleSortOrder()">الترتيب: ${sortAscending ? 'من 1 إلى 5' : 'من 5 إلى 1'}</button>
      `;
      chapters.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'chapter-item';
        div.textContent = `الفصل ${ch.number} - ${ch.title || ''}`;
        div.onclick = () => loadChapterPages(ch.id);
        content.appendChild(div);
      });
    }

    function toggleSortOrder() {
      sortAscending = !sortAscending;
      renderChapterList();
    }

    // تحميل صور الفصل والمترجمين والفرق
    async function loadChapterPages(chapter_id) {
      const { data: pages, error } = await supabase
        .from('pages')
        .select('page_number, image_url')
        .eq('chapter_id', chapter_id)
        .order('page_number', { ascending: true });
      if (error) return console.error(error);

      content.innerHTML = `<button class="back-btn" onclick="renderChapterList()">العودة للفصول</button>`;
      (pages || []).forEach(p => {
        const img = document.createElement('img');
        img.src = p.image_url;
        img.className = 'manga-page';
        content.appendChild(img);
      });

      // المترجمين
      const { data: translators } = await supabase
        .from('chapter_translators')
        .select('translator_id')
        .eq('chapter_id', chapter_id);

      const translatorIds = translators?.map(t => t.translator_id) || [];
      const { data: translatorData } = await supabase
        .from('translators')
        .select('name')
        .in('id', translatorIds);

      // الفرق
      const { data: teams } = await supabase
        .from('chapter_teams')
        .select('team_id')
        .eq('chapter_id', chapter_id);
      const teamIds = teams?.map(t => t.team_id) || [];
      const { data: teamData } = await supabase
        .from('teams')
        .select('name')
        .in('id', teamIds);

      const div = document.createElement('div');
      div.style = "margin-top:10px;font-weight:bold;color:#c00;";
      div.textContent = 'الترجمة: ' +
        (translatorData?.map(t => t.name).join(', ') || 'غير معروف') +
        (teamData?.length ? ' | ' + teamData.map(t => t.name).join(', ') : '');
      content.appendChild(div);
    }

    loadMangaList();
  </script>
</body>
</html>
