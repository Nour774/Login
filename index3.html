<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إعداد الحساب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { font-family:"Tahoma",sans-serif; background: linear-gradient(135deg,#6a0572,#b5173a); margin:0; display:flex; align-items:center; justify-content:center; height:100vh; color:#fff; text-align:center; }
    .container { background: rgba(0,0,0,0.5); padding:30px; border-radius:15px; width:350px; box-shadow:0 4px 25px rgba(0,0,0,0.4); }
    h2 { margin-bottom:20px; }
    input { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:none; font-size:14px; }
    button { width:100%; padding:12px; margin-top:10px; border-radius:8px; border:none; font-size:16px; font-weight:700; cursor:pointer; background: linear-gradient(135deg,#b5173a,#6a0572); color:#fff; transition:0.2s; }
    button:hover { opacity:0.95; transform: translateY(-1px); }
    .avatar-preview { width:80px; height:80px; border-radius:50%; object-fit:cover; margin:10px auto; display:none; }
    #welcomeMessage { margin-top:15px; font-size:16px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>إعداد حسابك</h2>
    <input type="text" id="username" placeholder="اسم المستخدم">
    <input type="file" id="avatar" accept="image/*">
    <img id="preview" class="avatar-preview" alt="Avatar Preview">
    <button id="confirmBtn" type="button" onclick="saveProfile()">تأكيد</button>
    <button id="skipBtn" type="button" style="display:none;" onclick="skip()">تخطي</button>
    <p id="welcomeMessage"></p>
  </div>

  <script>
    const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const usernameInput = document.getElementById("username");
    const avatarInput = document.getElementById("avatar");
    const preview = document.getElementById("preview");
    const skipBtn = document.getElementById("skipBtn");
    const welcomeMessage = document.getElementById("welcomeMessage");

    avatarInput.addEventListener("change", () => {
      const file = avatarInput.files[0];
      if (!file) { preview.style.display = "none"; preview.src = ""; return; }
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.style.display = "block"; };
      reader.readAsDataURL(file);
    });

    async function loadProfile() {
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr || !user) { window.location.href="index.html"; return; }

      const { data: profile } = await supabase
        .from("profiles")
        .select("username, avatar_url")
        .eq("id", user.id)
        .single();

      if (profile && profile.username) {
        usernameInput.value = profile.username;
        skipBtn.style.display = "inline-block";
      } else {
        skipBtn.style.display = "none";
      }

      if (profile && profile.avatar_url) {
        preview.src = profile.avatar_url;
        preview.style.display = "block";
      }
    }

    async function saveProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { window.location.href="index.html"; return; }

      const username = usernameInput.value.trim();
      if (!username) { alert("⚠️ اسم المستخدم إجباري."); return; }

      let avatarUrl = null;
      const file = avatarInput.files[0];
      if (file) {
        const fileName = `${user.id}/${Date.now()}_${file.name}`;
        const { error: uploadErr } = await supabase.storage.from("avatars").upload(fileName, file, { upsert: true });
        if (uploadErr) { alert("⚠️ فشل رفع الصورة: " + uploadErr.message); return; }
        const { data } = supabase.storage.from("avatars").getPublicUrl(fileName);
        avatarUrl = data.publicUrl;
      }

      const updates = { id: user.id, username };
      if (avatarUrl) updates.avatar_url = avatarUrl;

      const { error } = await supabase.from("profiles").upsert([updates], { onConflict: "id" });
      if (error) { alert("⚠️ فشل الحفظ: " + error.message); return; }

      // ✅ عرض رسالة ترحيب ثم الانتقال
      welcomeMessage.textContent = `مرحباً بك، ${username} 🎉`;
      welcomeMessage.style.display = "block";

      setTimeout(() => {
        window.location.href = "index5.html";
      }, 2000); // الانتظار ثانيتين
    }

    function skip() {
      window.location.href = "index5.html";
    }

    loadProfile();
  </script>
</body>
</html>
