<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>المكتبة — عرض مانجا</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="images/book.png"/>
  <style>
    /* --- نسقك الأصلي محافظ عليه --- */
    * { box-sizing: border-box; transition: 0.3s ease; }
    body { margin: 0; font-family: "Cairo", "Tahoma", sans-serif; background: #1a1a1d; color: #f5f5f5; overflow-x: hidden; }
    header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: #0f0e14; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .menu-btn { cursor: pointer; font-size: 24px; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; }
    .sub-header { display: flex; gap: 16px; padding: 10px 20px; background: #2a2a2d; }
    .sub-header a { color: #f5f5f5; text-decoration: none; font-weight: bold; cursor: pointer; }
    .hero img { width: 100%; max-height: 300px; object-fit: cover; }
    .content { padding: 20px; }
    .sidebar { position: fixed; top: 0; right: -250px; width: 250px; height: 100%; background: #333; padding: 20px; transition: right 0.3s ease; z-index: 1000; }
    .sidebar.active { right: 0; }
    .sidebar a, .sidebar button { display: block; margin-bottom: 10px; color: #fff; background: none; border: none; font-size: 16px; cursor: pointer; text-align: right; }
    .overlay { position: fixed; top: 0; right: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 999; }
    .overlay.active { display: block; }
    .section { display: none; padding: 20px; }
    .section.active { display: block; }
    .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .logo div:first-child { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #a88bff, #e6c07b); display: flex; align-items: center; justify-content: center; font-weight: 900; color: #0b0710; font-size: 18px; }
    .logo .title { font-weight: 700; font-size: 18px; }
    nav { display: flex; gap: 16px; margin-bottom: 10px; }
    nav button { padding: 6px 12px; border: none; border-radius: 8px; background: transparent; color: #9b8fb3; cursor: pointer; font-weight: 700; }
    nav button.active { color: #fff; background: rgba(168,139,255,0.12); }
    .panel { display: none; }
    .panel.active { display: block; }
    .hint { margin-top: 12px; color: #9b8fb3; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 14px; margin-top: 18px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12)); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; gap: 8px; align-items: stretch; }
    .ext-card { display:flex; gap:10px; align-items:flex-start; cursor:pointer; }
    .ext-thumb { width:72px; height:100px; border-radius:8px; object-fit:cover; flex-shrink:0; background:#111; border:1px solid rgba(255,255,255,0.03) }
    .ext-body { flex:1; display:flex; flex-direction:column; gap:6px }
    .ext-title { font-weight:800; font-size:15px }
    .ext-meta { color:#9b8fb3; font-size:13px }
    .btn { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:#7b5cff; color:#fff; font-weight:700 }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.05); color:#fff }
    .small { font-size:13px; color:#9b8fb3 }
    .muted { color:#9b8fb3 }
    .repo-tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .repo-tab { padding:6px 10px; border-radius:8px; cursor:pointer; background:transparent; color:#9b8fb3; font-weight:700 }
    .repo-tab.active { background:rgba(168,139,255,0.08); color:#fff }
    @media (max-width:700px){ .ext-thumb{width:60px;height:84px} .grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
  </style>
</head>
<body>
  <header>
    <span class="menu-btn" onclick="toggleMenu()">☰</span>
    <h1>المكتبة</h1>
    <img id="profileImage" class="profile-pic" src="images/imag2.jpg" alt="بروفايل">
  </header>

  <div class="sub-header">
    <a href="#">الرئيسية</a>
    <a onclick="showSection('library')">مكتبتي</a>
    <a onclick="showSection('repository')">المانجا/المانهوا</a>
    <a onclick="showSection('settings')">الروايات</a>
  </div>

  <div class="hero"><img src="images/imag1.jpg" alt="صورة المقدمة"></div>

  <div id="library" class="section active">
    <div class="content">
      <div id="welcome" class="welcome">جار التحميل...</div>
    </div>
  </div>

  <div id="repository" class="section">
    <div class="logo"><div>MS</div><div class="title">Manga Sanctum</div></div>

    <div class="repo-tabs" id="repoTabs"></div>

    <nav>
      <button id="tabSources" class="active" onclick="switchPanel('sources')">المصادر</button>
      <button id="tabExtensions" onclick="switchPanel('extensions')">الإضافات</button>
    </nav>

    <div id="panelSources" class="panel active">
      <div class="hint">المصادر المستوردة ستظهر هنا. اضغط على "استيراد كمصدر" من أي إضافة في تبويب المستودع.</div>
      <div id="sourcesGrid" class="grid" aria-live="polite"></div>
    </div>

    <div id="panelExtensions" class="panel" style="display:none">
      <div class="hint">عرض آخر الإصدارات من الموقع العربي مباشرة. إذا فشل تحميل الصور بسبب CORS، جرب تعطيل خيار البروكسي أو استخدم سيرفر بروكسي خاص بك.</div>
      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <label class="small" style="margin-left:6px">موقع المانجا (base URL):</label>
        <input id="siteUrl" style="padding:8px;border-radius:8px;background:#0f0f12;color:#fff;border:1px solid rgba(255,255,255,0.04)" value="https://manga-leko.org" />
        <button class="btn" onclick="reloadManga()">تحميل</button>
        <button class="btn btn-ghost" onclick="toggleProxy()">بروكسي الصور: <span id="proxyState">مُستخدم</span></button>
      </div>

      <div id="extensionsContainer" style="margin-top:14px">
        <div id="extensionsGrid" class="grid"></div>
      </div>
    </div>
  </div>

  <div id="settings" class="section">
    <p>الروايات ستظهر هنا لاحقًا.</p>
  </div>

  <div class="sidebar" id="sidebar">
    <a href="#" onclick="goToMembers()">الأعضاء</a>
    <button id="adminBtn" onclick="goToAdmin()" style="display:none;">لوحة التحكم</button>
    <button onclick="logout()">تسجيل الخروج</button>
  </div>
  <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

  <script>
    /****************** إعدادات سريعة — اضبط ما تحتاج ******************/
    // افتراضي إلى موقع مانجا عربي يدعم WP REST. غيّر عند الحاجة.
    const DEFAULT_SITE = document.getElementById('siteUrl').value || 'https://manga-leko.org';
    // استخدم بروكسي AllOrigins لتحاشي CORS عند تحميل صور الغلاف على GitHub Pages.
    // ملاحظة: AllOrigins قد يكون بطيئًا أو يقيد الاستخدام. يمكنك تعطيله أو استبداله بسيرفرك.
    let USE_PROXY_FOR_IMAGES = true;
    const IMAGE_PROXY = url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

    /****************** دوال واجهة عامة (كما في النسخة الأصلية) ******************/
    function toggleMenu() { document.getElementById("sidebar").classList.toggle("active"); document.getElementById("overlay").classList.toggle("active"); }
    function logout(){ alert('تسجيل الخروج (محاكاة)'); location.href = '#'; }
    function goToMembers(){ location.href='#'; }
    function goToAdmin(){ location.href='#'; }
    function showSection(id){ document.querySelectorAll('.section').forEach(sec=>sec.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id==='repository') { switchPanel('extensions'); } }

    function switchPanel(name){
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      if(name==='extensions'){ document.getElementById('panelExtensions').classList.add('active'); document.getElementById('tabExtensions').classList.add('active'); document.getElementById('tabSources').classList.remove('active'); }
      else { document.getElementById('panelSources').classList.add('active'); document.getElementById('tabSources').classList.add('active'); document.getElementById('tabExtensions').classList.remove('active'); }
    }

    function setDetails(msg){
      const el = document.getElementById('welcome');
      if(el) el.textContent = msg;
    }

    /****************** أدوات مساعدة صغيرة (متوافقة مع كودك الأصلي) ******************/
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function shorten(t, n=140){ return t && t.length>n ? t.slice(0,n)+'…' : t||''; }
    function placeholderThumb(title){ return 'images/imag1.jpg'; } // غلاف افتراضي داخل المشروع

    /****************** قائمة المصادر المحلية (محاكى) ******************/
    const state = { repos: [], currentRepoIndex: null, sources: [] };

    function renderSourcesGrid(){
      const grid = document.getElementById('sourcesGrid'); grid.innerHTML = '';
      if(state.sources.length===0){ grid.innerHTML = '<div class="muted">لم تقم باستيراد أي مصدر بعد.</div>'; return; }
      state.sources.forEach((s, idx) => {
        const d = document.createElement('div'); d.className='card';
        d.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">${escapeHtml(s.name)}</div>
              <div class="small muted" style="margin-top:6px">${escapeHtml(s.url)}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn" onclick="openSource(${idx})">افتح المصدر</button>
              <button class="btn" style="background:#c94a4a" onclick="removeSource(${idx})">حذف</button>
            </div>
          </div>
        `;
        grid.appendChild(d);
      });
    }

    function openSource(idx){ alert('فتح المصدر (محاكاة)'); }
    function removeSource(i){ state.sources.splice(i,1); renderSourcesGrid(); }

    /****************** دوال عرض المانجا (من WP JSON) ******************/
    async function loadFromMangalek(baseUrl = DEFAULT_SITE, perPage = 24) {
      setDetails && setDetails('جاري جلب مانجا من ' + baseUrl + ' ...');
      try {
        const root = baseUrl.replace(/\/+$/,'');
        const postsUrl = `${root}/wp-json/wp/v2/posts?per_page=${perPage}&_fields=id,title,excerpt,featured_media,link`;
        const res = await fetch(postsUrl);
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const posts = await res.json();
        // إحصل على وسائط الغلاف
        const mediaIds = [...new Set(posts.map(p => p.featured_media).filter(Boolean))];
        const mediaMap = {};
        if(mediaIds.length){
          await Promise.all(mediaIds.map(async id => {
            try {
              const r = await fetch(`${root}/wp-json/wp/v2/media/${id}`);
              if(!r.ok) return;
              const j = await r.json();
              mediaMap[id] = j.source_url || (j.media_details && j.media_details.sizes && j.media_details.sizes.full && j.media_details.sizes.full.source_url) || '';
            } catch(e){}
          }));
        }
        const mangas = posts.map(p => {
          const title = (p.title && (p.title.rendered || p.title)) || 'مانجا';
          const desc = (p.excerpt && (p.excerpt.rendered || p.excerpt)) || '';
          const brief = desc.replace(/<[^>]+>/g,'').trim();
          const cover = p.featured_media ? (mediaMap[p.featured_media] || '') : '';
          const coverUrl = cover ? (USE_PROXY_FOR_IMAGES ? IMAGE_PROXY(cover) : cover) : placeholderThumb(title);
          return {
            id: p.id,
            title: title.replace(/&amp;/g,'&'),
            description: brief,
            lang: 'ar',
            cover: coverUrl,
            detailUrl: p.link || `${root}/?p=${p.id}`
          };
        });

        renderMangaGrid(mangas);
        setDetails && setDetails(`تم جلب ${mangas.length} عنوان من ${baseUrl}`);
      } catch (err) {
        console.error(err);
        alert('فشل جلب بيانات من موقع المانجا: ' + err.message + '\nجرب تشغيل الصفحة عبر سيرفر محلي أو تعطيل خيار البروكسي إن فشل AllOrigins.');
        setDetails && setDetails('فشل جلب المانجا: ' + err.message);
        document.getElementById('extensionsGrid').innerHTML = `<div class="muted">فشل جلب المانجا — ${escapeHtml(err.message)}</div>`;
      }
    }

    function renderMangaGrid(items){
      const panel = document.getElementById('extensionsGrid');
      panel.innerHTML = '';
      if(!items || items.length===0){ panel.innerHTML = '<div class="muted">لم أجد مانجا.</div>'; return; }
      items.forEach(m => {
        const card = document.createElement('div'); card.className='card';
        // نستخدم عناصر آمنة بدل تمرير علامات HTML حرة
        const coverSafe = escapeHtml(m.cover);
        const titleSafe = escapeHtml(m.title);
        const descSafe = escapeHtml(shorten(m.description || 'لا وصف متاح'));
        const detailSafe = escapeHtml(m.detailUrl);
        card.innerHTML = `
          <div class="ext-card">
            <img class="ext-thumb" src="${coverSafe}" onerror="this.src='${placeholderThumb(m.title)}'"/>
            <div class="ext-body">
              <div style="display:flex;justify-content:space-between;align-items:flex-start">
                <div>
                  <div class="ext-title">${titleSafe}</div>
                  <div class="ext-meta">${escapeHtml(m.lang||'')}</div>
                </div>
                <div style="text-align:left">
                  <button class="btn" onclick="window.open('${detailSafe}', '_blank')">افتح المصدر</button>
                </div>
              </div>
              <div class="small muted" style="margin-top:6px">${descSafe}</div>
              <div style="margin-top:8px" class="small muted">رابط: ${detailSafe}</div>
            </div>
          </div>
        `;
        panel.appendChild(card);
      });
    }

    /****************** وظائف تحكم بسيطة ******************/
    function reloadManga(){ const url = document.getElementById('siteUrl').value.trim() || DEFAULT_SITE; loadFromMangalek(url, 30); }
    function toggleProxy(){ USE_PROXY_FOR_IMAGES = !USE_PROXY_FOR_IMAGES; document.getElementById('proxyState').textContent = USE_PROXY_FOR_IMAGES ? 'مُستخدم' : 'متوقف'; }

    /****************** تشغيل أولي عند التحميل ******************/
    document.addEventListener('DOMContentLoaded', ()=> {
      // اجعل الواجهة تظهر كما في النسخة الأصلية
      renderRepoTabs();
      renderSourcesGrid();
      // افتح تلقائيا تبويب المانجا وحمّل من الإعداد الافتراضي
      showSection('repository');
      switchPanel('extensions');
      loadFromMangalek(document.getElementById('siteUrl').value || DEFAULT_SITE, 30);
    });

    /****************** عرض تبويبات مستودعات افتراضية (محاكاة الشكل فقط) ******************/
    function renderRepoTabs(){
      const tabs = document.getElementById('repoTabs'); tabs.innerHTML = '';
      const samples = [
        { name: "الموقع العربي (افتراضي)" },
        { name: "شائع" },
        { name: "مضاف يدوياً" }
      ];
      samples.forEach((r, idx)=>{
        const el = document.createElement('button'); el.className = 'repo-tab' + (idx===0 ? ' active' : ''); el.textContent = r.name || `repo ${idx+1}`;
        el.onclick = ()=> { document.querySelectorAll('.repo-tab').forEach(b=>b.classList.remove('active')); el.classList.add('active'); if(idx===0) reloadManga(); };
        tabs.appendChild(el);
      });
    }
  </script>
</body>
</html>
