<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>القارئ المقدّس للمانجا</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');

    :root {
      --bg: #0b0b0d;
      --panel: #141416;
      --accent: #b00;
      --accent-glow: #e33;
      --text: #eee;
      --muted: #999;
    }

    * {
      box-sizing: border-box;
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: 'Cairo', sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    #content {
      width: 100%;
      max-width: 900px;
      padding: 14px;
    }

    h2 {
      color: var(--accent);
      margin-top: 0;
      text-shadow: 0 0 12px var(--accent-glow);
    }

    /* المانجا */
    .manga-item {
      display: flex;
      align-items: center;
      background: var(--panel);
      padding: 12px;
      margin: 10px 0;
      border-radius: 14px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.4);
    }
    .manga-item:hover { background: #1c1c20; transform: translateY(-2px); }
    .manga-cover {
      width: 90px;
      height: 130px;
      object-fit: cover;
      margin-left: 12px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }

    /* الفصول */
    .chapter-item {
      padding: 10px;
      margin: 8px 0;
      background: #1a1a1c;
      border-right: 4px solid var(--accent);
      border-radius: 8px;
      cursor: pointer;
      transition: 0.25s;
    }
    .chapter-item:hover { background: #222226; transform: translateX(-3px); }

    /* الصفحات */
    img.manga-page {
      width: 100%;
      border-radius: 10px;
      margin: 14px 0;
      box-shadow: 0 0 25px var(--accent);
    }

    /* أزرار التحكم */
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 6px;
      font-weight: bold;
      transition: 0.25s;
    }
    .btn:hover { background: var(--accent-glow); }

    .nav-btns {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 12px 0;
    }

    /* ترتيب المقدس */
    .footer-text {
      text-align: center;
      color: var(--muted);
      margin-top: 30px;
      font-size: 0.85rem;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding-top: 10px;
    }

    /* متجاوب */
    @media (max-width: 600px) {
      .manga-item { flex-direction: column; text-align: center; }
      .manga-cover { margin: 0 0 8px 0; }
    }
  </style>
</head>
<body>
  <div id="content"></div>

  <script>
    const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const content = document.getElementById('content');
    let currentManga = null;
    let chapters = [];
    let currentIndex = 0;
    let currentPages = [];

    // تحميل المانجا
    async function loadMangaList() {
      const { data, error } = await supabase
        .from('manga_list')
        .select('id,title,cover_url')
        .order('id', { ascending: true });
      if (error) return console.error(error);

      content.innerHTML = `<h2>مكتبة المانجا المقدّسة</h2>`;
      data.forEach(m => {
        const div = document.createElement('div');
        div.className = 'manga-item';
        div.innerHTML = `<img src="${m.cover_url}" class="manga-cover"><div><h3>${m.title}</h3></div>`;
        div.onclick = () => loadChapters(m);
        content.appendChild(div);
      });
    }

    // تحميل الفصول
    async function loadChapters(manga) {
      currentManga = manga;
      const { data, error } = await supabase
        .from('chapters')
        .select('id,title,number')
        .eq('manga_id', manga.id)
        .order('number', { ascending: true });
      if (error) return console.error(error);

      chapters = data || [];
      content.innerHTML = `
        <button class="btn" onclick="loadMangaList()">الرجوع للمكتبة</button>
        <h2>${manga.title}</h2>
      `;
      chapters.forEach(ch => {
        const div = document.createElement('div');
        div.className = 'chapter-item';
        div.textContent = 'الفصل ' + ch.number + ' — ' + (ch.title || '');
        div.onclick = () => loadChapterPages(ch.id);
        content.appendChild(div);
      });
    }

    // تحميل الصفحات
    async function loadChapterPages(chapterId) {
      const { data: pages, error } = await supabase
        .from('pages')
        .select('page_number,image_url')
        .eq('chapter_id', chapterId);
      if (error) return console.error(error);

      // ترتيب حسب الاسم أو الرقم بدقة (manga1.jpg → manga2.jpg ...)
      currentPages = (pages || []).sort((a, b) => {
        const getNum = s => parseInt(s.image_url.match(/(\d+)/)?.[1] || 0);
        return getNum(a.image_url) - getNum(b.image_url);
      });

      currentIndex = 0;
      renderPage();
    }

    // عرض الصفحة الحالية
    function renderPage() {
      const p = currentPages[currentIndex];
      if (!p) return;

      content.innerHTML = `
        <div class="nav-btns">
          <button class="btn" onclick="renderChapterList()">عودة للفصول</button>
          <div>${currentIndex + 1} / ${currentPages.length}</div>
        </div>
        <img src="${p.image_url}" class="manga-page" alt="صفحة ${currentIndex + 1}">
        <div class="nav-btns">
          <button class="btn" onclick="prevPage()">⬅ السابق</button>
          <button class="btn" onclick="nextPage()">التالي ➡</button>
        </div>
        <div class="footer-text">قارئ المانجا المقدّس — رحلة بين الصفحات المظلمة للنور</div>
      `;
    }

    // التنقل
    function nextPage() {
      if (currentIndex < currentPages.length - 1) {
        currentIndex++;
        renderPage();
      } else {
        alert('✨ وصلت إلى نهاية الفصل.');
      }
    }
    function prevPage() {
      if (currentIndex > 0) {
        currentIndex--;
        renderPage();
      } else {
        alert('📜 هذه أول صفحة.');
      }
    }

    // إعادة الفصول
    function renderChapterList() {
      loadChapters(currentManga);
    }

    // بدء التشغيل
    loadMangaList();
  </script>
</body>
</html>
