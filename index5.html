<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family:"Tahoma",sans-serif; background: linear-gradient(135deg,#6a0572,#b5173a); display:flex; justify-content:center; align-items:center; height:100vh; margin:0; color:white; }
    .container { background: rgba(0,0,0,0.4); padding:30px; border-radius:15px; width:350px; text-align:center; }
    button { width:100%; padding:12px; margin-top:12px; border-radius:8px; border:none; font-weight:bold; background: linear-gradient(135deg,#b5173a,#6a0572); color:white; cursor:pointer; transition:0.3s; }
    button:hover { opacity:0.9; transform:scale(1.02); }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="welcome">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    <button onclick="goToMembers()">Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù†Ø§Ø¯ÙŠ</button>
    <button id="adminBtn" style="display:none;" onclick="goToAdmin()">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
  </div>

  <script>
    const supabaseUrl = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function loadUser(){
      try {
        const { data: { user }, error } = await supabase.auth.getUser();
        if(error || !user){
          console.log("No user session, redirecting...");
          window.location.href = "index.html";
          return;
        }

        const { data: profile, error: profileErr } = await supabase
          .from("profiles")
          .select("username, role")
          .eq("id", user.id)
          .single();

        if(profileErr && profileErr.code !== "PGRST116"){
          alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„: " + profileErr.message);
          return;
        }

        console.log("Profile fetched:", profile);

        const username = profile?.username || "Ù…Ø³ØªØ®Ø¯Ù…";
        document.getElementById("welcome").textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${username} ğŸ‘‹`;

        // ØªØ­Ù‚Ù‚ Ù…Ù† role ÙˆØ§Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† admin
        const role = profile?.role?.toLowerCase() || "";
        if(role === "admin"){
          document.getElementById("adminBtn").style.display = "block";
          console.log("User is admin, button shown.");
        } else {
          document.getElementById("adminBtn").style.display = "none";
          console.log("User is not admin.");
        }

      } catch(err){
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: " + (err.message || err));
      }
    }

    async function logout(){
      try { await supabase.auth.signOut(); } catch(err){ console.warn(err); }
      window.location.href = "index.html";
    }

    function goToMembers(){ window.location.href = "index3.html"; }
    function goToAdmin(){ window.location.href = "index6.html"; }

    loadUser();
  </script>
</body>
</html>
