<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;
let currentUserRole = "";

// ✅ الحصول على UUID من الجلسة والتحقق من الدور
async function init() {
    const { data: { session }, error } = await supabase.auth.getSession();
    if(error || !session) {
        alert("لم يتم تسجيل الدخول. إعادة التوجيه...");
        window.location.href = "index5.html";
        return;
    }
    currentUserId = session.user.id;

    const { data: profile, error: profileErr } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', currentUserId)
        .single();

    if(profileErr || !profile) {
        alert("لم يتم العثور على المستخدم. إعادة التوجيه...");
        window.location.href = "index5.html";
        return;
    }

    currentUserRole = (profile.role || "user").toLowerCase();

    // طرد المستخدم العادي فقط
    if(currentUserRole === "user") {
        alert("ليس لديك صلاحية الدخول!");
        window.location.href = "index5.html";
        return;
    }

    fetchAndRenderUsers();
}

// ✅ جلب وعرض المستخدمين
async function fetchAndRenderUsers() {
    const { data: users, error } = await supabase
        .from('profiles')
        .select('*')
        .order('username');

    if(error || !users) { console.error(error); return; }

    const tbody = document.querySelector("#usersTable tbody");
    tbody.innerHTML = "";
    users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(u.username || "")}${u.id===currentUserId?" ⇽ أنت":""}</td>
          <td>${escapeHtml(u.email || "")}</td>
          <td>${escapeHtml(u.status || "active")}</td>
          <td>${escapeHtml(u.role || "user")}</td>
          <td>${getActionButtons(currentUserRole,u)}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ✅ أزرار الإدارة حسب الدور
function getActionButtons(role, user){
    if(user.id === currentUserId) return `<span class="badge">أنت (${role})</span>`;
    if(role==="owner" || (role==="admin" && user.role==="user")) {
        return `
          <button class="block" onclick="adminAction('block','${user.id}')">حظر</button>
          <button class="unblock" onclick="adminAction('unblock','${user.id}')">رفع الحظر</button>
          <button class="promote" onclick="adminAction('promote','${user.id}')">ترقية</button>
          <button class="demote" onclick="adminAction('demote','${user.id}')">تخفيض</button>
          <button class="delete" onclick="adminAction('delete_account','${user.id}')">حذف</button>
        `;
    }
    return `<span class="badge">---</span>`;
}

// ✅ تنفيذ الإجراءات عبر Google Script
async function adminAction(action,userId){
    try{
        const res = await fetch(`${SCRIPT_URL}?secret=${encodeURIComponent("mySecret123")}&action=${encodeURIComponent(action)}&userId=${encodeURIComponent(userId)}`);
        const data = await res.json().catch(()=>({}));
        alert(data.error || data.message || "تم الإجراء بنجاح!");
        fetchAndRenderUsers();
    } catch(e) { console.error(e); alert("فشل الاتصال"); }
}

// ✅ تحقق دوري من الدور (طرد المستخدم العادي فورًا)
setInterval(async ()=>{
    if(!currentUserId) return;
    const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', currentUserId)
        .single();
    const role = (profile?.role || "user").toLowerCase();
    if(!["admin","owner"].includes(role)) {
        alert("تم تخفيض رتبك أو ليس لديك صلاحية!");
        window.location.href = "index5.html";
    }
}, 2000);

// البحث
const searchInput = document.getElementById("searchInput");
searchInput.addEventListener("input",()=>{
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("#usersTable tbody tr").forEach(r=>{
        r.style.display = r.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
});

function escapeHtml(text){
    return text.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]));
}

// بدء العملية
init();
</script>
