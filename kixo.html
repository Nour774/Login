<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Manga Sanctum</title>
  <link rel="icon" href="images/book.png">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; transition: 0.3s ease; }
    body {
      margin: 0;
      font-family: "Cairo", sans-serif;
      background: radial-gradient(circle at 50% 10%, #0b0b10, #050505 90%);
      color: #eaeaea;
      overflow-x: hidden;
      min-height: 100vh;
      position: relative;
    }

    /* --- Ø®Ù„ÙÙŠØ© Ø¶Ø¨Ø§Ø¨ÙŠØ© ÙˆØ±Ù…ÙˆØ² --- */
    .fog {
      position: fixed;
      top: 0; left: 0;
      width: 200%;
      height: 200%;
      background: url('images/fog.png') repeat;
      opacity: 0.15;
      animation: fogMove 120s linear infinite;
      z-index: 0;
      pointer-events: none;
      transform: translate(-25%, -25%);
    }
    @keyframes fogMove {
      0% { background-position: 0 0; }
      50% { background-position: 1000px 800px; }
      100% { background-position: 0 0; }
    }
    .symbols {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: 1;
    }
    .symbol {
      position: absolute;
      color: rgba(168,139,255,0.08);
      font-size: 22px;
      animation: floatSymbol 30s linear infinite;
      user-select: none;
    }
    @keyframes floatSymbol {
      0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
    }

    /* --- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© --- */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: rgba(10,10,15,0.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.05);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .left-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .back-btn {
      color: #eaeaea;
      font-size: 20px;
      cursor: pointer;
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
    }
    .back-btn:hover { background: rgba(255,255,255,0.12); }
    .logo-text {
      font-weight: 800;
      font-size: 26px;
      color: #d4c3ff;
      letter-spacing: 1px;
      filter: drop-shadow(0 0 10px rgba(168,139,255,0.7))
              drop-shadow(0 0 25px rgba(122,95,255,0.4));
      user-select: none;
    }
    .logo-box {
      width: 46px;
      height: 46px;
      border-radius: 10px;
      background: linear-gradient(135deg, #a88bff, #e6c07b);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      color: #0b0710;
      font-size: 21px;
      box-shadow: 0 0 10px rgba(168,139,255,0.5);
    }
    @media (max-width: 600px) {
      .logo-text { font-size: 22px; }
      .back-btn { font-size: 18px; padding: 6px 12px; }
      .logo-box { width: 36px; height: 36px; font-size: 16px; }
    }

    main {
      padding: 20px;
      text-align: center;
      position: relative;
      z-index: 5;
    }

    /* --- Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù†Ø¬Ø§ --- */
    .manga-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 20px 0 30px;
    }
    .manga-header img {
      width: 220px;
      height: 310px;
      object-fit: cover;
      border-radius: 14px;
      box-shadow: 0 0 50px rgba(168,139,255,0.4);
    }
    .manga-title {
      font-size: 30px;
      font-weight: 800;
      margin-top: 16px;
      background: linear-gradient(90deg, #a88bff, #e6c07b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .manga-description {
      max-width: 800px;
      margin-top: 10px;
      color: #bdb3d6;
      font-size: 16px;
      line-height: 1.8;
    }

    /* --- Ø§Ù„ÙˆØ³ÙˆÙ… --- */
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
      justify-content: center;
    }
    .tag {
      background: rgba(168,139,255,0.1);
      border: 1px solid rgba(168,139,255,0.3);
      color: #cbb9ff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }
    .tag:hover { background: rgba(168,139,255,0.25); color: #fff; transform: scale(1.05); }

    /* --- Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ… --- */
    .stars {
      display: inline-flex;
      flex-direction: row-reverse;
      gap: 5px;
      cursor: pointer;
      margin-top: 10px;
      justify-content: center;
    }
    .star { font-size: 30px; color: rgba(168,139,255,0.3); transition: 0.2s; }
    .star:hover, .star.active { color: #e6c07b; transform: scale(1.2); }

    /* --- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª --- */
    .tab-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .tab-buttons button {
      background: rgba(168,139,255,0.1);
      border: 1px solid rgba(168,139,255,0.3);
      color: #cbb9ff;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    .tab-buttons button.active { background: rgba(168,139,255,0.3); }

    .tab-content { display: none; margin-top: 20px; text-align: right; }
    .tab-content.active { display: block; }

    /* --- Ù…ÙƒØªØ¨Ø© ÙˆØªØ¹Ù„ÙŠÙ‚Ø§Øª --- */
    .library-btn {
      display: inline-block;
      background: rgba(168,139,255,0.2);
      color: #eaeaea;
      border: 1px solid rgba(168,139,255,0.4);
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .comment-box { margin-top: 20px; }
    .comment-box textarea {
      width: 100%;
      background: rgba(255,255,255,0.05);
      color: #fff;
      border: 1px solid rgba(168,139,255,0.3);
      border-radius: 8px;
      padding: 10px;
      resize: none;
    }
    .comment-box button {
      margin-top: 8px;
      background: rgba(168,139,255,0.2);
      color: #cbb9ff;
      border: 1px solid rgba(168,139,255,0.3);
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
    }
    .comments-list { margin-top: 15px; }
    .comment {
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* --- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØµÙˆÙ„ --- */
    .chapter-search { margin-bottom: 15px; }
    .chapter-search input {
      width: 100%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(168,139,255,0.3);
      border-radius: 8px;
      padding: 8px;
      color: #fff;
    }
    .chapters-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }
    .chapter-item {
      background: rgba(168,139,255,0.08);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }
    .chapter-item:hover { background: rgba(168,139,255,0.2); }

    footer {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 14px;
      z-index: 10;
      position: relative;
    }
  </style>
</head>

<body>
  <div class="fog"></div>
  <div class="symbols" id="symbols"></div>

  <header>
    <div class="left-section">
      <div class="back-btn" onclick="history.back()">â®Œ Ø¹ÙˆØ¯Ø©</div>
      <div class="logo-text">Manga Sanctum</div>
    </div>
    <div class="logo-box">MS</div>
  </header>

  <main>
    <div class="manga-header">
      <img id="cover" src="" alt="ØºÙ„Ø§Ù Ø§Ù„Ù…Ø§Ù†Ø¬Ø§">
      <div class="manga-title" id="title">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <p class="manga-description" id="description"></p>
      <div id="tags" class="tags"></div>
      <div id="stars" class="stars"></div>
    </div>

    <div class="tab-buttons">
      <button id="detailsBtn" class="active" onclick="switchTab('details')">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
      <button id="chaptersBtn" onclick="switchTab('chapters')">Ø§Ù„ÙØµÙˆÙ„</button>
    </div>

    <div id="details" class="tab-content active">
      <button class="library-btn" onclick="addToLibrary()">ğŸ“š Ø£Ø¶Ù Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨ØªÙŠ</button>

      <div class="comment-box">
        <textarea id="commentInput" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
        <button onclick="addComment()">Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚</button>
      </div>
      <div id="commentsList" class="comments-list"></div>
    </div>

    <div id="chapters" class="tab-content">
      <div class="chapter-search">
        <input type="text" id="chapterSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„..." oninput="filterChapters()">
      </div>
      <div id="chaptersList" class="chapters-list"></div>
    </div>
  </main>

  <footer>Â© 2025 Manga Sanctum | Realm of Shadows & Light</footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://dxpqkojigblqgwqxwbmg.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cHFrb2ppZ2JscWd3cXh3Ym1nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2OTUyMTEsImV4cCI6MjA3NDI3MTIxMX0.KVfAmSbRS1-FIEaX7C_n-GQ-MyaSGa7goKFO9wRtxkg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const mangaId = new URLSearchParams(window.location.search).get("manga_id");

    let allChapters = [];

    function getUserId() {
      let id = localStorage.getItem("user_id");
      if (!id) { id = crypto.randomUUID(); localStorage.setItem("user_id", id); }
      return id;
    }
    const userId = getUserId();

    /* --- Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© --- */
    const SYMBOLS = ["â˜½","âœ¦","âœ¶","â›§","â˜¥","â™†","å","âšš"];
    function spawnSymbols() {
      const c = document.getElementById("symbols");
      for (let i=0;i<20;i++){
        const s=document.createElement("div");
        s.className="symbol";
        s.textContent=SYMBOLS[Math.floor(Math.random()*SYMBOLS.length)];
        s.style.left=Math.random()*100+"%";
        s.style.animationDelay=Math.random()*30+"s";
        s.style.fontSize=16+Math.random()*24+"px";
        c.appendChild(s);
      }
    }

    spawnSymbols();

    async function loadManga() {
      const { data, error } = await supabase.from("manga_list").select("*").eq("id", mangaId).single();
      if (error || !data) return console.error(error);
      document.getElementById("title").textContent = data.title;
      document.getElementById("description").textContent = data.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­.";
      document.getElementById("cover").src = data.cover_url;

      // Ø§Ù„ÙˆØ³ÙˆÙ…
      const tagsContainer = document.getElementById("tags");
      tagsContainer.innerHTML = "";
      if (data.tags) data.tags.split(",").map(t=>t.trim()).filter(Boolean).forEach(tag=>{
        const el=document.createElement("div");
        el.className="tag";
        el.textContent=tag;
        el.onclick=()=>window.location.href=`index13.html?tag=${encodeURIComponent(tag)}`;
        tagsContainer.appendChild(el);
      });

      loadRating();
      loadComments();
      loadChapters();
    }

    async function loadRating() {
      const { data, error } = await supabase.from("ratings").select("*").eq("manga_id", mangaId);
      let avg = 0;
      if (data && data.length) avg = data.reduce((a,b)=>a+b.value,0)/data.length;
      const stars = document.getElementById("stars");
      stars.innerHTML="";
      for (let i=5;i>=1;i--){
        const s = document.createElement("span");
        s.className="star "+(i<=avg?"active":"");
        s.innerHTML="â˜…";
        s.onclick = ()=>rateManga(i);
        stars.appendChild(s);
      }
    }

    async function rateManga(value) {
      await supabase.from("ratings").upsert({ manga_id: mangaId, user_id: userId, value });
      loadRating();
    }

    async function addToLibrary() {
      await supabase.from("library").upsert({ manga_id: mangaId, user_id: userId });
      alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ù…ÙƒØªØ¨ØªÙŠ!");
    }

    async function addComment() {
      const txt = document.getElementById("commentInput").value.trim();
      if (!txt) return;
      await supabase.from("comments").insert({ manga_id: mangaId, user_id: userId, content: txt });
      document.getElementById("commentInput").value="";
      loadComments();
    }

    async function loadComments() {
      const { data } = await supabase.from("comments").select("*").eq("manga_id", mangaId).order("id",{ascending:false});
      const list = document.getElementById("commentsList");
      list.innerHTML="";
      if(data) data.forEach(c=>{
        const div = document.createElement("div");
        div.className="comment";
        div.textContent=c.content;
        list.appendChild(div);
      });
    }

    async function loadChapters() {
      const { data } = await supabase.from("chapters").select("*").eq("manga_id", mangaId).order("number",{ascending:true});
      allChapters = data || [];
      displayChapters(allChapters);
    }

    function displayChapters(chapters) {
      const container = document.getElementById("chaptersList");
      container.innerHTML="";
      chapters.forEach(ch=>{
        const div=document.createElement("div");
        div.className="chapter-item";
        div.textContent=`Ø§Ù„ÙØµÙ„ ${ch.number} - ${ch.title}`;
        div.onclick=()=>window.location.href=`index9.html?chapter_id=${ch.id}`;
        container.appendChild(div);
      });
    }

    function filterChapters() {
      const term = document.getElementById("chapterSearch").value.trim();
      const filtered = allChapters.filter(ch=>`${ch.number} ${ch.title}`.includes(term));
      displayChapters(filtered);
    }

    function switchTab(tab) {
      document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
      document.getElementById(tab).classList.add("active");
      document.querySelectorAll(".tab-buttons button").forEach(b=>b.classList.remove("active"));
      if(tab==="details") document.getElementById("detailsBtn").classList.add("active");
      else document.getElementById("chaptersBtn").classList.add("active");
    }

    loadManga();
  </script>
</body>
</html>
